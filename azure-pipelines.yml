# Azure DevOps CI/CD Pipeline for Shift Handover App
# Deploys to Google Cloud VM using Azure Container Registry (ACR)

trigger:
  branches:
    include:
      - main
  paths:
    exclude:
      - README.md
      - docs/*
      - "*.md"

variables:
- group: ACR-Variables       # Azure Container Registry and deployment variables
- name: imageTag
  value: '$(Build.BuildId)'
- name: fullImageName
  value: '$(acrLoginServer)/$(dockerRepository):$(imageTag)'

stages:
- stage: Build
  displayName: 'Build and Test'
  jobs:
  - job: BuildJob
    displayName: 'Build Application'
    pool:
      vmImage: 'ubuntu-latest'
    
    steps:
    - checkout: self
      fetchDepth: 1
      displayName: 'Checkout Source Code'
    
    - task: UsePythonVersion@0
      inputs:
        versionSpec: '$(pythonVersion)'
        addToPath: true
      displayName: 'Setup Python $(pythonVersion)'
    
    - script: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
      displayName: 'Install Dependencies'
    
    - script: |
        echo "ğŸ” Validating application..."
        python -c "
        try:
            import app
            print('âœ… Application imports successfully')
            print('âœ… Flask app configuration valid')
        except Exception as e:
            print(f'âŒ Application validation failed: {e}')
            exit(1)
        "
        echo "âœ… Build validation completed"
      displayName: 'Validate Application'

- stage: DockerBuild
  displayName: 'Build Docker Image'
  dependsOn: Build
  condition: succeeded()
  jobs:
  - job: DockerBuildJob
    displayName: 'Build and Push to Azure Container Registry'
    pool:
      vmImage: 'ubuntu-latest'
    
    steps:
    - checkout: self
      displayName: 'Checkout Source Code'
    
    - task: AzureCLI@2
      displayName: 'Login to Azure Container Registry'
      inputs:
        azureSubscription: 'ACRConnection'  # Service connection for ACR
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          echo "ğŸ” Logging into Azure Container Registry..."
          az acr login --name $(acrName)
          echo "âœ… Successfully logged into $(acrLoginServer)"
    
    - task: Docker@2
      displayName: 'Build Docker Image'
      inputs:
        containerRegistry: 'ACRConnection'
        repository: '$(dockerRepository)'
        command: 'build'
        Dockerfile: 'Dockerfile'
        tags: |
          $(imageTag)
          latest
        arguments: '--no-cache --pull'
    
    - task: Docker@2
      displayName: 'Push Docker Image to ACR'
      inputs:
        containerRegistry: 'ACRConnection'
        repository: '$(dockerRepository)'
        command: 'push'
        tags: |
          $(imageTag)
          latest
    
    - script: |
        echo "ğŸ³ Docker image built and pushed to Azure Container Registry:"
        echo "Registry: $(acrLoginServer)"
        echo "Repository: $(dockerRepository)"
        echo "Tags: $(imageTag), latest"
        echo "Full image name: $(fullImageName)"
      displayName: 'Docker Build Summary'

- stage: Deploy
  displayName: 'Deploy to GCP VM'
  dependsOn: DockerBuild
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
  jobs:
  - job: DeployToGCP
    displayName: 'Deploy to Google Cloud VM'
    pool:
      vmImage: 'ubuntu-latest'
    
    steps:
    - checkout: none
        
    - script: |
        echo "ğŸš€ Starting deployment to GCP VM..."
        
        # Setup SSH key
        mkdir -p ~/.ssh
        echo "$(SSH_PRIVATE_KEY)" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        echo "35.200.202.18 ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQC7ma3Vf8OlWzJGvEzj" >> ~/.ssh/known_hosts
        
        # Login to Azure Container Registry from GCP VM via SSH
        echo "ğŸ” Logging into Azure Container Registry on remote VM..."
        ssh -o StrictHostKeyChecking=no shifthandoversajid@35.200.202.18 << 'EOF'
        ssh -o StrictHostKeyChecking=no shifthandoversajid@35.200.202.18 << 'EOF'
        az acr login --name $(acrName) || {
          echo "Installing Azure CLI on VM..."
          curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
          az acr login --name $(acrName)
        }
        
        # Create application directories
        sudo mkdir -p /opt/shift-handover-data
        sudo mkdir -p /opt/shift-handover-uploads
        sudo chown -R $USER:$USER /opt/shift-handover-*
        
        # Stop and remove existing container
        echo "ğŸ›‘ Stopping existing container..."
        sudo docker stop shift-handover-app || true
        sudo docker rm shift-handover-app || true
        
        # Pull latest image from ACR
        echo "ğŸ“¥ Pulling latest Docker image from Azure Container Registry..."
        sudo docker pull $(fullImageName)
        
        # Run new container
        echo "ğŸš€ Starting new container..."
        sudo docker run -d \
          --name shift-handover-app \
          --restart unless-stopped \
          -p 80:5000 \
          -p 443:5000 \
          -e FLASK_ENV=production \
          -e SECRET_KEY="$(SECRET_KEY)" \
          -e DATABASE_URI="$(DATABASE_URI)" \
          -e SMTP_SERVER=smtp.gmail.com \
          -e SMTP_PORT=587 \
          -e SMTP_USERNAME="$(SMTP_USERNAME)" \
          -e SMTP_PASSWORD="$(SMTP_PASSWORD)" \
          -e TEAM_EMAIL="$(SMTP_USERNAME)" \
          -e SERVICENOW_INSTANCE="$(SERVICENOW_INSTANCE)" \
          -e SERVICENOW_USERNAME="$(SERVICENOW_USERNAME)" \
          -e SERVICENOW_PASSWORD="$(SERVICENOW_PASSWORD)" \
          -e SERVICENOW_ENABLED=true \
          -e SSO_ENCRYPTION_KEY="$(SSO_ENCRYPTION_KEY)" \
          -e GOOGLE_OAUTH_CLIENT_ID="$(GOOGLE_OAUTH_CLIENT_ID)" \
          -e GOOGLE_OAUTH_CLIENT_SECRET="$(GOOGLE_OAUTH_CLIENT_SECRET)" \
          -v /opt/shift-handover-data:/app/instance \
          -v /opt/shift-handover-uploads:/app/uploads \
          $(fullImageName)
        
        echo "âœ… Container started successfully"
        
        # Wait for application to initialize
        echo "â³ Waiting for application to initialize..."
        sleep 15
        
        # Check container status
        if sudo docker ps | grep -q shift-handover-app; then
          echo "âœ… Container is running"
          sudo docker ps | grep shift-handover-app
        else
          echo "âŒ Container failed to start"
          sudo docker logs shift-handover-app --tail 50
          exit 1
        fi
EOF
      displayName: 'Deploy Application to GCP VM'
          
    - script: |
        echo "ğŸ” Performing health checks..."
        
        # Health check via SSH
        ssh -o StrictHostKeyChecking=no shifthandoversajid@35.200.202.18 << 'EOF'
        ssh -o StrictHostKeyChecking=no shifthandoversajid@35.200.202.18 << 'EOF'
        echo "ğŸ” Performing health checks..."
        
        # Wait a bit more for app to be fully ready
        sleep 10
        
        # Check application response
        if curl -f --max-time 30 http://localhost/; then
          echo "âœ… Application is responding on HTTP"
        else
          echo "âš ï¸ HTTP health check failed, checking container logs..."
          sudo docker logs shift-handover-app --tail 100
        fi
        
        # Check if SSO endpoints are accessible
        if curl -f --max-time 10 http://localhost/login; then
          echo "âœ… Login page is accessible"
        else
          echo "âš ï¸ Login page check failed"
        fi
        
        # Display container information
        echo "ğŸ“Š Container status:"
        sudo docker ps --filter name=shift-handover-app --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
        
        # Display resource usage
        echo "ğŸ’¾ Resource usage:"
        sudo docker stats shift-handover-app --no-stream --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}"
        
        echo "ğŸ‰ Deployment verification completed!"
EOF
      displayName: 'Health Check and Verification'

- stage: Cleanup
  displayName: 'Post-Deployment Cleanup'
  dependsOn: Deploy
  condition: succeeded()
  jobs:
  - job: CleanupJob
    displayName: 'Cleanup Old Images'
    pool:
      vmImage: 'ubuntu-latest'
    
    steps:
    - task: SSH@0
      displayName: 'Cleanup Old Docker Images'
      inputs:
        sshEndpoint: 'GCPVMConnection'
        runOptions: 'commands'
        commands: |
          echo "ğŸ§¹ Cleaning up old Docker images..."
          
          # Remove dangling images
          sudo docker image prune -f
          
          # Remove old versions from ACR (keep last 3)
          sudo docker images $(acrLoginServer)/$(dockerRepository) --format "{{.Tag}}" | \
            grep -v "latest" | \
            tail -n +4 | \
            xargs -r -I {} sudo docker rmi $(acrLoginServer)/$(dockerRepository):{} || true
          
          # Clean up system
          sudo docker system prune -f
          
          echo "âœ… Cleanup completed"
          echo "ğŸ“‹ Remaining images:"
          sudo docker images $(acrLoginServer)/$(dockerRepository)