{% extends "base.html" %}

{% block title %}Secrets Management{% endblock %}

{% block extra_css %}
<style>
    /* Clean, professional styling matching user management system */
    .secrets-card {
        background: rgba(255, 255, 255, 0.98);
        border: none;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        border: 1px solid rgba(230, 240, 250, 0.8);
        margin-bottom: 1.5rem;
    }
    
    .secrets-card:hover {
        transform: translateY(-2px);
    }
    
    /* Statistics Cards */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }
    
    .stat-card {
        background: linear-gradient(135deg, #e3f2fd 0%, #f0f9ff 100%);
        border-radius: 10px;
        padding: 1.5rem;
        text-align: center;
        border: 1px solid #b3d9ff;
        transition: transform 0.2s ease;
    }
    
    .stat-card:hover {
        transform: translateY(-2px);
    }
    
    .stat-number {
        font-size: 2rem;
        font-weight: 700;
        color: #1976d2;
        display: block;
        margin-bottom: 0.5rem;
    }
    
    .stat-label {
        color: #5c6bc0;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 500;
    }
    
    /* Configuration Cards */
    .config-card {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        border: 1px solid rgba(230, 240, 250, 0.8);
        transition: all 0.3s ease;
        height: 100%;
    }
    
    .config-card:hover {
        box-shadow: 0 6px 25px rgba(0,0,0,0.12);
        transform: translateY(-3px);
    }
    
    .config-card-header {
        background: linear-gradient(135deg, #f8fbff 0%, #e8f4f8 100%);
        padding: 1.5rem;
        border-bottom: 1px solid rgba(230, 240, 250, 0.8);
    }
    
    .config-title {
        display: flex;
        align-items: center;
        gap: 1rem;
    }
    
    .config-icon {
        font-size: 1.5rem;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(255, 255, 255, 0.8);
        border-radius: 10px;
        flex-shrink: 0;
    }
    
    .config-card-header h5 {
        color: #2c3e50;
        font-weight: 600;
        margin: 0;
    }
    
    .config-card-header small {
        color: #6c757d;
        font-size: 0.875rem;
    }
    
    .status-badge {
        font-size: 0.75rem;
        font-weight: 600;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        letter-spacing: 0.5px;
    }
    
    .config-card-body {
        padding: 1.5rem;
    }
    
    /* Configuration Items */
    .config-items-list {
        margin-bottom: 1.5rem;
    }
    
    .config-item-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1rem 0;
        border-bottom: 1px solid #f8f9fa;
        gap: 1rem;
    }
    
    .config-item-row:last-child {
        border-bottom: none;
    }
    
    .config-field {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        flex: 1;
        min-width: 0;
    }
    
    .field-icon {
        color: #6c757d;
        width: 16px;
        flex-shrink: 0;
    }
    
    .field-info {
        min-width: 0;
        flex: 1;
    }
    
    .field-label {
        display: block;
        font-weight: 500;
        color: #2c3e50;
        font-size: 0.9rem;
        margin-bottom: 0.25rem;
    }
    
    .field-description {
        display: block;
        color: #6c757d;
        font-size: 0.8rem;
        line-height: 1.3;
    }
    
    .config-value-section {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex-shrink: 0;
    }
    
    .value-container {
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }
    
    .config-input {
        width: 200px;
        font-size: 0.875rem;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        background: #f8f9fa;
        font-family: 'Segoe UI', system-ui, sans-serif;
    }
    
    .config-input:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.15);
        background: white;
    }
    
    .toggle-btn, .edit-btn {
        border-radius: 6px;
        border: 1px solid #dee2e6;
        padding: 0.375rem 0.5rem;
        font-size: 0.875rem;
        line-height: 1;
        transition: all 0.2s ease;
    }
    
    .toggle-btn:hover, .edit-btn:hover {
        transform: translateY(-1px);
    }
    
    .edit-btn {
        background: #007bff;
        border-color: #007bff;
        color: white;
    }
    
    .edit-btn:hover {
        background: #0056b3;
        border-color: #0056b3;
    }
    
    /* Configuration Actions */
    .config-actions {
        padding-top: 1rem;
        border-top: 1px solid #f8f9fa;
        text-align: center;
    }
    
    .test-connection-btn {
        border-radius: 8px;
        padding: 0.75rem 1.5rem;
        font-weight: 500;
        text-transform: uppercase;
        font-size: 0.875rem;
        letter-spacing: 0.5px;
        transition: all 0.3s ease;
    }
    
    .test-connection-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    /* Navigation Tabs */
    .nav-tabs {
        border: none;
        background: linear-gradient(135deg, #f8fbff 0%, #e8f4f8 100%);
        border-radius: 12px 12px 0 0;
        padding: 0.5rem;
        margin-bottom: 0;
    }
    
    .nav-tabs .nav-link {
        color: #495057;
        font-weight: 500;
        border: none;
        border-radius: 8px;
        padding: 0.8rem 1.5rem;
        background: transparent;
        transition: all 0.3s ease;
        margin: 0 0.25rem;
    }
    
    .nav-tabs .nav-link:hover {
        background: rgba(25, 118, 210, 0.1);
        color: #1976d2;
        transform: translateY(-1px);
    }
    
    .nav-tabs .nav-link.active {
        background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
        color: white;
        box-shadow: 0 2px 8px rgba(25, 118, 210, 0.3);
    }
    
    .tab-content {
        background: white;
        border: 1px solid rgba(230, 240, 250, 0.8);
        border-top: none;
        border-radius: 0 0 12px 12px;
        padding: 2rem;
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
        .config-item-row {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.75rem;
        }
        
        .config-value-section {
            width: 100%;
            justify-content: space-between;
        }
        
        .config-input {
            width: 100%;
            max-width: 250px;
        }
        
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }
    
    /* Animation for page load */
    @keyframes slideInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .config-card {
        animation: slideInUp 0.5s ease forwards;
    }
    
    .config-card:nth-child(1) { animation-delay: 0.1s; }
    .config-card:nth-child(2) { animation-delay: 0.2s; }
    .config-card:nth-child(3) { animation-delay: 0.3s; }
    .config-card:nth-child(4) { animation-delay: 0.4s; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-0">
    <!-- Page Header -->
    <div class="secrets-card card p-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="mb-0">
                <i class="fas fa-shield-alt me-2"></i>Secrets Management
            </h2>
            <span class="badge bg-danger">Super Admin Only</span>
        </div>
        
        <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            Comprehensive configuration management for application settings, SMTP, ServiceNow integrations, and more.
        </div>
    </div>

    <!-- Tabs Navigation -->
    <ul class="nav nav-tabs" id="secretsTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="view-tab" data-bs-toggle="tab" data-bs-target="#view-pane" type="button" role="tab">
                <i class="fas fa-eye me-2"></i>View Secrets
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="categories-tab" data-bs-toggle="tab" data-bs-target="#categories-pane" type="button" role="tab">
                <i class="fas fa-tags me-2"></i>Categories
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="audit-tab" data-bs-toggle="tab" data-bs-target="#audit-pane" type="button" role="tab">
                <i class="fas fa-history me-2"></i>Audit Log
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="secretsTabContent">
        <!-- View Secrets Tab -->
        <div class="tab-pane fade show active" id="view-pane" role="tabpanel">
            <div class="container-fluid">
                <!-- Configuration Statistics -->
                <div class="stats-grid mb-4">
                    <div class="stat-card">
                        <div class="stat-number">{{ secrets|length if secrets else 10 }}</div>
                        <div class="stat-label">Total Secrets</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">4</div>
                        <div class="stat-label">Categories</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">
                            {% set configured_count = 0 %}
                            {% if servicenow_configured %}{% set configured_count = configured_count + 1 %}{% endif %}
                            {% if smtp_configured %}{% set configured_count = configured_count + 1 %}{% endif %}
                            {% if oauth_configured %}{% set configured_count = configured_count + 1 %}{% endif %}
                            {{ configured_count }}
                        </div>
                        <div class="stat-label">Configured</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">7:08:58 am</div>
                        <div class="stat-label">Last Updated</div>
                    </div>
                </div>

                <!-- Configuration Sections -->
                <div class="row g-4">
                    <!-- ServiceNow Configuration Card -->
                    <div class="col-lg-6">
                        <div class="config-card">
                            <div class="config-card-header">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="config-title">
                                        <i class="fas fa-cloud config-icon text-primary"></i>
                                        <div>
                                            <h5 class="mb-0">ServiceNow Configuration</h5>
                                            <small class="text-muted">Integration settings for ServiceNow platform</small>
                                        </div>
                                    </div>
                                    <span class="badge {% if servicenow_configured %}bg-success{% else %}bg-warning{% endif %} status-badge">
                                        {% if servicenow_configured %}
                                            <i class="fas fa-check-circle me-1"></i>CONFIGURED
                                        {% else %}
                                            <i class="fas fa-exclamation-triangle me-1"></i>NOT CONFIGURED
                                        {% endif %}
                                    </span>
                                </div>
                            </div>
                            
                            <div class="config-card-body">
                                <div class="config-items-list">
                                    <div class="config-item-row">
                                        <div class="config-field">
                                            <i class="fas fa-server field-icon"></i>
                                            <div class="field-info">
                                                <span class="field-label">Instance URL</span>
                                                <span class="field-description">ServiceNow instance endpoint</span>
                                            </div>
                                        </div>
                                        <div class="config-value-section">
                                            <div class="value-container">
                                                <input type="password" class="form-control config-input" id="servicenow_instance" 
                                                       value="••••••••••••••••••••" readonly>
                                                <button class="btn btn-sm btn-outline-secondary toggle-btn" onclick="toggleVisibility('servicenow_instance')">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </div>
                                            <button class="btn btn-sm btn-primary edit-btn" onclick="editConfig('SERVICENOW_INSTANCE')">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                        </div>
                                    </div>

                                    <div class="config-item-row">
                                        <div class="config-field">
                                            <i class="fas fa-user field-icon"></i>
                                            <div class="field-info">
                                                <span class="field-label">Username</span>
                                                <span class="field-description">ServiceNow authentication username</span>
                                            </div>
                                        </div>
                                        <div class="config-value-section">
                                            <div class="value-container">
                                                <input type="password" class="form-control config-input" id="servicenow_username" 
                                                       value="••••••••••••••••••••" readonly>
                                                <button class="btn btn-sm btn-outline-secondary toggle-btn" onclick="toggleVisibility('servicenow_username')">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </div>
                                            <button class="btn btn-sm btn-primary edit-btn" onclick="editConfig('SERVICENOW_USERNAME')">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                        </div>
                                    </div>

                                    <div class="config-item-row">
                                        <div class="config-field">
                                            <i class="fas fa-lock field-icon"></i>
                                            <div class="field-info">
                                                <span class="field-label">Password</span>
                                                <span class="field-description">ServiceNow authentication password</span>
                                            </div>
                                        </div>
                                        <div class="config-value-section">
                                            <div class="value-container">
                                                <input type="password" class="form-control config-input" id="servicenow_password" 
                                                       value="••••••••••••••••••••" readonly>
                                                <button class="btn btn-sm btn-outline-secondary toggle-btn" onclick="toggleVisibility('servicenow_password')">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </div>
                                            <button class="btn btn-sm btn-primary edit-btn" onclick="editConfig('SERVICENOW_PASSWORD')">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="config-actions">
                                    <button class="btn btn-primary test-connection-btn" onclick="testServiceNowConnection()">
                                        <i class="fas fa-plug me-2"></i>Test Connection
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SMTP Configuration Card -->
                    <div class="col-lg-6">
                        <div class="config-card">
                            <div class="config-card-header">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="config-title">
                                        <i class="fas fa-envelope config-icon text-success"></i>
                                        <div>
                                            <h5 class="mb-0">SMTP Configuration</h5>
                                            <small class="text-muted">Email service settings for notifications</small>
                                        </div>
                                    </div>
                                    <span class="badge {% if smtp_configured %}bg-success{% else %}bg-warning{% endif %} status-badge">
                                        {% if smtp_configured %}
                                            <i class="fas fa-check-circle me-1"></i>CONFIGURED
                                        {% else %}
                                            <i class="fas fa-exclamation-triangle me-1"></i>NOT CONFIGURED
                                        {% endif %}
                                    </span>
                                </div>
                            </div>
                            
                            <div class="config-card-body">
                                <div class="config-items-list">
                                    <div class="config-item-row">
                                        <div class="config-field">
                                            <i class="fas fa-server field-icon"></i>
                                            <div class="field-info">
                                                <span class="field-label">SMTP Server</span>
                                                <span class="field-description">Mail server hostname</span>
                                            </div>
                                        </div>
                                        <div class="config-value-section">
                                            <div class="value-container">
                                                <input type="text" class="form-control config-input" id="smtp_server" 
                                                       value="smtp.gmail.com" readonly>
                                            </div>
                                            <button class="btn btn-sm btn-primary edit-btn" onclick="editConfig('SMTP_SERVER')">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                        </div>
                                    </div>

                                    <div class="config-item-row">
                                        <div class="config-field">
                                            <i class="fas fa-plug field-icon"></i>
                                            <div class="field-info">
                                                <span class="field-label">Port</span>
                                                <span class="field-description">SMTP server port number</span>
                                            </div>
                                        </div>
                                        <div class="config-value-section">
                                            <div class="value-container">
                                                <input type="text" class="form-control config-input" id="smtp_port" 
                                                       value="587" readonly>
                                            </div>
                                            <button class="btn btn-sm btn-primary edit-btn" onclick="editConfig('SMTP_PORT')">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                        </div>
                                    </div>

                                    <div class="config-item-row">
                                        <div class="config-field">
                                            <i class="fas fa-user field-icon"></i>
                                            <div class="field-info">
                                                <span class="field-label">Username</span>
                                                <span class="field-description">SMTP authentication username</span>
                                            </div>
                                        </div>
                                        <div class="config-value-section">
                                            <div class="value-container">
                                                <input type="password" class="form-control config-input" id="smtp_username" 
                                                       value="••••••••••••••••••••" readonly>
                                                <button class="btn btn-sm btn-outline-secondary toggle-btn" onclick="toggleVisibility('smtp_username')">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </div>
                                            <button class="btn btn-sm btn-primary edit-btn" onclick="editConfig('SMTP_USERNAME')">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                        </div>
                                    </div>

                                    <div class="config-item-row">
                                        <div class="config-field">
                                            <i class="fas fa-lock field-icon"></i>
                                            <div class="field-info">
                                                <span class="field-label">Password</span>
                                                <span class="field-description">SMTP authentication password</span>
                                            </div>
                                        </div>
                                        <div class="config-value-section">
                                            <div class="value-container">
                                                <input type="password" class="form-control config-input" id="smtp_password" 
                                                       value="••••••••••••••••••••" readonly>
                                                <button class="btn btn-sm btn-outline-secondary toggle-btn" onclick="toggleVisibility('smtp_password')">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </div>
                                            <button class="btn btn-sm btn-primary edit-btn" onclick="editConfig('SMTP_PASSWORD')">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="config-actions">
                                    <button class="btn btn-success test-connection-btn" onclick="testSMTPConnection()">
                                        <i class="fas fa-paper-plane me-2"></i>Test Email
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Second Row - Email Recipients and Application Configuration -->
                <div class="row g-4 mb-4">
                    <!-- Email Recipients Configuration Card -->
                    <div class="col-lg-6">
                        <div class="config-card">
                            <div class="config-card-header">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="config-title">
                                        <i class="fas fa-users config-icon text-primary"></i>
                                        <div>
                                            <h5 class="mb-0">Email Recipients</h5>
                                            <small class="text-muted">Shift handover email recipient lists</small>
                                        </div>
                                    </div>
                                    <span class="badge bg-primary status-badge" id="emailRecipientsStatus">
                                        <i class="fas fa-check-circle me-1"></i>ACTIVE
                                    </span>
                                </div>
                            </div>
                            
                            <div class="config-card-body">
                                <div class="config-items-list">
                                    <div class="config-item-row">
                                        <div class="config-field">
                                            <i class="fas fa-envelope-open field-icon"></i>
                                            <div class="field-info">
                                                <span class="field-label">Handover Email Recipients</span>
                                                <span class="field-description">Comma-separated email addresses for shift handover notifications</span>
                                            </div>
                                        </div>
                                        <div class="config-value-section">
                                            <div class="value-container">
                                                <textarea class="form-control config-input" id="handover_email_recipients" 
                                                         rows="3" placeholder="email1@company.com, email2@company.com, team-lead@company.com" readonly></textarea>
                                            </div>
                                            <button class="btn btn-sm btn-primary edit-btn" onclick="editEmailRecipients('handover_email_recipients')">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                        </div>
                                    </div>

                                    <div class="config-item-row">
                                        <div class="config-field">
                                            <i class="fas fa-bell field-icon"></i>
                                            <div class="field-info">
                                                <span class="field-label">Priority Alert Recipients</span>
                                                <span class="field-description">Email addresses for high-priority incident alerts</span>
                                            </div>
                                        </div>
                                        <div class="config-value-section">
                                            <div class="value-container">
                                                <textarea class="form-control config-input" id="priority_alert_recipients" 
                                                         rows="2" placeholder="manager@company.com, on-call@company.com" readonly></textarea>
                                            </div>
                                            <button class="btn btn-sm btn-primary edit-btn" onclick="editEmailRecipients('priority_alert_recipients')">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                        </div>
                                    </div>

                                    <div class="config-item-row">
                                        <div class="config-field">
                                            <i class="fas fa-toggle-on field-icon"></i>
                                            <div class="field-info">
                                                <span class="field-label">Email Notifications Enabled</span>
                                                <span class="field-description">Enable/disable email notifications for handovers</span>
                                            </div>
                                        </div>
                                        <div class="config-value-section">
                                            <div class="value-container">
                                                <div class="form-check form-switch">
                                                    <input class="form-check-input" type="checkbox" id="email_notifications_enabled" checked 
                                                           onchange="toggleEmailNotifications()">
                                                    <label class="form-check-label" for="email_notifications_enabled">
                                                        <span id="emailNotificationStatus">Enabled</span>
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="config-actions">
                                    <button class="btn btn-success test-connection-btn" onclick="testEmailRecipients()">
                                        <i class="fas fa-paper-plane me-2"></i>Test Email Recipients
                                    </button>
                                    <button class="btn btn-outline-primary" onclick="loadEmailRecipients()">
                                        <i class="fas fa-sync me-2"></i>Refresh
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Application Configuration Card -->
                    <div class="col-lg-6">
                        <div class="config-card">
                            <div class="config-card-header">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="config-title">
                                        <i class="fas fa-cogs config-icon text-info"></i>
                                        <div>
                                            <h5 class="mb-0">Application Configuration</h5>
                                            <small class="text-muted">General application settings and shift timings</small>
                                        </div>
                                    </div>
                                    <span class="badge bg-info status-badge">
                                        <i class="fas fa-check-circle me-1"></i>ACTIVE
                                    </span>
                                </div>
                            </div>
                            
                            <div class="config-card-body">
                                <div class="config-items-list">
                                    <div class="config-item-row">
                                        <div class="config-field">
                                            <i class="fas fa-clock field-icon"></i>
                                            <div class="field-info">
                                                <span class="field-label">Day Shift Start</span>
                                                <span class="field-description">Morning shift start time</span>
                                            </div>
                                        </div>
                                        <div class="config-value-section">
                                            <div class="value-container">
                                                <input type="text" class="form-control config-input" id="day_shift_start" 
                                                       value="08:00 AM" readonly>
                                            </div>
                                            <button class="btn btn-sm btn-primary edit-btn" onclick="editConfig('DAY_SHIFT_START')">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                        </div>
                                    </div>

                                    <div class="config-item-row">
                                        <div class="config-field">
                                            <i class="fas fa-moon field-icon"></i>
                                            <div class="field-info">
                                                <span class="field-label">Night Shift End</span>
                                                <span class="field-description">Night shift end time</span>
                                            </div>
                                        </div>
                                        <div class="config-value-section">
                                            <div class="value-container">
                                                <input type="text" class="form-control config-input" id="night_shift_end" 
                                                       value="08:00 PM" readonly>
                                            </div>
                                            <button class="btn btn-sm btn-primary edit-btn" onclick="editConfig('NIGHT_SHIFT_END')">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                        </div>
                                    </div>

                                    <div class="config-item-row">
                                        <div class="config-field">
                                            <i class="fas fa-envelope field-icon"></i>
                                            <div class="field-info">
                                                <span class="field-label">Team Email</span>
                                                <span class="field-description">Primary team contact email</span>
                                            </div>
                                        </div>
                                        <div class="config-value-section">
                                            <div class="value-container">
                                                <input type="password" class="form-control config-input" id="team_email" 
                                                       value="••••••••••••••••••••" readonly>
                                                <button class="btn btn-sm btn-outline-secondary toggle-btn" onclick="toggleVisibility('team_email')">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </div>
                                            <button class="btn btn-sm btn-primary edit-btn" onclick="editConfig('TEAM_EMAIL')">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                        </div>
                                    </div>

                                    <div class="config-item-row">
                                        <div class="config-field">
                                            <i class="fas fa-database field-icon"></i>
                                            <div class="field-info">
                                                <span class="field-label">Database URL</span>
                                                <span class="field-description">Primary database connection</span>
                                            </div>
                                        </div>
                                        <div class="config-value-section">
                                            <div class="value-container">
                                                <input type="password" class="form-control config-input" id="database_url" 
                                                       value="••••••••••••••••••••" readonly>
                                                <button class="btn btn-sm btn-outline-secondary toggle-btn" onclick="toggleVisibility('database_url')">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </div>
                                            <button class="btn btn-sm btn-primary edit-btn" onclick="editConfig('DATABASE_URL')">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="config-actions">
                                    <button class="btn btn-info test-connection-btn" onclick="validateAppConfig()">
                                        <i class="fas fa-check-double me-2"></i>Validate Config
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- OAuth & SSO Configuration Card -->
                    <div class="col-lg-6">
                        <div class="config-card">
                            <div class="config-card-header">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="config-title">
                                        <i class="fas fa-shield-alt config-icon text-warning"></i>
                                        <div>
                                            <h5 class="mb-0">OAuth & SSO Configuration</h5>
                                            <small class="text-muted">Authentication and single sign-on settings</small>
                                        </div>
                                    </div>
                                    <span class="badge {% if oauth_configured %}bg-success{% else %}bg-warning{% endif %} status-badge">
                                        {% if oauth_configured %}
                                            <i class="fas fa-check-circle me-1"></i>CONFIGURED
                                        {% else %}
                                            <i class="fas fa-exclamation-triangle me-1"></i>NOT CONFIGURED
                                        {% endif %}
                                    </span>
                                </div>
                            </div>
                            
                            <div class="config-card-body">
                                <div class="config-items-list">
                                    <div class="config-item-row">
                                        <div class="config-field">
                                            <i class="fas fa-key field-icon"></i>
                                            <div class="field-info">
                                                <span class="field-label">Google OAuth Client ID</span>
                                                <span class="field-description">OAuth application client identifier</span>
                                            </div>
                                        </div>
                                        <div class="config-value-section">
                                            <div class="value-container">
                                                <input type="password" class="form-control config-input" id="google_oauth_client_id" 
                                                       value="••••••••••••••••••••" readonly>
                                                <button class="btn btn-sm btn-outline-secondary toggle-btn" onclick="toggleVisibility('google_oauth_client_id')">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </div>
                                            <button class="btn btn-sm btn-primary edit-btn" onclick="editConfig('GOOGLE_OAUTH_CLIENT_ID')">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                        </div>
                                    </div>

                                    <div class="config-item-row">
                                        <div class="config-field">
                                            <i class="fas fa-lock field-icon"></i>
                                            <div class="field-info">
                                                <span class="field-label">Google OAuth Client Secret</span>
                                                <span class="field-description">OAuth application client secret</span>
                                            </div>
                                        </div>
                                        <div class="config-value-section">
                                            <div class="value-container">
                                                <input type="password" class="form-control config-input" id="google_oauth_client_secret" 
                                                       value="••••••••••••••••••••" readonly>
                                                <button class="btn btn-sm btn-outline-secondary toggle-btn" onclick="toggleVisibility('google_oauth_client_secret')">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </div>
                                            <button class="btn btn-sm btn-primary edit-btn" onclick="editConfig('GOOGLE_OAUTH_CLIENT_SECRET')">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                        </div>
                                    </div>

                                    <div class="config-item-row">
                                        <div class="config-field">
                                            <i class="fas fa-link field-icon"></i>
                                            <div class="field-info">
                                                <span class="field-label">OAuth Redirect URI</span>
                                                <span class="field-description">OAuth callback endpoint</span>
                                            </div>
                                        </div>
                                        <div class="config-value-section">
                                            <div class="value-container">
                                                <input type="text" class="form-control config-input" id="oauth_redirect_uri" 
                                                       value="/auth/callback" readonly>
                                            </div>
                                            <button class="btn btn-sm btn-primary edit-btn" onclick="editConfig('OAUTH_REDIRECT_URI')">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                        </div>
                                    </div>

                                    <div class="config-item-row">
                                        <div class="config-field">
                                            <i class="fas fa-cog field-icon"></i>
                                            <div class="field-info">
                                                <span class="field-label">JWT Secret</span>
                                                <span class="field-description">Token signing secret key</span>
                                            </div>
                                        </div>
                                        <div class="config-value-section">
                                            <div class="value-container">
                                                <input type="password" class="form-control config-input" id="jwt_secret" 
                                                       value="••••••••••••••••••••" readonly>
                                                <button class="btn btn-sm btn-outline-secondary toggle-btn" onclick="toggleVisibility('jwt_secret')">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </div>
                                            <button class="btn btn-sm btn-primary edit-btn" onclick="editConfig('JWT_SECRET')">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="config-actions">
                                    <button class="btn btn-warning test-connection-btn" onclick="testOAuthConfig()">
                                        <i class="fas fa-shield-alt me-2"></i>Test OAuth
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Categories Tab -->
        <div class="tab-pane fade" id="categories-pane" role="tabpanel">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <h5><i class="fas fa-tags me-2"></i>Configuration Categories</h5>
                            <p class="text-muted">Manage and organize configuration categories.</p>
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                Categories help organize different types of secrets and configurations.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Audit Log Tab -->
        <div class="tab-pane fade" id="audit-pane" role="tabpanel">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <h5><i class="fas fa-history me-2"></i>Configuration Audit Log</h5>
                            <p class="text-muted">Track changes and access to configuration settings.</p>
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                All configuration changes are logged for security and compliance.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Toggle visibility of secret fields
function toggleVisibility(fieldId) {
    const field = document.getElementById(fieldId);
    const button = field.nextElementSibling;
    const icon = button.querySelector('i');
    
    if (field.type === 'password') {
        field.type = 'text';
        icon.className = 'fas fa-eye-slash';
    } else {
        field.type = 'password';
        icon.className = 'fas fa-eye';
    }
}

// Edit configuration function
function editConfig(configKey) {
    showToast(`Editing ${configKey}`, 'info');
    // Implement edit functionality here
}

// Test connection functions
function testServiceNowConnection() {
    showToast('Testing ServiceNow connection...', 'info');
    // Implement ServiceNow test here
}

function testSMTPConnection() {
    showToast('Testing SMTP configuration...', 'info');
    // Implement SMTP test here
}

function validateAppConfig() {
    showToast('Validating application configuration...', 'info');
    // Implement app config validation here
}

function testOAuthConfig() {
    showToast('Testing OAuth configuration...', 'info');
    // Implement OAuth test here
}

// Toast notification function
function showToast(message, type = 'success') {
    // Create toast container if it doesn't exist
    let toastContainer = document.getElementById('toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toast-container';
        toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
        document.body.appendChild(toastContainer);
    }
    
    // Create toast element
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-bg-${type} border-0`;
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    toastContainer.appendChild(toast);
    
    // Show toast
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    // Remove after hiding
    toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
    });
}

// Email Recipients Configuration Functions
function editEmailRecipients(fieldId) {
    const field = document.getElementById(fieldId);
    const editButton = field.parentElement.nextElementSibling;
    
    if (field.readOnly) {
        // Enable editing
        field.readOnly = false;
        field.classList.add('editing');
        field.focus();
        editButton.innerHTML = '<i class="fas fa-save"></i>';
        editButton.classList.remove('btn-primary');
        editButton.classList.add('btn-success');
        editButton.setAttribute('onclick', `saveEmailRecipients('${fieldId}')`);
    }
}

function saveEmailRecipients(fieldId) {
    const field = document.getElementById(fieldId);
    const editButton = field.parentElement.nextElementSibling;
    const emails = field.value.trim();
    
    // Validate email format
    if (emails && !validateEmailList(emails)) {
        showToast('Please enter valid email addresses separated by commas', 'danger');
        return;
    }
    
    // Save to server
    fetch('/admin/secrets/api/email-recipients', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            field: fieldId,
            emails: emails
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Disable editing
            field.readOnly = true;
            field.classList.remove('editing');
            editButton.innerHTML = '<i class="fas fa-edit"></i>';
            editButton.classList.remove('btn-success');
            editButton.classList.add('btn-primary');
            editButton.setAttribute('onclick', `editEmailRecipients('${fieldId}')`);
            
            showToast('Email recipients saved successfully', 'success');
        } else {
            showToast(`Error saving email recipients: ${data.error}`, 'danger');
        }
    })
    .catch(error => {
        showToast(`Error saving email recipients: ${error}`, 'danger');
    });
}

function validateEmailList(emailString) {
    if (!emailString) return true; // Empty is valid
    
    const emails = emailString.split(',').map(email => email.trim()).filter(email => email);
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    
    return emails.every(email => emailRegex.test(email));
}

function loadEmailRecipients() {
    showToast('Loading email recipients...', 'info');
    
    fetch('/admin/secrets/api/email-recipients')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('handover_email_recipients').value = data.handover_recipients || '';
            document.getElementById('priority_alert_recipients').value = data.priority_recipients || '';
            document.getElementById('email_notifications_enabled').checked = data.notifications_enabled;
            updateEmailNotificationStatus(data.notifications_enabled);
            showToast('Email recipients loaded successfully', 'success');
        } else {
            showToast(`Error loading email recipients: ${data.error}`, 'danger');
        }
    })
    .catch(error => {
        showToast(`Error loading email recipients: ${error}`, 'danger');
    });
}

function toggleEmailNotifications() {
    const checkbox = document.getElementById('email_notifications_enabled');
    const enabled = checkbox.checked;
    
    fetch('/admin/secrets/api/email-notifications', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            enabled: enabled
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateEmailNotificationStatus(enabled);
            showToast(`Email notifications ${enabled ? 'enabled' : 'disabled'}`, 'success');
        } else {
            // Revert checkbox on error
            checkbox.checked = !enabled;
            showToast(`Error updating notification settings: ${data.error}`, 'danger');
        }
    })
    .catch(error => {
        checkbox.checked = !enabled;
        showToast(`Error updating notification settings: ${error}`, 'danger');
    });
}

function updateEmailNotificationStatus(enabled) {
    const statusSpan = document.getElementById('emailNotificationStatus');
    statusSpan.textContent = enabled ? 'Enabled' : 'Disabled';
    statusSpan.className = enabled ? 'text-success' : 'text-danger';
}

function testEmailRecipients() {
    const handoverRecipients = document.getElementById('handover_email_recipients').value.trim();
    const priorityRecipients = document.getElementById('priority_alert_recipients').value.trim();
    
    if (!handoverRecipients && !priorityRecipients) {
        showToast('Please configure email recipients first', 'warning');
        return;
    }
    
    showToast('Sending test emails...', 'info');
    
    fetch('/admin/secrets/api/test-email-recipients', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            handover_recipients: handoverRecipients,
            priority_recipients: priorityRecipients
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Test emails sent successfully! Check recipient inboxes.', 'success');
        } else {
            showToast(`Error sending test emails: ${data.error}`, 'danger');
        }
    })
    .catch(error => {
        showToast(`Error sending test emails: ${error}`, 'danger');
    });
}

// Load email recipients on page load
document.addEventListener('DOMContentLoaded', function() {
    loadEmailRecipients();
});
</script>
{% endblock %}