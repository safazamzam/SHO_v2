{% extends "base.html" %}

{% block title %}Secrets Management Dashboard - Admin{% endblock %}

{% block extra_css %}
<style>
    .secrets-dashboard {
        padding: 20px;
        background: #f5f6fa;
        min-height: 100vh;
    }
    
    .dashboard-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    
    .dashboard-title {
        font-size: 2rem;
        font-weight: 700;
        margin: 0 0 10px 0;
        display: flex;
        align-items: center;
        gap: 15px;
    }
    
    .dashboard-subtitle {
        opacity: 0.9;
        font-size: 1.1rem;
        margin: 0;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin: 25px 0;
    }
    
    .stat-card {
        background: rgba(255,255,255,0.2);
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        backdrop-filter: blur(10px);
    }
    
    .stat-number {
        font-size: 2.5rem;
        font-weight: 700;
        display: block;
    }
    
    .stat-label {
        font-size: 0.9rem;
        opacity: 0.9;
        margin-top: 5px;
    }
    
    .section-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 25px;
        margin-top: 30px;
    }
    
    .config-section {
        background: white;
        border-radius: 15px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.08);
        overflow: hidden;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .config-section:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 30px rgba(0,0,0,0.12);
    }
    
    .section-header {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
        padding: 20px 25px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .section-header.smtp {
        background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    }
    
    .section-header.servicenow {
        background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
        color: #333;
    }
    
    .section-header.features {
        background: linear-gradient(135deg, #96fbc4 0%, #f9f047 100%);
        color: #333;
    }
    
    .section-title {
        font-size: 1.3rem;
        font-weight: 600;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .section-count {
        background: rgba(255,255,255,0.2);
        border-radius: 20px;
        padding: 5px 12px;
        font-size: 0.9rem;
        font-weight: 600;
    }
    
    .section-actions {
        display: flex;
        gap: 10px;
    }
    
    .btn-edit, .btn-add {
        background: rgba(255,255,255,0.2);
        border: 1px solid rgba(255,255,255,0.3);
        color: inherit;
        padding: 8px 15px;
        border-radius: 8px;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.2s;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 5px;
    }
    
    .btn-edit:hover, .btn-add:hover {
        background: rgba(255,255,255,0.3);
        transform: translateY(-1px);
        color: inherit;
        text-decoration: none;
    }
    
    .section-body {
        padding: 25px;
    }
    
    .secret-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 0;
        border-bottom: 1px solid #eee;
        transition: background 0.2s;
    }
    
    .secret-item:last-child {
        border-bottom: none;
    }
    
    .secret-item:hover {
        background: #f8f9ff;
        margin: 0 -15px;
        padding-left: 15px;
        padding-right: 15px;
        border-radius: 8px;
    }
    
    .secret-info {
        flex: 1;
    }
    
    .secret-name {
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 5px;
    }
    
    .secret-description {
        color: #7f8c8d;
        font-size: 0.9rem;
        line-height: 1.4;
    }
    
    .secret-status {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .status-badge {
        padding: 4px 10px;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .status-active {
        background: #d4edda;
        color: #155724;
    }
    
    .status-inactive {
        background: #f8d7da;
        color: #721c24;
    }
    
    .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #95a5a6;
    }
    
    .empty-icon {
        font-size: 3rem;
        margin-bottom: 15px;
        opacity: 0.5;
    }
    
    .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255,255,255,0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    .error-state {
        background: #f8d7da;
        color: #721c24;
        padding: 15px 20px;
        border-radius: 8px;
        margin: 15px 0;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .btn-retry {
        background: #dc3545;
        color: white;
        border: none;
        padding: 5px 12px;
        border-radius: 5px;
        font-size: 0.8rem;
        cursor: pointer;
        margin-left: auto;
    }
    
    .btn-retry:hover {
        background: #c82333;
    }
    
    .fade-in {
        animation: fadeIn 0.3s ease-in;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>
{% endblock %}

{% block content %}
<div class="secrets-dashboard">
    <!-- Dashboard Header -->
    <div class="dashboard-header">
        <div class="dashboard-title">
            üîê Secrets Management Dashboard
        </div>
        <p class="dashboard-subtitle">
            Manage application configurations, SMTP settings, ServiceNow integration, and feature controls
        </p>
        
        <!-- Statistics -->
        <div class="stats-grid">
            <div class="stat-card">
                <span class="stat-number" id="total-secrets-count">0</span>
                <div class="stat-label">Total Secrets</div>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="active-secrets-count">0</span>
                <div class="stat-label">Active Secrets</div>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="config-sections-count">4</span>
                <div class="stat-label">Config Sections</div>
            </div>
        </div>
    </div>

    <!-- Configuration Sections -->
    <div class="section-grid">
        <!-- Application Configuration Section -->
        <div class="config-section" id="app-config-section">
            <div class="section-header">
                <div class="section-title">
                    ‚öôÔ∏è Application Configuration
                    <span class="section-count" id="app-config-count">0</span>
                </div>
                <div class="section-actions">
                    <button class="btn-edit" onclick="editSection('application_config')">
                        ‚úèÔ∏è Edit
                    </button>
                    <a href="/admin/secrets/add?category=application_config" class="btn-add">
                        ‚ûï Add
                    </a>
                </div>
            </div>
            <div class="section-body">
                <div class="secrets-list" id="app-config-list">
                    <div class="loading-spinner"></div>
                </div>
            </div>
        </div>

        <!-- SMTP Configuration Section -->
        <div class="config-section" id="smtp-config-section">
            <div class="section-header smtp">
                <div class="section-title">
                    üìß SMTP Configuration
                    <span class="section-count" id="smtp-config-count">0</span>
                </div>
                <div class="section-actions">
                    <button class="btn-edit" onclick="editSection('smtp')">
                        ‚úèÔ∏è Edit
                    </button>
                    <a href="/admin/secrets/add?category=external_apis&type=smtp" class="btn-add">
                        ‚ûï Add
                    </a>
                </div>
            </div>
            <div class="section-body">
                <div class="secrets-list" id="smtp-config-list">
                    <div class="loading-spinner"></div>
                </div>
            </div>
        </div>

        <!-- ServiceNow Configuration Section -->
        <div class="config-section" id="servicenow-config-section">
            <div class="section-header servicenow">
                <div class="section-title">
                    üîß ServiceNow Configuration  
                    <span class="section-count" id="servicenow-config-count">0</span>
                </div>
                <div class="section-actions">
                    <button class="btn-edit" onclick="editSection('servicenow')">
                        ‚úèÔ∏è Edit
                    </button>
                    <a href="/admin/secrets/add?category=external_apis&type=servicenow" class="btn-add">
                        ‚ûï Add
                    </a>
                </div>
            </div>
            <div class="section-body">
                <div class="secrets-list" id="servicenow-config-list">
                    <div class="loading-spinner"></div>
                </div>
            </div>
        </div>

        <!-- Feature Controls Section -->
        <div class="config-section" id="features-section">
            <div class="section-header features">
                <div class="section-title">
                    üéõÔ∏è Feature Controls
                    <span class="section-count" id="features-count">0</span>
                </div>
                <div class="section-actions">
                    <button class="btn-edit" onclick="editSection('features')">
                        ‚úèÔ∏è Edit
                    </button>
                    <a href="/admin/secrets/add?category=feature_controls" class="btn-add">
                        ‚ûï Add
                    </a>
                </div>
            </div>
            <div class="section-body">
                <div class="secrets-list" id="features-list">
                    <div class="loading-spinner"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Global state
let allSecrets = [];

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    loadSecretsData();
});

// Load secrets data from API
async function loadSecretsData() {
    try {
        console.log('Loading secrets data...');
        
        const response = await fetch('/admin/secrets/api/secrets');
        const data = await response.json();
        
        if (!data.success) {
            throw new Error(data.error || 'Failed to load secrets');
        }
        
        allSecrets = data.secrets || [];
        console.log(`Loaded ${allSecrets.length} secrets:`, allSecrets);
        
        // Update statistics
        updateStatistics();
        
        // Organize and display secrets by sections
        organizeSections();
        
    } catch (error) {
        console.error('Error loading secrets:', error);
        showErrorInAllSections(error.message);
    }
}

// Update dashboard statistics
function updateStatistics() {
    const totalCount = allSecrets.length;
    const activeCount = allSecrets.filter(s => s.is_active).length;
    
    document.getElementById('total-secrets-count').textContent = totalCount;
    document.getElementById('active-secrets-count').textContent = activeCount;
}

// Organize secrets into sections
function organizeSections() {
    // Define section mappings
    const sections = {
        'app-config': {
            list: 'app-config-list',
            count: 'app-config-count',
            filter: (secret) => secret.category === 'application_config' || 
                              (secret.category === 'external_apis' && 
                               ['DATABASE_URL', 'TEAM_EMAIL'].includes(secret.key_name))
        },
        'smtp-config': {
            list: 'smtp-config-list', 
            count: 'smtp-config-count',
            filter: (secret) => secret.key_name.includes('SMTP') || secret.key_name.includes('MAIL')
        },
        'servicenow-config': {
            list: 'servicenow-config-list',
            count: 'servicenow-config-count', 
            filter: (secret) => secret.key_name.includes('SERVICENOW')
        },
        'features': {
            list: 'features-list',
            count: 'features-count',
            filter: (secret) => secret.category === 'feature_controls' ||
                              secret.key_name.includes('OAUTH') ||
                              secret.key_name.includes('GOOGLE')
        }
    };
    
    // Process each section
    Object.keys(sections).forEach(sectionKey => {
        const section = sections[sectionKey];
        const sectionSecrets = allSecrets.filter(section.filter);
        
        // Update count
        document.getElementById(section.count).textContent = sectionSecrets.length;
        
        // Display secrets
        displaySecretsInSection(section.list, sectionSecrets);
    });
}

// Display secrets in a specific section
function displaySecretsInSection(listElementId, secrets) {
    const listElement = document.getElementById(listElementId);
    
    if (secrets.length === 0) {
        listElement.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">üìù</div>
                <p>No configuration items found</p>
                <small>Click "Add" to create new configuration</small>
            </div>
        `;
        return;
    }
    
    listElement.innerHTML = secrets.map(secret => `
        <div class="secret-item fade-in" data-secret-id="${secret.key_name}">
            <div class="secret-info">
                <div class="secret-name">${secret.key_name}</div>
                <div class="secret-description">
                    ${secret.description || 'No description provided'}
                </div>
            </div>
            <div class="secret-status">
                <span class="status-badge ${secret.is_active ? 'status-active' : 'status-inactive'}">
                    ${secret.is_active ? 'Active' : 'Inactive'}
                </span>
                <button class="btn-edit" onclick="editSecret('${secret.key_name}')" style="background: #17a2b8; color: white; border: none; padding: 5px 10px; border-radius: 4px; font-size: 0.8rem;">
                    Edit
                </button>
            </div>
        </div>
    `).join('');
}

// Show error in all sections
function showErrorInAllSections(errorMessage) {
    const listIds = ['app-config-list', 'smtp-config-list', 'servicenow-config-list', 'features-list'];
    
    listIds.forEach(listId => {
        document.getElementById(listId).innerHTML = `
            <div class="error-state">
                ‚ö†Ô∏è Failed to load configuration: ${errorMessage}
                <button class="btn-retry" onclick="loadSecretsData()">Retry</button>
            </div>
        `;
    });
}

// Edit individual secret
function editSecret(keyName) {
    // Redirect to individual secret edit page
    window.location.href = `/admin/secrets/edit/${keyName}`;
}

// Edit section (opens all secrets in that section for editing)
function editSection(sectionType) {
    // For now, redirect to main secrets page with filter
    window.location.href = `/admin/secrets/?filter=${sectionType}`;
}
</script>
{% endblock %}