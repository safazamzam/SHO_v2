{% extends "base.html" %}

{% block title %}Secrets Management{% endblock %}

{% block extra_css %}
<style>
    /* Clean, professional styling matching system configuration */
    .secrets-card {
        border: none;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        transition: transform 0.2s;
        margin-bottom: 1.5rem;
    }
    
    .secrets-card:hover {
        transform: translateY(-2px);
    }
    
    .section-header {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        border-left: 4px solid #007bff;
    }
    
    .secret-item {
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        background: #ffffff;
        transition: all 0.2s;
    }
    
    .secret-item:hover {
        border-color: #007bff;
        box-shadow: 0 2px 8px rgba(0,123,255,0.1);
    }
    
    .secret-name {
        font-weight: 600;
        color: #495057;
        margin-bottom: 0.5rem;
    }
    
    .secret-description {
        color: #6c757d;
        font-size: 0.9rem;
        margin-bottom: 1rem;
    }
    
    .secret-input {
        border: 1px solid #dee2e6;
        border-radius: 5px;
        padding: 0.5rem;
        font-family: monospace;
        font-size: 0.875rem;
        background: #f8f9fa;
    }
    
    .secret-input:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25);
    }
    
    .category-badge {
        background: #007bff;
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: 500;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }
    
    .stat-card {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 1.5rem;
        text-align: center;
        transition: transform 0.2s;
    }
    
    .stat-card:hover {
        transform: translateY(-2px);
        border-color: #007bff;
    }
    
    .stat-number {
        font-size: 2rem;
        font-weight: 700;
        color: #007bff;
        display: block;
    }
    
    .stat-label {
        color: #6c757d;
        font-size: 0.9rem;
        margin-top: 0.5rem;
    }
    
    .action-buttons {
        display: flex;
        gap: 0.5rem;
        margin-top: 1rem;
    }
    
    .btn-sm {
        padding: 0.375rem 0.75rem;
        font-size: 0.875rem;
        border-radius: 5px;
    }
    
    .category-section {
        margin-bottom: 2rem;
    }
    
    .nav-tabs .nav-link {
        border-radius: 5px 5px 0 0;
        border: 1px solid #dee2e6;
        color: #495057;
        font-weight: 500;
    }
    
    .nav-tabs .nav-link.active {
        background-color: #007bff;
        border-color: #007bff;
        color: white;
    }
    
    .tab-content {
        background: white;
        border: 1px solid #dee2e6;
        border-top: none;
        border-radius: 0 0 10px 10px;
        padding: 1.5rem;
    }
    
    .config-description {
        font-size: 0.9rem;
        color: #6c757d;
    }
    
    .config-status {
        font-weight: bold;
    }
    
    .status-enabled {
        color: #28a745;
    }
    
    .status-disabled {
        color: #dc3545;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-0">
    <!-- Page Header -->
    <div class="secrets-card card p-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="mb-0">
                <i class="fas fa-shield-alt me-2"></i>Secrets Management
            </h2>
            <span class="badge bg-danger">Super Admin Only</span>
        </div>
        
        <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            Comprehensive configuration management for application settings, SMTP, ServiceNow integrations, and more.
        </div>

        <!-- Statistics Overview -->
        <div class="stats-grid">
            <div class="stat-card">
                <span class="stat-number">{{ total_secrets|default(10) }}</span>
                <div class="stat-label">Total Secrets</div>
            </div>
            <div class="stat-card">
                <span class="stat-number">{{ active_secrets|default(10) }}</span>
                <div class="stat-label">Active Secrets</div>
            </div>
            <div class="stat-card">
                <span class="stat-number">{{ categories_count|default(4) }}</span>
                <div class="stat-label">Categories</div>
            </div>
            <div class="stat-card">
                <span class="stat-number">{{ last_updated|default("7:02:50 am") }}</span>
                <div class="stat-label">Last Updated</div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="d-flex gap-2 mb-3">
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addSecretModal">
                <i class="fas fa-plus me-1"></i> Add New Secret
            </button>
            <button type="button" class="btn btn-secondary" onclick="exportConfig()">
                <i class="fas fa-download me-1"></i> Export Config
            </button>
            <button type="button" class="btn btn-info" onclick="viewAuditLog()">
                <i class="fas fa-history me-1"></i> View Audit Log
            </button>
            <button type="button" class="btn btn-success" onclick="refreshAll()">
                <i class="fas fa-sync me-1"></i> Refresh All
            </button>
        </div>
    </div>

    <!-- Navigation Tabs -->
    <ul class="nav nav-tabs" id="secretsTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="view-tab" data-bs-toggle="tab" data-bs-target="#view-pane" type="button" role="tab">
                <i class="fas fa-eye me-1"></i> View Secrets
                <span class="badge bg-white text-primary">{{ total_secrets|default(10) }}</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="categories-tab" data-bs-toggle="tab" data-bs-target="#categories-pane" type="button" role="tab">
                <i class="fas fa-layer-group me-1"></i> Categories
                {% if secrets_status and secrets_status.configured %}
                    <span class="badge bg-success">CONFIGURED</span>
                {% else %}
                    <span class="badge bg-warning">NOT CONFIGURED</span>
                {% endif %}
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="secretsTabContent">
        <!-- View Secrets Tab -->
        <div class="tab-pane fade show active" id="view-pane" role="tabpanel">
            {% if secrets_by_category %}
                {% for category, secrets in secrets_by_category.items() %}
                    <div class="category-section">
                        <div class="section-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="mb-1">
                                        {% if category == 'External APIs' %}
                                            <i class="fas fa-globe me-2"></i>
                                        {% elif category == 'Application Configuration' %}
                                            <i class="fas fa-cog me-2"></i>
                                        {% elif category == 'Feature Controls' %}
                                            <i class="fas fa-toggle-on me-2"></i>
                                        {% elif category == 'Critical Secrets (Environment Only)' %}
                                            <i class="fas fa-lock me-2"></i>
                                        {% else %}
                                            <i class="fas fa-key me-2"></i>
                                        {% endif %}
                                        {{ category }}
                                    </h5>
                                    <div class="config-description">{{ secrets|length }} secret(s) in this category</div>
                                </div>
                                <span class="category-badge">{{ secrets|length }}</span>
                            </div>
                        </div>

                        {% for secret in secrets %}
                            <div class="secret-item">
                                <div class="secret-name">{{ secret.name }}</div>
                                <div class="secret-description">{{ secret.description }}</div>
                                
                                <div class="row">
                                    <div class="col-md-8">
                                        <div class="input-group">
                                            <input type="text" 
                                                   class="form-control secret-input" 
                                                   id="secret_{{ secret.id }}" 
                                                   value="{{ '*' * 20 if secret.value else 'Not Set' }}" 
                                                   readonly>
                                            <button class="btn btn-outline-secondary" type="button" onclick="toggleSecretVisibility('{{ secret.id }}')">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="action-buttons">
                                            <button class="btn btn-sm btn-primary" onclick="editSecret('{{ secret.id }}')">
                                                <i class="fas fa-edit me-1"></i> Edit
                                            </button>
                                            <button class="btn btn-sm btn-danger" onclick="deleteSecret('{{ secret.id }}')">
                                                <i class="fas fa-trash me-1"></i> Delete
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="d-flex justify-content-between align-items-center mt-2">
                                    <small class="text-muted">
                                        <i class="fas fa-clock me-1"></i>
                                        Updated: {{ secret.updated_at.strftime('%Y-%m-%d %H:%M') if secret.updated_at else 'Never' }}
                                    </small>
                                    <small class="text-muted">
                                        <i class="fas fa-eye me-1"></i>
                                        Accessed: {{ secret.last_accessed or 'Never' }}
                                    </small>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% endfor %}
            {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-key fa-3x text-muted mb-3"></i>
                    <h4 class="text-muted">No Secrets Configured</h4>
                    <p class="text-muted">Start by adding your first secret configuration.</p>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addSecretModal">
                        <i class="fas fa-plus me-1"></i> Add First Secret
                    </button>
                </div>
            {% endif %}
        </div>

        <!-- Categories Tab -->
        <div class="tab-pane fade" id="categories-pane" role="tabpanel">
            <div class="section-header">
                <h5 class="mb-1">
                    <i class="fas fa-layer-group me-2"></i>Secret Categories
                </h5>
                <div class="config-description">Organize your secrets into logical categories for better management</div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <div class="secret-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="secret-name">External APIs</div>
                                <div class="config-description">Third-party service integrations and API credentials</div>
                                <span class="config-status status-enabled">Active</span>
                            </div>
                            <span class="category-badge">{{ secrets_by_category.get('External APIs', [])|length }}</span>
                        </div>
                    </div>
                </div>

                <div class="col-md-6 mb-3">
                    <div class="secret-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="secret-name">Application Configuration</div>
                                <div class="config-description">Core application settings and configurations</div>
                                <span class="config-status status-enabled">Active</span>
                            </div>
                            <span class="category-badge">{{ secrets_by_category.get('Application Configuration', [])|length }}</span>
                        </div>
                    </div>
                </div>

                <div class="col-md-6 mb-3">
                    <div class="secret-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="secret-name">Feature Controls</div>
                                <div class="config-description">Feature flags and toggle configurations</div>
                                <span class="config-status status-enabled">Active</span>
                            </div>
                            <span class="category-badge">{{ secrets_by_category.get('Feature Controls', [])|length }}</span>
                        </div>
                    </div>
                </div>

                <div class="col-md-6 mb-3">
                    <div class="secret-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="secret-name">Critical Secrets</div>
                                <div class="config-description">High-security environment-only configurations</div>
                                <span class="config-status status-enabled">Active</span>
                            </div>
                            <span class="category-badge">{{ secrets_by_category.get('Critical Secrets (Environment Only)', [])|length }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
    .category-application-configuration .category-header { border-left: 4px solid #6f42c1; }
    .category-feature-controls .category-header { border-left: 4px solid #20c997; }
    .category-critical-secrets-environment-only .category-header { border-left: 4px solid #dc3545; }

    .category-title {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin: 0;
        font-size: 1.1rem;
        font-weight: 600;
        color: #2d3748;
    }

    .category-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        margin-right: 1rem;
        font-size: 1.1rem;
    }

    .category-external-apis .category-icon { background: var(--info-gradient); }
    .category-application-configuration .category-icon { background: var(--primary-gradient); }
    .category-feature-controls .category-icon { background: var(--success-gradient); }
    .category-critical-secrets-environment-only .category-icon { background: var(--danger-gradient); }

    .category-badge {
        background: var(--primary-gradient);
        color: white;
        border-radius: 12px;
        padding: 0.4rem 0.8rem;
        font-size: 0.85rem;
        font-weight: 600;
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
    }

    /* Enhanced Secret Items */
    .secret-item {
        background: #fbfcfd;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        padding: 1.25rem;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
        position: relative;
    }

    .secret-item:hover {
        background: white;
        border-color: #667eea;
        box-shadow: 0 4px 20px rgba(102, 126, 234, 0.1);
        transform: translateX(4px);
    }

    .secret-name {
        font-weight: 600;
        color: #2d3748;
        font-size: 1rem;
        margin-bottom: 0.25rem;
    }

    .secret-description {
        color: #718096;
        font-size: 0.875rem;
        margin-bottom: 1rem;
    }

    .secret-value-container {
        position: relative;
    }

    .secret-input {
        background: white;
        border: 2px solid #e2e8f0;
        border-radius: 10px;
        padding: 0.75rem 1rem;
        font-family: 'SF Mono', 'Monaco', 'Inconsolata', monospace;
        font-size: 0.875rem;
        transition: all 0.3s ease;
    }

    .secret-input:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .secret-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 1rem;
    }

    .action-btn {
        border-radius: 8px;
        padding: 0.5rem 1rem;
        font-weight: 500;
        border: none;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .action-btn:hover {
        transform: translateY(-2px);
    }

    .btn-edit {
        background: var(--info-gradient);
        color: white;
    }

    .btn-delete {
        background: var(--danger-gradient);
        color: white;
    }

    .btn-save {
        background: var(--success-gradient);
        color: white;
    }

    .btn-cancel {
        background: #e2e8f0;
        color: #4a5568;
    }

    /* Enhanced Empty State */
    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        color: #718096;
    }

    .empty-state-icon {
        font-size: 4rem;
        margin-bottom: 1.5rem;
        color: #cbd5e0;
    }

    .empty-state h4 {
        color: #4a5568;
        margin-bottom: 1rem;
        font-weight: 600;
    }

    .empty-state p {
        margin-bottom: 2rem;
        font-size: 1.1rem;
    }

    /* Action Button Group */
    .action-buttons {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
        flex-wrap: wrap;
    }

    .action-button {
        background: white;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        padding: 0.75rem 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.3s ease;
        text-decoration: none;
        color: #4a5568;
        font-weight: 600;
    }

    .action-button:hover {
        border-color: #667eea;
        background: #667eea;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .action-button.primary {
        background: var(--primary-gradient);
        border-color: transparent;
        color: white;
    }

    .action-button.success {
        background: var(--success-gradient);
        border-color: transparent;
        color: white;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .secrets-management-container {
            padding: 1rem 0;
        }
        
        .page-header-gradient {
            padding: 1.5rem;
        }
        
        .stats-overview {
            margin-top: 1rem;
        }
        
        .stat-number {
            font-size: 2rem;
        }
        
        .action-buttons {
            flex-direction: column;
        }
        
        .secret-item {
            padding: 1rem;
        }
        
        .secret-actions {
            flex-direction: column;
        }
    }

    /* Animation for page load */
    .fade-in {
        animation: fadeInUp 0.6s ease forwards;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Loading states */
    .loading {
        position: relative;
        pointer-events: none;
        opacity: 0.6;
    }

    .loading::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 20px;
        height: 20px;
        border: 2px solid #667eea;
        border-top: 2px solid transparent;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        from { transform: translate(-50%, -50%) rotate(0deg); }
        to { transform: translate(-50%, -50%) rotate(360deg); }
    }
</style>
{% endblock %}
        border-radius: 6px;
        padding: 12px;
        margin-bottom: 8px;
        font-family: 'Courier New', monospace;
        font-size: 0.9rem;
    }
    
    .audit-log {
        max-height: 300px;
        overflow-y: auto;
        background: #f8f9fa;
        border-radius: 6px;
        padding: 15px;
    }
    
    .log-entry {
        padding: 8px 12px;
        border-left: 3px solid #007bff;
        margin-bottom: 8px;
        background: white;
        border-radius: 4px;
        font-size: 0.85rem;
    }
    
    .log-list_secrets { border-left-color: #17a2b8; }
    .log-read_db { border-left-color: #28a745; }
    .log-create { border-left-color: #ffc107; }
    .log-update { border-left-color: #fd7e14; }
    .log-delete { border-left-color: #dc3545; }
    
    .btn-group-sm .btn {
        margin-right: 5px;
        margin-bottom: 5px;
    }
    
    .security-notice {
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        color: white;
        border: none;
    }

    .nav-tabs .nav-link {
        border-radius: 8px 8px 0 0;
        border: none;
        background-color: #f8f9fa;
        color: #6c757d;
        margin-right: 5px;
    }

    .nav-tabs .nav-link.active {
        background-color: #007bff;
        color: white;
        border: none;
    }

    .nav-tabs .nav-link:hover {
        background-color: #e9ecef;
        border: none;
    }

    .nav-tabs .nav-link.active:hover {
        background-color: #0056b3;
        color: white;
    }

    .tab-content {
        border: 1px solid #dee2e6;
        border-top: none;
        border-radius: 0 0 8px 8px;
        background-color: #fff;
        padding: 20px;
    }

    .config-group {
        border-left: 3px solid #007bff;
        padding-left: 15px;
        background-color: #f8f9fa;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 15px;
    }
    
    .config-item {
        transition: all 0.3s ease;
    }
    
    .config-item:hover {
        background-color: #fff;
        border-radius: 5px;
        padding: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .smtp-status-badge {
        font-size: 0.75em;
        padding: 0.25em 0.5em;
    }
</style>
        <style>
            .spin {
                animation: spin 1s linear infinite;
            }
            
            @keyframes spin {
                from { transform: rotate(0deg); }
                to { transform: rotate(360deg); }
            }
{% block content %}
<div class="secrets-management-container">
    <div class="container-fluid">
        <!-- Enhanced Page Header -->
        <div class="page-header-card fade-in">
            <div class="page-header-gradient">
                <div class="page-header-content">
                    <div class="row align-items-center">
                        <div class="col-lg-8">
                            <h1 class="mb-2">
                                <i class="bi bi-shield-lock me-3"></i>
                                Enhanced Secrets Management
                            </h1>
                            <p class="mb-0 opacity-90">
                                Comprehensive configuration management for application settings, SMTP, ServiceNow integration, and feature controls
                            </p>
                        </div>
                        <div class="col-lg-4 text-lg-end">
                            <span class="badge bg-danger bg-gradient fs-6 px-3 py-2">
                                <i class="bi bi-shield-exclamation me-1"></i>
                                Super Admin Only
                            </span>
                        </div>
                    </div>
                    
                    <!-- Enhanced Stats Overview -->
                    <div class="stats-overview">
                        <div class="row text-center">
                            <div class="col-6 col-md-3">
                                <div class="stat-item">
                                    <span class="stat-number">{{ total_secrets|default(10) }}</span>
                                    <div class="stat-label">Total Secrets</div>
                                </div>
                            </div>
                            <div class="col-6 col-md-3">
                                <div class="stat-item">
                                    <span class="stat-number">{{ active_secrets|default(10) }}</span>
                                    <div class="stat-label">Active Secrets</div>
                                </div>
                            </div>
                            <div class="col-6 col-md-3">
                                <div class="stat-item">
                                    <span class="stat-number">{{ categories_count|default(4) }}</span>
                                    <div class="stat-label">Categories</div>
                                </div>
                            </div>
                            <div class="col-6 col-md-3">
                                <div class="stat-item">
                                    <span class="stat-number">{{ last_updated|default("7:33:57 pm") }}</span>
                                    <div class="stat-label">Last Updated</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enhanced Navigation Tabs -->
        <div class="nav-tabs-container fade-in">
            <ul class="nav nav-tabs" id="secretsTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="secrets-tab" data-bs-toggle="tab" data-bs-target="#secrets" type="button" role="tab">
                        <i class="bi bi-key me-2"></i>
                        Application Secrets
                        <span class="badge bg-white text-primary">{{ total_secrets|default(10) }}</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="smtp-tab" data-bs-toggle="tab" data-bs-target="#smtp" type="button" role="tab">
                        <i class="bi bi-envelope me-2"></i>
                        SMTP Configuration
                        {% if smtp_configured %}
                            <span class="badge bg-success">CONFIGURED</span>
                        {% else %}
                            <span class="badge bg-warning">NOT CONFIGURED</span>
                        {% endif %}
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="servicenow-tab" data-bs-toggle="tab" data-bs-target="#servicenow" type="button" role="tab">
                        <i class="bi bi-diagram-3 me-2"></i>
                        ServiceNow Integration
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="audit-tab" data-bs-toggle="tab" data-bs-target="#audit" type="button" role="tab">
                        <i class="bi bi-activity me-2"></i>
                        Audit Log
                    </button>
                </li>
            </ul>
        </div>

        <!-- Enhanced Tab Content -->
        <div class="tab-content" id="secretsTabContent">
            <!-- Application Secrets Tab -->
            <div class="tab-pane fade show active" id="secrets" role="tabpanel">
                <div class="content-card fade-in">
                    <div class="card-body p-4">
                        <!-- Action Buttons -->
                        <div class="action-buttons">
                            <button type="button" class="action-button primary" onclick="showAddSecretModal()">
                                <i class="bi bi-plus-circle"></i>
                                Add New Secret
                            </button>
                            <button type="button" class="action-button" onclick="location.reload()">
                                <i class="bi bi-arrow-clockwise"></i>
                                Refresh All
                            </button>
                            <button type="button" class="action-button" onclick="exportSecrets()">
                                <i class="bi bi-download"></i>
                                Export Config
                            </button>
                            <button type="button" class="action-button" onclick="viewAuditLog()">
                                <i class="bi bi-activity"></i>
                                View Audit Log
                            </button>
                        </div>

                        <!-- Enhanced Secrets Categories -->
                        <div class="secrets-categories">
                            {% if secrets_by_category %}
                                {% for category, secrets in secrets_by_category.items() %}
                                <div class="category-card category-{{ category.lower().replace(' ', '-').replace('(', '').replace(')', '') }}">
                                    <div class="category-header">
                                        <div class="category-title">
                                            <div class="d-flex align-items-center">
                                                <div class="category-icon">
                                                    {% if category == 'External APIs' %}
                                                        <i class="bi bi-globe"></i>
                                                    {% elif category == 'Application Configuration' %}
                                                        <i class="bi bi-gear"></i>
                                                    {% elif category == 'Feature Controls' %}
                                                        <i class="bi bi-toggles"></i>
                                                    {% elif category == 'Critical Secrets (Environment Only)' %}
                                                        <i class="bi bi-shield-lock-fill"></i>
                                                    {% else %}
                                                        <i class="bi bi-key"></i>
                                                    {% endif %}
                                                </div>
                                                <div>
                                                    <h6 class="mb-0">{{ category }}</h6>
                                                    <small class="text-muted">{{ secrets|length if secrets else 0 }} items configured</small>
                                                </div>
                                            </div>
                                            <span class="category-badge">{{ secrets|length if secrets else 0 }}</span>
                                        </div>
                                    </div>
                                    
                                    <div class="card-body">
                                        {% if secrets and secrets|length > 0 %}
                                            {% for secret in secrets %}
                                            <div class="secret-item" id="secret-item-{{ secret.key_name }}">
                                                <div class="secret-name">{{ secret.key_name }}</div>
                                                {% if secret.get('description') %}
                                                <div class="secret-description">{{ secret['description'] }}</div>
                                                {% endif %}
                                                
                                                <div class="secret-value-container">
                                                    <div class="input-group">
                                                        <input type="password" 
                                                               class="form-control secret-input" 
                                                               id="secret_{{ secret.key_name }}" 
                                                               value="{{ secret['value'] if secret.get('value') else '' }}" 
                                                               readonly>
                                                        <button class="btn btn-outline-secondary" 
                                                                type="button" 
                                                                onclick="togglePasswordVisibility('secret_{{ secret.key_name }}')">
                                                            <i class="bi bi-eye" id="secret_{{ secret.key_name }}_icon"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                                
                                                <div class="secret-actions">
                                                    <button class="action-btn btn-edit" onclick="editSecret('{{ secret.key_name }}')">
                                                        <i class="bi bi-pencil"></i>
                                                        Edit
                                                    </button>
                                                    <button class="action-btn btn-delete" onclick="deleteSecret('{{ secret.key_name }}')">
                                                        <i class="bi bi-trash"></i>
                                                        Delete
                                                    </button>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        {% else %}
                                            <div class="empty-state">
                                                <div class="empty-state-icon">
                                                    <i class="bi bi-inbox"></i>
                                                </div>
                                                <h4>No secrets in this category</h4>
                                                <p>Start by adding your first secret to the {{ category }} category</p>
                                                <button class="action-button primary" onclick="showAddSecretModal('{{ category }}')">
                                                    <i class="bi bi-plus"></i>
                                                    Add First Secret
                                                </button>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="empty-state">
                                    <div class="empty-state-icon">
                                        <i class="bi bi-shield-lock"></i>
                                    </div>
                                    <h4>No Secrets Found</h4>
                                    <p>Start by adding your first application secret to begin managing your configuration</p>
                                    <button class="action-button primary" onclick="showAddSecretModal()">
                                        <i class="bi bi-plus-circle"></i>
                                        Add Your First Secret
                                    </button>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- SMTP Configuration Tab -->
            <div class="tab-pane fade" id="smtp" role="tabpanel">
                <div class="content-card fade-in">
                    <div class="card-body p-4">
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="config-group">
                                    <h6 class="text-primary mb-3">
                                        <i class="bi bi-info-circle me-2"></i>Configuration Status
                                    </h6>
                                    {% if smtp_configured %}
                                        <div class="d-flex align-items-center p-3 bg-success bg-gradient rounded">
                                            <i class="bi bi-check-circle-fill text-white me-2 fs-4"></i>
                                            <div class="text-white">
                                                <div class="fw-bold">SMTP Configured</div>
                                                <small>Email services are active and ready</small>
                                            </div>
                                        </div>
                                    {% else %}
                                        <div class="d-flex align-items-center p-3 bg-warning bg-gradient rounded">
                                            <i class="bi bi-exclamation-triangle-fill text-white me-2 fs-4"></i>
                                            <div class="text-white">
                                                <div class="fw-bold">SMTP Not Configured</div>
                                                <small>Email services are currently disabled</small>
                                            </div>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="config-group">
                                    <h6 class="text-primary mb-3">
                                        <i class="bi bi-tools me-2"></i>Quick Actions
                                    </h6>
                                    <div class="d-flex flex-wrap gap-2">
                                        <button type="button" class="action-button" id="editSMTPBtn" onclick="toggleSMTPEdit()">
                                            <i class="bi bi-pencil"></i>
                                            Edit Configuration
                                        </button>
                                        <button type="button" class="action-button success" onclick="testSMTPConnection()">
                                            <i class="bi bi-envelope-check"></i>
                                            Test Connection
                                        </button>
                                        <button type="button" class="action-button" onclick="loadSMTPConfigs()">
                                            <i class="bi bi-arrow-clockwise"></i>
                                            Refresh
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Enhanced SMTP Configuration Form -->
                        <form id="smtpConfigForm">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="config-group">
                                        <h6 class="text-primary mb-3">
                                            <i class="bi bi-server me-2"></i>Server Settings
                                        </h6>
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">SMTP Server</label>
                                            <input type="text" class="form-control secret-input" id="smtp_server" name="smtp_server" placeholder="smtp.gmail.com" readonly>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">SMTP Port</label>
                                            <input type="number" class="form-control secret-input" id="smtp_port" name="smtp_port" placeholder="587" min="1" max="65535" readonly>
                                        </div>
                                        <div class="row">
                                            <div class="col-6">
                                                <label class="form-label fw-bold">Use TLS</label>
                                                <select class="form-select secret-input" id="smtp_use_tls" name="smtp_use_tls" disabled>
                                                    <option value="true">True</option>
                                                    <option value="false">False</option>
                                                </select>
                                            </div>
                                            <div class="col-6">
                                                <label class="form-label fw-bold">Use SSL</label>
                                                <select class="form-select secret-input" id="smtp_use_ssl" name="smtp_use_ssl" disabled>
                                                    <option value="true">True</option>
                                                    <option value="false">False</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="config-group">
                                        <h6 class="text-primary mb-3">
                                            <i class="bi bi-lock me-2"></i>Authentication & Email Settings
                                        </h6>
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">SMTP Username</label>
                                            <input type="text" class="form-control secret-input" id="smtp_username" name="smtp_username" placeholder="your-email@example.com" readonly>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">SMTP Password</label>
                                            <div class="input-group">
                                                <input type="password" class="form-control secret-input" id="smtp_password" name="smtp_password" placeholder="App password or email password" readonly>
                                                <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('smtp_password')">
                                                    <i class="bi bi-eye" id="smtp_password_icon"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Default Sender Email</label>
                                            <input type="email" class="form-control secret-input" id="mail_default_sender" name="mail_default_sender" placeholder="noreply@yourcompany.com" readonly>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Team Email</label>
                                            <input type="email" class="form-control secret-input" id="team_email" name="team_email" placeholder="team@yourcompany.com" readonly>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="text-center mt-4" id="smtpSaveButtons" style="display: none;">
                                <button type="button" class="action-btn btn-save me-2" onclick="saveSMTPConfig()">
                                    <i class="bi bi-check-circle"></i>
                                    Save Configuration
                                </button>
                                <button type="button" class="action-btn btn-cancel" onclick="cancelSMTPEdit()">
                                    <i class="bi bi-x-circle"></i>
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
                                            <label class="form-label fw-bold">SMTP Username</label>
                                            <input type="text" class="form-control" id="smtp_username" name="smtp_username" placeholder="your-email@domain.com" readonly>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">SMTP Password</label>
                                            <div class="input-group">
                                                <input type="password" class="form-control" id="smtp_password" name="smtp_password" placeholder="Enter password" readonly>
                                                <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('smtp_password')">
                                                    <i class="bi bi-eye" id="smtp_password_icon"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Default Sender Email</label>
                                            <input type="email" class="form-control" id="mail_default_sender" name="mail_default_sender" placeholder="noreply@yourcompany.com" readonly>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Team Email</label>
                                            <input type="email" class="form-control" id="team_email" name="team_email" placeholder="team@yourcompany.com" readonly>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Enable SMTP</label>
                                            <select class="form-select" id="smtp_enabled" name="smtp_enabled" disabled>
                                                <option value="false">Disabled</option>
                                                <option value="true">Enabled</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row mt-4">
                                <div class="col-12">
                                    <div class="d-flex justify-content-end">
                                        <button type="button" class="btn btn-outline-secondary me-2" onclick="resetSMTPForm()">
                                            <i class="bi bi-arrow-counterclockwise me-1"></i>Reset
                                        </button>
                                        <button type="button" class="btn btn-outline-success me-2" onclick="testSMTPConnection()">
                                            <i class="bi bi-envelope-check me-1"></i>Test Connection
                                        </button>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="bi bi-check-circle me-1"></i>Save SMTP Configuration
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>

                    <!-- ServiceNow Configuration Tab -->
                    <div class="tab-pane fade" id="servicenow" role="tabpanel">
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5 class="mb-0">
                                        <i class="bi bi-diagram-3 me-2"></i>ServiceNow Configuration Management
                                    </h5>
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-success" onclick="showAddServiceNowConfigModal()">
                                            <i class="bi bi-plus-circle me-1"></i>Add New Config
                                        </button>
                                        <button type="button" class="btn btn-info" onclick="loadServiceNowConfigs()">
                                            <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ServiceNow Configuration Form -->
                        <form id="servicenowConfigForm">
                            <div class="row">
                                <!-- Server Settings -->
                                <div class="col-md-6">
                                    <div class="config-group">
                                        <h6 class="text-primary mb-3">
                                            <i class="bi bi-server me-2"></i>ServiceNow Instance Settings
                                        </h6>
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Instance URL</label>
                                            <input type="text" class="form-control" id="servicenow_instance" name="servicenow_instance" placeholder="https://your-instance.service-now.com" readonly>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Username</label>
                                            <input type="text" class="form-control" id="servicenow_username" name="servicenow_username" placeholder="ServiceNow username" readonly>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Password</label>
                                            <div class="input-group">
                                                <input type="password" class="form-control" id="servicenow_password" name="servicenow_password" placeholder="ServiceNow password" readonly>
                                                <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('servicenow_password')">
                                                    <i class="bi bi-eye" id="servicenow_password_icon"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Additional Settings -->
                                <div class="col-md-6">
                                    <div class="config-group">
                                        <h6 class="text-primary mb-3">
                                            <i class="bi bi-gear me-2"></i>Additional Settings
                                        </h6>
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">API Version</label>
                                            <input type="text" class="form-control" id="servicenow_api_version" name="servicenow_api_version" placeholder="v1" readonly>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Timeout (seconds)</label>
                                            <input type="number" class="form-control" id="servicenow_timeout" name="servicenow_timeout" placeholder="30" readonly>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Enable ServiceNow</label>
                                            <select class="form-select" id="servicenow_enabled" name="servicenow_enabled" disabled>
                                                <option value="false">Disabled</option>
                                                <option value="true">Enabled</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row mt-4">
                                <div class="col-12">
                                    <div class="d-flex justify-content-end">
                                        <button type="button" class="btn btn-primary me-2" id="editServiceNowBtn" onclick="toggleServiceNowEdit()">
                                            <i class="bi bi-pencil"></i> Edit Configuration
                                        </button>
                                        <button type="button" class="btn btn-outline-success me-2" onclick="testServiceNowConnection()">
                                            <i class="bi bi-check-circle me-1"></i>Test Connection
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="resetServiceNowForm()">
                                            <i class="bi bi-arrow-counterclockwise me-1"></i>Reset
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Secret Modal -->
<div class="modal fade" id="secretModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="secretModalTitle">Add New Secret</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="secretForm">
                    <div class="mb-3">
                        <label class="form-label">Secret Name</label>
                        <input type="text" class="form-control" id="secretName" name="key_name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Secret Value</label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="secretValue" name="value" required>
                            <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('secretValue')">
                                <i class="bi bi-eye" id="secretValue_icon"></i>
                            </button>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Category</label>
                        <select class="form-select" id="secretCategory" name="category" required>
                            <option value="">Select category...</option>
                            <option value="External APIs">External APIs</option>
                            <option value="Application Configuration">Application Configuration</option>
                            <option value="Feature Controls">Feature Controls</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="secretDescription" name="description" rows="3"></textarea>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="requiresRestart" name="requires_restart">
                        <label class="form-check-label" for="requiresRestart">
                            Requires application restart when changed
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveSecret()">Save Secret</button>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <div class="mt-2">Processing...</div>
            </div>
        </div>
    </div>
</div>

<script>
// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    initializePage();
    loadSMTPConfigs();
    loadServiceNowConfigs();
});

function initializePage() {
    // Initialize all SMTP fields to read-only mode
    const smtpFields = ['smtp_server', 'smtp_port', 'smtp_use_tls', 'smtp_use_ssl', 'smtp_username', 'smtp_password', 'mail_default_sender', 'team_email', 'smtp_enabled'];
    smtpFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.readOnly = true;
            if (field.tagName === 'SELECT') {
                field.disabled = true;
            }
        }
    });
    
    // Initialize all ServiceNow fields to read-only mode
    const servicenowFields = ['servicenow_instance', 'servicenow_username', 'servicenow_password', 'servicenow_api_version', 'servicenow_timeout', 'servicenow_enabled'];
    servicenowFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.readOnly = true;
            if (field.tagName === 'SELECT') {
                field.disabled = true;
            }
        }
    });
    
    // Ensure all edit buttons are in correct initial state
    const editBtn = document.getElementById('editSMTPBtn');
    if (editBtn) {
        editBtn.innerHTML = '<i class="bi bi-pencil"></i> Edit Configuration';
        editBtn.className = 'btn btn-primary';
    }
    
    const serviceNowEditBtn = document.getElementById('editServiceNowBtn');
    if (serviceNowEditBtn) {
        serviceNowEditBtn.innerHTML = '<i class="bi bi-pencil"></i> Edit Configuration';
        serviceNowEditBtn.className = 'btn btn-primary me-2';
    }
}

// SMTP Configuration Management
let currentSMTPConfigs = {};

function loadSMTPConfigs() {
    fetch('/admin/secrets/api/smtp/config')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                currentSMTPConfigs = {};
                data.configs.forEach(config => {
                    currentSMTPConfigs[config.config_key] = config;
                });
                populateSMTPForm();
            } else {
                showAlert('Error loading SMTP configurations: ' + data.error, 'error');
            }
        })
        .catch(error => {
            showAlert('Error loading SMTP configurations: ' + error.message, 'error');
        });
}

function populateSMTPForm() {
    // Ensure all fields start in read-only mode
    const allFields = ['smtp_server', 'smtp_port', 'smtp_use_tls', 'smtp_use_ssl', 'smtp_username', 'smtp_password', 'mail_default_sender', 'team_email', 'smtp_enabled'];
    
    allFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.readOnly = true;
            if (field.tagName === 'SELECT') {
                field.disabled = true;
            }
        }
    });
    
    // Populate values
    Object.keys(currentSMTPConfigs).forEach(key => {
        const input = document.getElementById(key);
        const config = currentSMTPConfigs[key];
        
        if (input) {
            if (config.encrypted && config.config_value === '***ENCRYPTED***') {
                input.placeholder = 'Current value is encrypted';
            } else {
                input.value = config.config_value || '';
            }
            
            // Ensure field remains read-only
            input.readOnly = true;
            if (input.tagName === 'SELECT') {
                input.disabled = true;
            }
        }
    });
    
    // Ensure edit button is in correct state
    const editBtn = document.getElementById('editSMTPBtn');
    if (editBtn) {
        editBtn.innerHTML = '<i class="bi bi-pencil"></i> Edit Configuration';
        editBtn.className = 'btn btn-primary';
    }
}

// ServiceNow Configuration Management
let currentServiceNowConfigs = {};

function loadServiceNowConfigs() {
    // For now, we'll load from the existing secrets system
    // This can be enhanced to have a dedicated ServiceNow config API
    fetch('/admin/secrets/api/secrets')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Filter ServiceNow related secrets
                const servicenowSecrets = data.secrets.filter(secret => 
                    secret.key_name.includes('servicenow') || secret.key_name.includes('SERVICENOW')
                );
                populateServiceNowForm(servicenowSecrets);
            }
        })
        .catch(error => {
            console.log('ServiceNow configs will be loaded when available');
        });
}

function populateServiceNowForm(secrets) {
    secrets.forEach(secret => {
        const key = secret.key_name.toLowerCase();
        let inputId = '';
        
        if (key.includes('instance')) {
            inputId = 'servicenow_instance';
        } else if (key.includes('username')) {
            inputId = 'servicenow_username';
        } else if (key.includes('password')) {
            inputId = 'servicenow_password';
        }
        
        if (inputId) {
            const input = document.getElementById(inputId);
            if (input && secret.value) {
                input.value = secret.value;
            }
        }
    });
}

// Handle SMTP form submission
document.getElementById('smtpConfigForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const configs = [];
    
    for (let [key, value] of formData.entries()) {
        if (value.trim()) {
            const isEncrypted = key === 'smtp_password';
            configs.push({
                config_key: key,
                config_value: value,
                encrypted: isEncrypted,
                description: getSMTPConfigDescription(key)
            });
        }
    }
    
    saveSMTPConfigurations(configs);
});

async function saveSMTPConfigurations(configs) {
    const modal = new bootstrap.Modal(document.getElementById('loadingModal'));
    modal.show();
    
    try {
        for (const config of configs) {
            const response = await fetch('/admin/secrets/api/smtp/config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(config)
            });
            
            const result = await response.json();
            if (!result.success) {
                throw new Error(`Failed to save ${config.config_key}: ${result.error}`);
            }
        }
        
        showAlert('SMTP configuration saved successfully!', 'success');
        loadSMTPConfigs();
        
    } catch (error) {
        showAlert('Error saving SMTP configuration: ' + error.message, 'error');
    } finally {
        modal.hide();
    }
}

function testSMTPConnection() {
    const modal = new bootstrap.Modal(document.getElementById('loadingModal'));
    modal.show();
    
    fetch('/admin/secrets/api/smtp/test', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            modal.hide();
            if (data.success) {
                showAlert('✅ SMTP connection test successful: ' + data.message, 'success');
            } else {
                showAlert('❌ SMTP connection test failed: ' + data.message, 'error');
            }
        })
        .catch(error => {
            modal.hide();
            showAlert('Error testing SMTP connection: ' + error.message, 'error');
        });
}

function initializeSMTPDefaults() {
    if (!confirm('This will create default SMTP configurations. Continue?')) return;
    
    fetch('/admin/secrets/api/smtp/initialize', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert(data.message, 'success');
                loadSMTPConfigs();
            } else {
                showAlert('Error: ' + data.error, 'error');
            }
        })
        .catch(error => {
            showAlert('Error initializing defaults: ' + error.message, 'error');
        });
}

function resetSMTPForm() {
    document.getElementById('smtpConfigForm').reset();
    populateSMTPForm();
    // Reset all fields to readonly
    setAllFieldsReadonly('smtpConfigForm');
}

function resetServiceNowForm() {
    document.getElementById('servicenowConfigForm').reset();
    loadServiceNowConfigs();
    // Reset all fields to readonly
    setAllFieldsReadonly('servicenowConfigForm');
}

// New function to enable editing for specific fields
        function toggleSMTPEdit() {
            const editBtn = document.getElementById('editSMTPBtn');
            const formFields = ['smtp_server', 'smtp_port', 'smtp_use_tls', 'smtp_use_ssl', 'smtp_username', 'smtp_password', 'mail_default_sender', 'team_email', 'smtp_enabled'];
            const isEditing = editBtn.innerHTML.includes('Save');
            
            if (isEditing) {
                // Save configuration
                saveSMTPConfiguration();
            } else {
                // Enable editing
                formFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        field.readOnly = false;
                        field.disabled = false;
                    }
                });
                
                // Update button
                editBtn.innerHTML = '<i class="bi bi-check-circle"></i> Save Configuration';
                editBtn.className = 'btn btn-success';
            }
        }

        function saveSMTPConfiguration() {
            const editBtn = document.getElementById('editSMTPBtn');
            const formData = {
                smtp_server: document.getElementById('smtp_server').value,
                smtp_port: parseInt(document.getElementById('smtp_port').value),
                smtp_use_tls: document.getElementById('smtp_use_tls').value === 'true',
                smtp_use_ssl: document.getElementById('smtp_use_ssl').value === 'true',
                smtp_username: document.getElementById('smtp_username').value,
                smtp_password: document.getElementById('smtp_password').value,
                mail_default_sender: document.getElementById('mail_default_sender').value,
                team_email: document.getElementById('team_email').value,
                smtp_enabled: document.getElementById('smtp_enabled').value === 'true'
            };

            // Show loading
            editBtn.innerHTML = '<i class="bi bi-arrow-clockwise spin"></i> Saving...';
            editBtn.disabled = true;

            fetch('/admin/secrets/api/smtp/config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('SMTP configuration saved successfully!', 'success');
                    
                    // Disable editing
                    const formFields = ['smtp_server', 'smtp_port', 'smtp_use_tls', 'smtp_use_ssl', 'smtp_username', 'smtp_password', 'mail_default_sender', 'team_email', 'smtp_enabled'];
                    formFields.forEach(fieldId => {
                        const field = document.getElementById(fieldId);
                        if (field) {
                            field.readOnly = true;
                            field.disabled = (field.tagName === 'SELECT');
                        }
                    });
                    
                    // Reset button
                    editBtn.innerHTML = '<i class="bi bi-pencil"></i> Edit Configuration';
                    editBtn.className = 'btn btn-primary';
                } else {
                    showAlert('Failed to save SMTP configuration: ' + (data.error || 'Unknown error'), 'danger');
                }
            })
            .catch(error => {
                console.error('Error saving SMTP configuration:', error);
                showAlert('Error saving SMTP configuration: ' + error.message, 'danger');
            })
            .finally(() => {
                editBtn.disabled = false;
            });
        }

        // ServiceNow Configuration Single Edit Functions
        function toggleServiceNowEdit() {
            const editBtn = document.getElementById('editServiceNowBtn');
            const formFields = ['servicenow_instance', 'servicenow_username', 'servicenow_password', 'servicenow_api_version', 'servicenow_timeout', 'servicenow_enabled'];
            const isEditing = editBtn.innerHTML.includes('Save');
            
            if (isEditing) {
                // Save configuration
                saveServiceNowConfiguration();
            } else {
                // Enable editing
                formFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        field.readOnly = false;
                        field.disabled = false;
                    }
                });
                
                // Update button
                editBtn.innerHTML = '<i class="bi bi-check-circle"></i> Save Configuration';
                editBtn.className = 'btn btn-success me-2';
            }
        }

        function saveServiceNowConfiguration() {
            const editBtn = document.getElementById('editServiceNowBtn');
            const formData = {
                servicenow_instance: document.getElementById('servicenow_instance').value,
                servicenow_username: document.getElementById('servicenow_username').value,
                servicenow_password: document.getElementById('servicenow_password').value,
                servicenow_api_version: document.getElementById('servicenow_api_version').value,
                servicenow_timeout: document.getElementById('servicenow_timeout').value,
                servicenow_enabled: document.getElementById('servicenow_enabled').value === 'true'
            };

            // Show loading
            editBtn.innerHTML = '<i class="bi bi-arrow-clockwise spin"></i> Saving...';
            editBtn.disabled = true;

            // For now, we'll save to the secrets system
            // This can be enhanced to have a dedicated ServiceNow config API
            const promises = Object.keys(formData).map(key => {
                return fetch('/admin/secrets/api/secrets', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        key_name: key,
                        value: formData[key],
                        description: `ServiceNow ${key.replace('servicenow_', '').replace('_', ' ')} configuration`,
                        category: 'ServiceNow'
                    })
                });
            });

            Promise.all(promises)
            .then(responses => Promise.all(responses.map(r => r.json())))
            .then(results => {
                const allSuccess = results.every(result => result.success);
                if (allSuccess) {
                    showAlert('ServiceNow configuration saved successfully!', 'success');
                    
                    // Disable editing
                    const formFields = ['servicenow_instance', 'servicenow_username', 'servicenow_password', 'servicenow_api_version', 'servicenow_timeout', 'servicenow_enabled'];
                    formFields.forEach(fieldId => {
                        const field = document.getElementById(fieldId);
                        if (field) {
                            field.readOnly = true;
                            field.disabled = (field.tagName === 'SELECT');
                        }
                    });
                    
                    // Reset button
                    editBtn.innerHTML = '<i class="bi bi-pencil"></i> Edit Configuration';
                    editBtn.className = 'btn btn-primary me-2';
                } else {
                    showAlert('Failed to save some ServiceNow configuration values', 'danger');
                }
            })
            .catch(error => {
                console.error('Error saving ServiceNow configuration:', error);
                showAlert('Error saving ServiceNow configuration: ' + error.message, 'danger');
            })
            .finally(() => {
                editBtn.disabled = false;
            });
        }

        function enableEdit(fieldId) {
    const input = document.getElementById(fieldId);
    if (input) {
        input.removeAttribute('readonly');
        input.removeAttribute('disabled');
        input.focus();
        
        // Change the edit button to a save button temporarily
        const editBtn = input.parentNode.querySelector('button');
        if (editBtn) {
            editBtn.innerHTML = '<i class="bi bi-check"></i> Save';
            editBtn.onclick = () => saveFieldEdit(fieldId);
        }
    }
}

function saveFieldEdit(fieldId) {
    const input = document.getElementById(fieldId);
    if (input) {
        input.setAttribute('readonly', true);
        
        // Change button back to edit
        const editBtn = input.parentNode.querySelector('button');
        if (editBtn) {
            editBtn.innerHTML = '<i class="bi bi-pencil"></i> Edit';
            editBtn.onclick = () => enableEdit(fieldId);
        }
        
        // Here you could add automatic saving logic
        showAlert(`Field ${fieldId} updated locally. Click Save to persist changes.`, 'info');
    }
}

function setAllFieldsReadonly(formId) {
    const form = document.getElementById(formId);
    if (form) {
        const inputs = form.querySelectorAll('input, select');
        inputs.forEach(input => {
            input.setAttribute('readonly', true);
            if (input.tagName === 'SELECT') {
                input.setAttribute('disabled', true);
            }
        });
    }
}

// ServiceNow specific functions
function showAddServiceNowConfigModal() {
    showAlert('ServiceNow configuration management coming soon', 'info');
}

function testServiceNowConnection() {
    const modal = new bootstrap.Modal(document.getElementById('loadingModal'));
    modal.show();
    
    // This would be implemented to test ServiceNow connection
    setTimeout(() => {
        modal.hide();
        showAlert('ServiceNow connection test not yet implemented', 'warning');
    }, 2000);
}

function getSMTPConfigDescription(key) {
    const descriptions = {
        'smtp_server': 'SMTP server hostname (e.g., smtp.gmail.com)',
        'smtp_port': 'SMTP server port (usually 587 for TLS or 465 for SSL)',
        'smtp_use_tls': 'Enable TLS encryption for secure email transmission',
        'smtp_use_ssl': 'Enable SSL encryption (use TLS instead for modern servers)',
        'smtp_username': 'SMTP authentication username (usually your email)',
        'smtp_password': 'SMTP authentication password (encrypted when saved)',
        'mail_default_sender': 'Default sender email address for outgoing emails',
        'mail_reply_to': 'Reply-to email address for email responses',
        'team_email': 'Team email address for internal notifications',
        'smtp_enabled': 'Enable or disable SMTP email functionality globally'
    };
    return descriptions[key] || `Configuration for ${key}`;
}

// Secrets Management Functions
function showAddSecretModal(category = '') {
    document.getElementById('secretModalTitle').textContent = 'Add New Secret';
    document.getElementById('secretForm').reset();
    if (category) {
        document.getElementById('secretCategory').value = category;
    }
    new bootstrap.Modal(document.getElementById('secretModal')).show();
}

function saveSecret() {
    const form = document.getElementById('secretForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    
    fetch('/admin/secrets/api/secrets', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'success');
            bootstrap.Modal.getInstance(document.getElementById('secretModal')).hide();
            location.reload();
        } else {
            showAlert('Error: ' + data.error, 'error');
        }
    })
    .catch(error => {
        showAlert('Error saving secret: ' + error.message, 'error');
    });
}

function editSecret(keyName) {
    // For now, show modal - can be enhanced to inline editing
    showAlert('Use the edit button next to the value field for inline editing', 'info');
}

function deleteSecret(keyName) {
    if (!confirm(`Are you sure you want to delete the secret '${keyName}'?`)) return;
    
    fetch(`/admin/secrets/api/secrets/${keyName}`, { method: 'DELETE' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert(data.message, 'success');
                location.reload();
            } else {
                showAlert('Error: ' + data.error, 'error');
            }
        })
        .catch(error => {
            showAlert('Error deleting secret: ' + error.message, 'error');
        });
}

function exportSecrets() {
    fetch('/admin/secrets/export')
        .then(response => response.blob())
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `secrets_export_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        })
        .catch(error => {
            showAlert('Error exporting secrets: ' + error.message, 'error');
        });
}

// Utility Functions
function togglePasswordVisibility(fieldId) {
    const input = document.getElementById(fieldId);
    const icon = document.getElementById(fieldId + '_icon');
    
    if (input.type === 'password') {
        input.type = 'text';
        icon.className = 'bi bi-eye-slash';
    } else {
        input.type = 'password';
        icon.className = 'bi bi-eye';
    }
}

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const container = document.querySelector('.container-fluid');
    container.insertBefore(alertDiv, container.firstChild);
    
    setTimeout(() => {
        const alert = bootstrap.Alert.getOrCreateInstance(alertDiv);
        alert.close();
    }, 5000);
}
</script>
{% endblock %}