{% extends "base.html" %}

{% block title %}Secrets Management{% endblock %}

{% block content %}
<style>
    body {
        background: #f8f9fa;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    /* Override any potential Bootstrap conflicts */
    .form-row {
        display: grid !important;
        grid-template-columns: 1fr 1fr !important;
        gap: 2rem !important;
        margin-bottom: 1.5rem;
        align-items: start;
        width: 100%;
    }
    
    .form-row.single-column {
        grid-template-columns: 1fr !important;
    }
    
    /* Ensure no flex conflicts */
    .form-row > .form-group {
        display: flex !important;
        flex-direction: column !important;
        width: 100%;
        min-width: 0;
    }
    
    .secrets-container {
        background: #f8f9fa;
        min-height: 100vh;
        padding: 0;
    }
    
    .secrets-header {
        background: #ffffff;
        color: #2c3e50;
        padding: 2rem;
        border-bottom: 1px solid #e9ecef;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .secrets-header h1 {
        margin: 0;
        font-size: 2rem;
        font-weight: 600;
        color: #2c3e50;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    
    .secrets-header p {
        margin: 0.5rem 0 0 0;
        color: #6c757d;
        font-size: 1rem;
        font-weight: 400;
    }
    
    .nav-tabs {
        background: #ffffff;
        border-bottom: 1px solid #dee2e6;
        padding: 0;
        margin: 0;
    }
    
    .nav-tabs .nav-item {
        margin-bottom: 0;
    }
    
    .nav-tabs .nav-link {
        border: none;
        border-bottom: 3px solid transparent;
        color: #6c757d;
        font-weight: 500;
        padding: 1rem 2rem;
        background: transparent;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.2s ease;
    }
    
    .nav-tabs .nav-link:hover {
        color: #0d6efd;
        border-color: transparent;
        background: #f8f9fa;
    }
    
    .nav-tabs .nav-link.active {
        color: #0d6efd;
        background: #ffffff;
        border-bottom-color: #0d6efd;
        font-weight: 600;
    }
    
    .tab-content {
        padding: 2rem;
        background: #f8f9fa;
    }
    
    .config-section {
        background: #ffffff;
        border-radius: 8px;
        border: 1px solid #e9ecef;
        padding: 2rem;
        margin-bottom: 0;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .config-title {
        color: #2c3e50;
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 0.75rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid #e9ecef;
    }
    
    .config-description {
        color: #6c757d;
        font-size: 0.95rem;
        margin-bottom: 2rem;
        font-style: italic;
        line-height: 1.5;
    }
    
    .tab-content {
        padding: 1.5rem;
        background: #f8f9fa;
    }
    
    .tab-pane {
        animation: fadeInUp 0.3s ease;
    }
    
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .advanced-settings {
        margin-top: 2rem;
        padding-top: 1.5rem;
        border-top: 1px solid #e9ecef;
    }
    
    .advanced-toggle {
        background: none;
        border: none;
        color: #6c757d;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
        padding: 0.5rem 0;
        transition: color 0.15s ease;
    }
    
    .advanced-toggle:hover {
        color: #0d6efd;
    }
    
    .connection-status {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        padding: 1.5rem;
        margin-top: 2rem;
        text-align: center;
    }
    
    .status-indicator {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.9rem;
        color: #6c757d;
        margin-bottom: 1rem;
    }
    
    .form-row {
        display: grid !important;
        grid-template-columns: 1fr 1fr !important;
        gap: 2rem !important;
        margin-bottom: 1.5rem;
        align-items: start;
        width: 100%;
    }
    
    .form-row.single-column {
        grid-template-columns: 1fr !important;
    }
    
    .form-group {
        display: flex !important;
        flex-direction: column !important;
        width: 100%;
        min-width: 0; /* Prevent overflow */
    }
    
    .form-label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        min-height: 1.2rem;
        flex-shrink: 0;
    }
    
    .form-control, .form-select {
        padding: 0.75rem 1rem;
        border: 1px solid #ced4da;
        border-radius: 6px;
        background: #ffffff;
        color: #495057;
        font-size: 0.9rem;
        transition: all 0.15s ease;
        width: 100%;
        min-height: 2.75rem;
        box-sizing: border-box;
        display: block;
    }
    
    .form-control:focus, .form-select:focus {
        outline: none;
        border-color: #86b7fe;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }
    
    .form-control[readonly] {
        background: #e9ecef;
        opacity: 1;
        color: #6c757d;
    }
    
    .form-control::placeholder {
        color: #6c757d;
        opacity: 0.7;
    }
    
    .form-help {
        font-size: 0.8rem;
        color: #6c757d;
        margin-top: 0.5rem;
        line-height: 1.4;
    }
    
    .form-select {
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m1 6 7 7 7-7'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right 0.75rem center;
        background-size: 16px 12px;
        padding-right: 2.5rem;
        appearance: none;
    }
    
    .form-select[disabled] {
        background-color: #e9ecef;
        opacity: 1;
    }
    
    @media (max-width: 576px) {
        .form-row {
            grid-template-columns: 1fr !important;
            gap: 1rem !important;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
    }
    
    /* Ensure grid works on all larger screens */
    @media (min-width: 577px) {
        .form-row:not(.single-column) {
            grid-template-columns: 1fr 1fr !important;
        }
    }
    
    .btn-group {
        display: flex;
        gap: 1rem;
        margin-top: 2rem;
        padding-top: 1.5rem;
        border-top: 1px solid #e9ecef;
        align-items: center;
        flex-wrap: wrap;
    }
    
    .btn {
        padding: 0.75rem 1.5rem;
        border-radius: 6px;
        font-weight: 500;
        font-size: 0.9rem;
        border: none;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.15s ease;
        text-decoration: none;
        line-height: 1.5;
        min-height: 2.5rem;
        white-space: nowrap;
    }
    
    .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .btn:active {
        transform: translateY(0);
    }
    
    .btn-primary {
        background: #0d6efd;
        color: white;
        border: 1px solid #0d6efd;
    }
    
    .btn-primary:hover {
        background: #0b5ed7;
        border-color: #0a58ca;
    }
    
    .btn-success {
        background: #198754;
        color: white;
        border: 1px solid #198754;
    }
    
    .btn-success:hover {
        background: #157347;
        border-color: #146c43;
    }
    
    .btn-outline-secondary {
        background: transparent;
        color: #6c757d;
        border: 1px solid #6c757d;
    }
    
    .btn-outline-secondary:hover {
        background: #6c757d;
        color: white;
        border-color: #6c757d;
    }
    
    .btn i {
        font-size: 0.9rem;
    }
    
    .advanced-settings {
        margin-top: 2rem;
        padding-top: 1.5rem;
        border-top: 1px solid #e9ecef;
    }
    
    .advanced-toggle {
        background: none;
        border: none;
        color: #6c757d;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
        padding: 0;
    }
    
    .advanced-toggle:hover {
        color: #0d6efd;
    }
    
    .connection-status {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 4px;
        padding: 1rem;
        margin-top: 1rem;
        text-align: center;
    }
    
    .status-indicator {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.9rem;
        color: #6c757d;
    }

    .config-subsection {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        padding: 1.5rem;
        margin: 2rem 0;
        border-left: 4px solid #0d6efd;
    }
    
    .subsection-title {
        color: #495057;
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .subsection-description {
        color: #6c757d;
        font-size: 0.85rem;
        margin-bottom: 1.5rem;
        font-style: italic;
    }

</style>

<div class="secrets-container">
    <div class="secrets-header">
        <h1><i class="fas fa-shield-alt"></i> Secrets Management</h1>
        <p>Configure your application settings, SMTP, and ServiceNow integrations</p>
    </div>

    <ul class="nav nav-tabs" role="tablist">
        <li class="nav-item">
            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#smtp">
                <i class="fas fa-envelope"></i> SMTP Email
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#emailrecipients">
                <i class="fas fa-users"></i> Email Recipients
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#servicenow">
                <i class="fas fa-cogs"></i> ServiceNow
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#application">
                <i class="fas fa-server"></i> Application
            </button>
        </li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="smtp">
            <div class="config-section">
                <h2 class="config-title"><i class="fas fa-envelope"></i> SMTP Email Configuration</h2>
                <p class="config-description">Configure your email server settings to enable notifications and alerts throughout the application.</p>
                
                <form id="smtpConfigForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-server"></i> SMTP Server</label>
                            <input type="text" class="form-control" id="smtp_server" 
                                   placeholder="smtp.gmail.com" readonly>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-plug"></i> Port</label>
                            <input type="number" class="form-control" id="smtp_port" 
                                   placeholder="587" readonly>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-user"></i> Username</label>
                            <input type="email" class="form-control" id="smtp_username" 
                                   placeholder="your-email@company.com" readonly>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-key"></i> Password</label>
                            <input type="password" class="form-control" id="smtp_password" 
                                   placeholder="••••••••••••••••" readonly>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-shield-alt"></i> Security</label>
                            <select class="form-select" id="smtp_security" disabled>
                                <option>TLS/STARTTLS</option>
                                <option>SSL</option>
                                <option>None</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-paper-plane"></i> From Address</label>
                            <input type="email" class="form-control" id="smtp_from" 
                                   placeholder="noreply@company.com" readonly>
                        </div>
                    </div>
                    
                    <div class="btn-group">
                        <button type="button" class="btn btn-primary" onclick="editSMTP()">
                            <i class="fas fa-edit"></i> Edit Configuration
                        </button>
                        <button type="button" class="btn btn-success" onclick="testSMTP()">
                            <i class="fas fa-vial"></i> Test Connection
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div class="tab-pane fade" id="emailrecipients">
            <div class="config-section">
                <h2 class="config-title"><i class="fas fa-users"></i> Email Recipients Configuration</h2>
                <p class="config-description">Configure recipient lists for shift handover notifications and priority alerts.</p>
                
                <form id="emailRecipientsConfigForm">
                    <div class="form-row single-column">
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-envelope-open"></i> Handover Email Recipients</label>
                            <textarea class="form-control" id="handover_email_recipients" rows="3" 
                                     placeholder="email1@company.com, email2@company.com, team-lead@company.com" readonly></textarea>
                            <small class="form-help">Comma-separated email addresses for shift handover notifications</small>
                        </div>
                    </div>
                    
                    <div class="form-row single-column">
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-bell"></i> Priority Alert Recipients</label>
                            <textarea class="form-control" id="priority_alert_recipients" rows="2" 
                                     placeholder="manager@company.com, on-call@company.com" readonly></textarea>
                            <small class="form-help">Email addresses for high-priority incident alerts</small>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-toggle-on"></i> Email Notifications</label>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="email_notifications_enabled" checked 
                                       onchange="toggleEmailNotifications()">
                                <label class="form-check-label" for="email_notifications_enabled">
                                    <span id="emailNotificationStatus">Enabled</span>
                                </label>
                            </div>
                            <small class="form-help">Enable/disable email notifications for handovers</small>
                        </div>
                        
                        <div class="form-group">
                            <!-- Empty space for better alignment -->
                        </div>
                    </div>
                    
                    <div class="btn-group">
                        <button type="button" class="btn btn-primary" onclick="editEmailRecipients()">
                            <i class="fas fa-edit"></i> Edit Recipients
                        </button>
                        <button type="button" class="btn btn-success" onclick="testEmailRecipients()">
                            <i class="fas fa-paper-plane"></i> Test Email Recipients
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="loadEmailRecipients()">
                            <i class="fas fa-sync"></i> Refresh
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div class="tab-pane fade" id="servicenow">
            <div class="config-section">
                <h2 class="config-title"><i class="fas fa-cogs"></i> ServiceNow Integration</h2>
                <p class="config-description">Connect to your ServiceNow instance for automated ticket creation and incident management.</p>
                
                <form id="servicenowConfigForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-link"></i> Instance URL</label>
                            <input type="text" class="form-control" id="servicenow_instance_url" 
                                   placeholder="e.g. yourcompany.service-now.com" readonly>
                            <small class="form-help">Your ServiceNow instance URL (without https://)</small>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-user"></i> Username</label>
                            <input type="text" class="form-control" id="servicenow_username" 
                                   placeholder="admin" readonly>
                            <small class="form-help">ServiceNow API user account</small>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-lock"></i> Password</label>
                            <input type="password" class="form-control" id="servicenow_password" 
                                   placeholder="••••••••" readonly>
                            <small class="form-help">ServiceNow API user password</small>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-table"></i> Default Table</label>
                            <select class="form-select" id="servicenow_table" disabled>
                                <option>incident</option>
                                <option>change_request</option>
                                <option>problem</option>
                                <option>task</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row single-column">
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-users"></i> Assignment Groups</label>
                            <input type="text" class="form-control" id="assignment_groups" 
                                   placeholder="e.g. Supply Chain - L2, Network Team" readonly>
                            <small class="form-help">Comma-separated list of groups to monitor (leave empty for all groups)</small>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-clock"></i> Timeout</label>
                            <input type="number" class="form-control" id="servicenow_timeout" 
                                   placeholder="30" readonly>
                            <small class="form-help">API timeout (seconds)</small>
                        </div>
                        
                        <div class="form-group">
                            <!-- Empty space for better alignment -->
                        </div>
                    </div>
                    
                    <div class="connection-status">
                        <div class="status-indicator">
                            <i class="fas fa-signal"></i> Connection Status
                        </div>
                        <button type="button" class="btn btn-primary mt-2" onclick="testServiceNow()">
                            <i class="fas fa-plug"></i> Test Connection
                        </button>
                    </div>
                    
                    <div class="advanced-settings">
                        <button type="button" class="advanced-toggle" onclick="toggleAdvanced('servicenow')">
                            <i class="fas fa-cog"></i> Advanced Settings
                            <i class="fas fa-chevron-down"></i>
                        </button>
                        <div id="servicenow-advanced" style="display: none; margin-top: 1rem;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label"><i class="fas fa-sync-alt"></i> Sync Interval</label>
                                    <select class="form-select" id="servicenow_sync" disabled>
                                        <option>Every 5 minutes</option>
                                        <option>Every 15 minutes</option>
                                        <option>Every 30 minutes</option>
                                        <option>Every hour</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="btn-group">
                        <button type="button" class="btn btn-primary" onclick="editServiceNow()">
                            <i class="fas fa-edit"></i> Edit Configuration
                        </button>
                        <button type="button" class="btn btn-success" onclick="saveServiceNow()">
                            <i class="fas fa-save"></i> Save ServiceNow Settings
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="clearServiceNow()">
                            <i class="fas fa-times"></i> Clear Settings
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div class="tab-pane fade" id="application">
            <div class="config-section">
                <h2 class="config-title"><i class="fas fa-server"></i> Application Settings</h2>
                <p class="config-description">Core application configuration including database connectivity and security settings.</p>
                
                <form id="applicationConfigForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-database"></i> Database URL</label>
                            <input type="text" class="form-control" id="database_url" 
                                   placeholder="postgresql://user:password@localhost:5432/dbname" readonly>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-key"></i> Secret Key</label>
                            <input type="password" class="form-control" id="secret_key" 
                                   placeholder="••••••••••••••••••••••••••••••••" readonly>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-toggle-on"></i> Debug Mode</label>
                            <select class="form-select" id="debug_mode" disabled>
                                <option>Disabled (Production)</option>
                                <option>Enabled (Development)</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-clock"></i> Session Timeout</label>
                            <input type="number" class="form-control" id="session_timeout" 
                                   value="{{ app_config.session_timeout if app_config else '3600' }}" readonly>
                            <small class="form-help">Timeout in seconds</small>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-file-alt"></i> Log Level</label>
                            <select class="form-select" id="log_level" disabled>
                                <option {% if (app_config.log_level if app_config else 'INFO') == 'INFO' %}selected{% endif %}>INFO</option>
                                <option {% if (app_config.log_level if app_config else 'INFO') == 'DEBUG' %}selected{% endif %}>DEBUG</option>
                                <option {% if (app_config.log_level if app_config else 'INFO') == 'WARNING' %}selected{% endif %}>WARNING</option>
                                <option {% if (app_config.log_level if app_config else 'INFO') == 'ERROR' %}selected{% endif %}>ERROR</option>
                            </select>
                        </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-chart-line"></i> Max Workers</label>
                            <input type="number" class="form-control" id="max_workers" 
                                   value="{{ app_config.max_workers if app_config else '4' }}" readonly>
                        </div>
                    </div>
                    
                    <!-- Shift Timing Configuration -->
                    <div class="config-subsection">
                        <h5 class="subsection-title">
                            <i class="fas fa-clock text-primary"></i> Shift Timing Configuration
                        </h5>
                        <p class="subsection-description">Configure shift start and end times for your organization</p>
                        
                        <!-- Timezone Configuration -->
                        <div class="form-row single-column">
                            <div class="form-group">
                                <label class="form-label"><i class="fas fa-globe text-info"></i> Application Timezone</label>
                                <select class="form-select" id="app_timezone" disabled>
                                    {% set selected_timezone = app_config.app_timezone if app_config else 'Asia/Kolkata' %}
                                    <option value="Asia/Kolkata" {% if selected_timezone == 'Asia/Kolkata' %}selected{% endif %}>Asia/Kolkata (IST)</option>
                                    <option value="UTC" {% if selected_timezone == 'UTC' %}selected{% endif %}>UTC</option>
                                    <option value="America/New_York" {% if selected_timezone == 'America/New_York' %}selected{% endif %}>America/New_York (EST/EDT)</option>
                                    <option value="Europe/London" {% if selected_timezone == 'Europe/London' %}selected{% endif %}>Europe/London (GMT/BST)</option>
                                    <option value="Asia/Singapore" {% if selected_timezone == 'Asia/Singapore' %}selected{% endif %}>Asia/Singapore (SGT)</option>
                                    <option value="Australia/Sydney" {% if selected_timezone == 'Australia/Sydney' %}selected{% endif %}>Australia/Sydney (AEST/AEDT)</option>
                                </select>
                                <small class="form-help">Timezone for all shift calculations and timestamps</small>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-sun text-warning"></i> Day Shift Start Time
                                </label>
                                <input type="time" class="form-control" id="day_shift_start" 
                                       value="{{ app_config.day_shift_start if app_config else '06:30' }}" readonly>
                                <small class="form-help">Morning shift start time</small>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-sun text-warning"></i> Day Shift End Time
                                </label>
                                <input type="time" class="form-control" id="day_shift_end" 
                                       value="{{ app_config.day_shift_end if app_config else '15:30' }}" readonly>
                                <small class="form-help">Morning shift end time</small>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-sunset text-primary"></i> Evening Shift Start Time
                                </label>
                                <input type="time" class="form-control" id="evening_shift_start" 
                                       value="{{ app_config.evening_shift_start if app_config else '14:45' }}" readonly>
                                <small class="form-help">Evening shift start time</small>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-sunset text-primary"></i> Evening Shift End Time
                                </label>
                                <input type="time" class="form-control" id="evening_shift_end" 
                                       value="{{ app_config.evening_shift_end if app_config else '23:45' }}" readonly>
                                <small class="form-help">Evening shift end time</small>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-moon text-dark"></i> Night Shift Start Time
                                </label>
                                <input type="time" class="form-control" id="night_shift_start" 
                                       value="{{ app_config.night_shift_start if app_config else '21:45' }}" readonly>
                                <small class="form-help">Night shift start time</small>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-moon text-dark"></i> Night Shift End Time
                                </label>
                                <input type="time" class="form-control" id="night_shift_end" 
                                       value="{{ app_config.night_shift_end if app_config else '06:45' }}" readonly>
                                <small class="form-help">Night shift end time (next day)</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="btn-group">
                        <button type="button" class="btn btn-primary" onclick="editApplication()">
                            <i class="fas fa-edit"></i> Edit Configuration
                        </button>
                        <button type="button" class="btn btn-success" onclick="testApplication()">
                            <i class="fas fa-vial"></i> Test Settings
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
let isEditingSmtp = false;

function editSMTP() {
    const inputs = document.querySelectorAll('#smtp_server, #smtp_port, #smtp_username, #smtp_password, #smtp_from');
    const select = document.querySelector('#smtp_security');
    const btn = event.target.closest('button');
    
    isEditingSmtp = !isEditingSmtp;
    
    inputs.forEach(input => {
        input.readOnly = !isEditingSmtp;
        input.style.background = isEditingSmtp ? '#ffffff' : '#e9ecef';
    });
    
    select.disabled = !isEditingSmtp;
    
    if (isEditingSmtp) {
        btn.innerHTML = '<i class="fas fa-save"></i> Save Configuration';
        btn.className = 'btn btn-success';
    } else {
        // Save the configuration
        saveSMTPConfig();
        btn.innerHTML = '<i class="fas fa-edit"></i> Edit Configuration';
        btn.className = 'btn btn-primary';
    }
}

function saveSMTPConfig() {
    const config = {
        smtp_server: document.getElementById('smtp_server').value,
        smtp_port: parseInt(document.getElementById('smtp_port').value) || 587,
        smtp_username: document.getElementById('smtp_username').value,
        smtp_password: document.getElementById('smtp_password').value,
        smtp_from: document.getElementById('smtp_from').value,
        smtp_use_tls: document.getElementById('smtp_security').value === 'TLS/STARTTLS',
        smtp_use_ssl: document.getElementById('smtp_security').value === 'SSL'
    };
    
    // Don't send password if it's masked
    if (config.smtp_password === '••••••••••••••••') {
        delete config.smtp_password;
    }
    
    fetch('/admin/secrets/api/smtp', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(config)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('SMTP configuration saved successfully!', 'success');
        } else {
            showAlert('Error saving SMTP configuration: ' + (data.error || 'Unknown error'), 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Error saving SMTP configuration: ' + error.message, 'error');
    });
}

function testSMTP() {
    showAlert('Testing SMTP connection...', 'info');
    
    fetch('/admin/secrets/api/smtp/test', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('✅ SMTP connection successful: ' + data.message, 'success');
        } else {
            showAlert('❌ SMTP connection failed: ' + (data.error || data.message || 'Unknown error'), 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('❌ Error testing SMTP connection: ' + error.message, 'error');
    });
}

let isEditingServiceNow = false;

function editServiceNow() {
    const inputs = document.querySelectorAll('#servicenow_instance_url, #servicenow_username, #servicenow_password, #assignment_groups, #servicenow_timeout');
    const selects = document.querySelectorAll('#servicenow_sync, #servicenow_table');
    const btn = event.target.closest('button');
    
    isEditingServiceNow = !isEditingServiceNow;
    
    inputs.forEach(input => {
        input.readOnly = !isEditingServiceNow;
        input.style.background = isEditingServiceNow ? '#ffffff' : '#e9ecef';
    });
    
    selects.forEach(select => {
        select.disabled = !isEditingServiceNow;
    });
    
    if (isEditingServiceNow) {
        btn.innerHTML = '<i class="fas fa-save"></i> Save Configuration';
        btn.className = 'btn btn-success';
    } else {
        // Save the configuration
        saveServiceNowConfig();
        btn.innerHTML = '<i class="fas fa-edit"></i> Edit Configuration';
        btn.className = 'btn btn-primary';
    }
}

function saveServiceNowConfig() {
    const config = {
        servicenow_instance_url: document.getElementById('servicenow_instance_url').value,
        servicenow_username: document.getElementById('servicenow_username').value,
        servicenow_password: document.getElementById('servicenow_password').value,
        assignment_groups: document.getElementById('assignment_groups').value,
        servicenow_timeout: parseInt(document.getElementById('servicenow_timeout').value) || 30,
        servicenow_table: document.getElementById('servicenow_table').value || 'incident'
    };
    
    // Don't send password if it's masked
    if (config.servicenow_password === '••••••••') {
        delete config.servicenow_password;
    }
    
    fetch('/admin/secrets/api/servicenow', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(config)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('ServiceNow configuration saved successfully!', 'success');
        } else {
            showAlert('Error saving ServiceNow configuration: ' + (data.error || 'Unknown error'), 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Error saving ServiceNow configuration: ' + error.message, 'error');
    });
}

function testServiceNow() {
    showAlert('Testing ServiceNow connection...', 'info');
    
    // Get current form values for test
    const testData = {
        instance_url: document.getElementById('servicenow_instance_url').value,
        username: document.getElementById('servicenow_username').value,
        password: document.getElementById('servicenow_password').value,
        timeout: document.getElementById('servicenow_timeout').value || '30'
    };
    
    // Use FormData for the test endpoint which expects form data
    const formData = new FormData();
    Object.keys(testData).forEach(key => {
        formData.append(key, testData[key]);
    });
    
    fetch('/api/servicenow/test-connection-new', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('✅ ServiceNow connection successful: ' + data.message, 'success');
        } else {
            showAlert('❌ ServiceNow connection failed: ' + (data.error || 'Unknown error'), 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('❌ Error testing ServiceNow connection: ' + error.message, 'error');
    });
}

function saveServiceNow() {
    saveServiceNowConfig();
}

function clearServiceNow() {
    if (confirm('Are you sure you want to clear all ServiceNow settings?')) {
        document.getElementById('servicenow_instance_url').value = '';
        document.getElementById('servicenow_username').value = '';
        document.getElementById('servicenow_password').value = '';
        document.getElementById('assignment_groups').value = '';
        document.getElementById('servicenow_timeout').value = '30';
        showAlert('ServiceNow settings cleared.', 'info');
    }
}

let isEditingApplication = false;

function editApplication() {
    // Toggle readonly state for Application inputs (excluding sensitive fields)
    const inputs = document.querySelectorAll('#session_timeout, #max_workers, #day_shift_start, #day_shift_end, #evening_shift_start, #evening_shift_end, #night_shift_start, #night_shift_end');
    const selects = document.querySelectorAll('#log_level, #app_timezone, #debug_mode');
    const btn = event.target.closest('button');
    
    isEditingApplication = !isEditingApplication;
    
    inputs.forEach(input => {
        input.readOnly = !isEditingApplication;
        input.style.background = isEditingApplication ? '#ffffff' : '#e9ecef';
    });
    
    selects.forEach(select => {
        select.disabled = !isEditingApplication;
    });
    
    if (isEditingApplication) {
        btn.innerHTML = '<i class="fas fa-save"></i> Save Configuration';
        btn.className = 'btn btn-success';
    } else {
        // Save the configuration to database
        saveApplicationConfig();
        btn.innerHTML = '<i class="fas fa-edit"></i> Edit Configuration';
        btn.className = 'btn btn-primary';
    }
}

function saveApplicationConfig() {
    const config = {
        session_timeout: document.getElementById('session_timeout').value,
        max_workers: document.getElementById('max_workers').value,
        log_level: document.getElementById('log_level').value,
        app_timezone: document.getElementById('app_timezone').value,
        day_shift_start: document.getElementById('day_shift_start').value,
        day_shift_end: document.getElementById('day_shift_end').value,
        evening_shift_start: document.getElementById('evening_shift_start').value,
        evening_shift_end: document.getElementById('evening_shift_end').value,
        night_shift_start: document.getElementById('night_shift_start').value,
        night_shift_end: document.getElementById('night_shift_end').value
    };
    
    fetch('/admin/secrets/api/application', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(config)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Application settings saved successfully! Shift timing and timezone configurations have been updated.', 'success');
        } else {
            showAlert('Error saving application settings: ' + (data.error || data.message || 'Unknown error'), 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Error saving application settings: ' + error.message, 'error');
    });
}

function testApplication() {
    showAlert('Testing application settings...', 'info');
    
    // Simply test if we can load the configuration successfully
    fetch('/admin/secrets/api/application')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('✅ Application configuration loaded successfully', 'success');
        } else {
            showAlert('❌ Application configuration test failed: ' + (data.error || 'Unknown error'), 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('❌ Error testing application settings: ' + error.message, 'error');
    });
}

function toggleAdvanced(section) {
    const advancedDiv = document.getElementById(section + '-advanced');
    const toggle = event.target.closest('.advanced-toggle');
    const chevron = toggle.querySelector('.fa-chevron-down, .fa-chevron-up');
    
    if (advancedDiv.style.display === 'none' || !advancedDiv.style.display) {
        advancedDiv.style.display = 'block';
        chevron.className = 'fas fa-chevron-up';
    } else {
        advancedDiv.style.display = 'none';
        chevron.className = 'fas fa-chevron-down';
    }
}

// Utility function for showing alerts
function showAlert(message, type = 'info') {
    // Create alert element
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Add to top of content area
    const contentArea = document.querySelector('.tab-content');
    if (contentArea) {
        contentArea.insertBefore(alertDiv, contentArea.firstChild);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    } else {
        // Fallback to console
        console.log(`${type.toUpperCase()}: ${message}`);
    }
}

// Load SMTP configuration
function loadSMTPConfig() {
    fetch('/admin/secrets/api/smtp')
    .then(response => response.json())
    .then(data => {
        if (data.success && data.config) {
            const config = data.config;
            document.getElementById('smtp_server').value = config.smtp_server || '';
            document.getElementById('smtp_port').value = config.smtp_port || '587';
            document.getElementById('smtp_username').value = config.smtp_username || '';
            document.getElementById('smtp_password').value = config.smtp_password ? '••••••••••••••••' : '';
            document.getElementById('smtp_from').value = config.smtp_from || '';
            
            // Set security type
            if (config.smtp_use_ssl) {
                document.getElementById('smtp_security').value = 'SSL';
            } else if (config.smtp_use_tls) {
                document.getElementById('smtp_security').value = 'TLS/STARTTLS';
            } else {
                document.getElementById('smtp_security').value = 'None';
            }
        }
    })
    .catch(error => {
        console.error('Error loading SMTP config:', error);
    });
}

// Load ServiceNow configuration  
function loadServiceNowConfig() {
    fetch('/admin/secrets/api/servicenow')
    .then(response => response.json())
    .then(data => {
        if (data.success && data.config) {
            const config = data.config;
            document.getElementById('servicenow_instance_url').value = config.servicenow_instance_url || '';
            document.getElementById('servicenow_username').value = config.servicenow_username || '';
            document.getElementById('servicenow_password').value = config.servicenow_password ? '••••••••' : '';
            document.getElementById('assignment_groups').value = config.servicenow_assignment_groups || '';
            document.getElementById('servicenow_timeout').value = config.servicenow_timeout || '30';
        }
    })
    .catch(error => {
        console.error('Error loading ServiceNow config:', error);
    });
}

// Load Application configuration
function loadApplicationConfig() {
    fetch('/admin/secrets/api/application')
    .then(response => response.json())
    .then(data => {
        if (data.success && data.config) {
            const config = data.config;
            document.getElementById('session_timeout').value = config.session_timeout || '3600';
            document.getElementById('max_workers').value = config.max_workers || '4';
            document.getElementById('log_level').value = config.log_level || 'INFO';
            document.getElementById('app_timezone').value = config.app_timezone || 'Asia/Kolkata';
            document.getElementById('day_shift_start').value = config.day_shift_start || '06:30';
            document.getElementById('day_shift_end').value = config.day_shift_end || '15:30';
            document.getElementById('evening_shift_start').value = config.evening_shift_start || '14:45';
            document.getElementById('evening_shift_end').value = config.evening_shift_end || '23:45';
            document.getElementById('night_shift_start').value = config.night_shift_start || '21:45';
            document.getElementById('night_shift_end').value = config.night_shift_end || '06:45';
        }
    })
    .catch(error => {
        console.error('Error loading Application config:', error);
    });
}

// Email Recipients Configuration Functions
let isEditingEmailRecipients = false;

function editEmailRecipients() {
    const handoverField = document.getElementById('handover_email_recipients');
    const priorityField = document.getElementById('priority_alert_recipients');
    const btn = event.target.closest('button');
    
    isEditingEmailRecipients = !isEditingEmailRecipients;
    
    [handoverField, priorityField].forEach(field => {
        field.readOnly = !isEditingEmailRecipients;
        field.style.background = isEditingEmailRecipients ? '#ffffff' : '#e9ecef';
    });
    
    if (isEditingEmailRecipients) {
        btn.innerHTML = '<i class="fas fa-save"></i> Save Recipients';
        btn.className = 'btn btn-success';
        btn.setAttribute('onclick', 'saveEmailRecipients()');
        handoverField.focus();
    } else {
        // Save the configuration
        saveEmailRecipients();
        btn.innerHTML = '<i class="fas fa-edit"></i> Edit Recipients';
        btn.className = 'btn btn-primary';
        btn.setAttribute('onclick', 'editEmailRecipients()');
    }
}

function saveEmailRecipients() {
    const handoverEmails = document.getElementById('handover_email_recipients').value.trim();
    const priorityEmails = document.getElementById('priority_alert_recipients').value.trim();
    
    // Validate email format
    if (handoverEmails && !validateEmailList(handoverEmails)) {
        showAlert('Please enter valid handover email addresses separated by commas', 'error');
        return;
    }
    
    if (priorityEmails && !validateEmailList(priorityEmails)) {
        showAlert('Please enter valid priority alert email addresses separated by commas', 'error');
        return;
    }
    
    // Save to server
    fetch('/admin/secrets/api/email-recipients', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            handover_recipients: handoverEmails,
            priority_recipients: priorityEmails
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Email recipients saved successfully!', 'success');
        } else {
            showAlert('Error saving email recipients: ' + (data.error || 'Unknown error'), 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Error saving email recipients: ' + error.message, 'error');
    });
}

function validateEmailList(emailString) {
    if (!emailString) return true; // Empty is valid
    
    const emails = emailString.split(',').map(email => email.trim()).filter(email => email);
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    
    return emails.every(email => emailRegex.test(email));
}

function loadEmailRecipients() {
    showAlert('Loading email recipients...', 'info');
    
    fetch('/admin/secrets/api/email-recipients')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('handover_email_recipients').value = data.handover_recipients || '';
            document.getElementById('priority_alert_recipients').value = data.priority_recipients || '';
            document.getElementById('email_notifications_enabled').checked = data.notifications_enabled !== false;
            updateEmailNotificationStatus(data.notifications_enabled !== false);
            showAlert('Email recipients loaded successfully', 'success');
        } else {
            showAlert('Error loading email recipients: ' + (data.error || 'Unknown error'), 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Error loading email recipients: ' + error.message, 'error');
    });
}

function toggleEmailNotifications() {
    const checkbox = document.getElementById('email_notifications_enabled');
    const enabled = checkbox.checked;
    
    fetch('/admin/secrets/api/email-notifications', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            enabled: enabled
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateEmailNotificationStatus(enabled);
            showAlert(`Email notifications ${enabled ? 'enabled' : 'disabled'}`, 'success');
        } else {
            // Revert checkbox on error
            checkbox.checked = !enabled;
            showAlert('Error updating notification settings: ' + (data.error || 'Unknown error'), 'error');
        }
    })
    .catch(error => {
        checkbox.checked = !enabled;
        console.error('Error:', error);
        showAlert('Error updating notification settings: ' + error.message, 'error');
    });
}

function updateEmailNotificationStatus(enabled) {
    const statusSpan = document.getElementById('emailNotificationStatus');
    statusSpan.textContent = enabled ? 'Enabled' : 'Disabled';
    statusSpan.className = enabled ? 'text-success' : 'text-danger';
}

function testEmailRecipients() {
    const handoverRecipients = document.getElementById('handover_email_recipients').value.trim();
    const priorityRecipients = document.getElementById('priority_alert_recipients').value.trim();
    
    if (!handoverRecipients && !priorityRecipients) {
        showAlert('Please configure email recipients first', 'warning');
        return;
    }
    
    showAlert('Sending test emails...', 'info');
    
    fetch('/admin/secrets/api/test-email-recipients', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            handover_recipients: handoverRecipients,
            priority_recipients: priorityRecipients
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('✅ Test emails sent successfully! Check recipient inboxes.', 'success');
        } else {
            showAlert('❌ Error sending test emails: ' + (data.error || data.message || 'Unknown error'), 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('❌ Error sending test emails: ' + error.message, 'error');
    });
}

document.addEventListener('DOMContentLoaded', function() {
    console.log('Secrets Management Dashboard loaded successfully');
    
    // Load all configurations
    loadSMTPConfig();
    loadServiceNowConfig();  
    loadApplicationConfig();
    loadEmailRecipients();
    
    // Set some default values for display
    document.getElementById('database_url').value = 'mysql+pymysql://user:••••••••@db/shift_handover';
    document.getElementById('secret_key').value = '••••••••••••••••••••••••••••••••';
});
</script>
{% endblock %}
