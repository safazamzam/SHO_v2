{% extends "base.html" %}

{% block title %}Secrets Management{% endblock %}

{% block extra_css %}
<!-- CACHE BUSTER v2.2 - FORCE MODERN SMTP DESIGN -->
<style>
    /* Clean ServiceNow-Style Configuration Interface */
    body {
        background-color: #f8f9fa;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    /* SMTP Tab now uses same styling as other tabs - no custom overrides needed */

    .secrets-management-container {
        background: #ffffff;
        min-height: 100vh;
        padding: 0;
    }

    /* Header Section */
    .secrets-header {
        background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        color: white;
        padding: 1.5rem 2rem;
        border-bottom: 3px solid #3498db;
    }

    .secrets-header h1 {
        font-size: 1.75rem;
        font-weight: 600;
        margin: 0;
        display: flex;
        align-items: center;
    }

    .secrets-header h1 i {
        margin-right: 0.75rem;
        font-size: 1.5rem;
    }

    .secrets-header p {
        margin: 0.5rem 0 0 0;
        opacity: 0.9;
        font-size: 0.95rem;
    }

    /* Navigation Tabs */
    .secrets-nav-container {
        background: #ffffff;
        border-bottom: 1px solid #dee2e6;
        padding: 0 2rem;
    }

    .nav-tabs {
        border: none;
        margin: 0;
    }

    .nav-tabs .nav-link {
        color: #6c757d;
        font-weight: 500;
        font-size: 0.95rem;
        border: none;
        border-radius: 0;
        padding: 1rem 1.5rem;
        background: transparent;
        transition: all 0.3s ease;
        border-bottom: 3px solid transparent;
    }

    .nav-tabs .nav-link:hover {
        color: #3498db;
        background: rgba(52, 152, 219, 0.05);
        border-color: transparent;
    }

    .nav-tabs .nav-link.active {
        color: #3498db;
        background: rgba(52, 152, 219, 0.1);
        border-color: #3498db;
        font-weight: 600;
    }

    /* Content Container */
    .tab-content {
        background: #ffffff;
    }

    /* ServiceNow-Style Configuration Section */
    .config-section {
        background: #ffffff;
    }

    .config-section-header {
        background: #f8f9fa;
        padding: 1.5rem 2rem;
        border-bottom: 1px solid #dee2e6;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .config-section-title {
        font-size: 1.4rem;
        font-weight: 600;
        color: #2c3e50;
        margin: 0;
    }

    .config-section-subtitle {
        color: #6c757d;
        font-size: 0.9rem;
        margin: 0.25rem 0 0 0;
    }

    .config-actions {
        display: flex;
        gap: 0.5rem;
    }

    /* Info Banner */
    .config-info-banner {
        background: #d1ecf1;
        border: 1px solid #bee5eb;
        border-left: 4px solid #17a2b8;
        padding: 1rem 2rem;
        margin: 0;
        display: flex;
        align-items: center;
    }

    .config-info-banner i {
        color: #0c5460;
        margin-right: 0.75rem;
        font-size: 1.1rem;
    }

    .config-info-banner span {
        color: #0c5460;
        font-size: 0.9rem;
    }

    /* Form Container */
    .config-form-container {
        padding: 2rem;
    }

    /* Two-Column Form Layout */
    .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        margin-bottom: 2rem;
    }

    .form-field {
        display: flex;
        flex-direction: column;
    }

    .field-label {
        font-size: 0.9rem;
        font-weight: 500;
        color: #495057;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
    }

    .field-icon {
        margin-right: 0.5rem;
        color: #6c757d;
        width: 16px;
        text-align: center;
    }

    .required-indicator {
        color: #dc3545;
        margin-left: 0.25rem;
    }

    .field-input {
        padding: 0.75rem 1rem;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 0.9rem;
        background-color: #f8f9fa;
        transition: all 0.15s ease-in-out;
    }

    .field-input:focus {
        border-color: #80bdff;
        outline: 0;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        background-color: #ffffff;
    }

    .field-input:read-only {
        background-color: #f8f9fa;
        cursor: default;
    }

    .field-help {
        color: #6c757d;
        font-size: 0.8rem;
        margin-top: 0.25rem;
    }

    /* Toggle Switches */
    .toggle-field {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin: 0.5rem 0;
    }

    .toggle-switch {
        position: relative;
        width: 50px;
        height: 24px;
    }

    .toggle-input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: 0.3s;
        border-radius: 24px;
    }

    .toggle-slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: 0.3s;
        border-radius: 50%;
    }

    .toggle-input:checked + .toggle-slider {
        background-color: #007bff;
    }

    .toggle-input:checked + .toggle-slider:before {
        transform: translateX(26px);
    }

    .toggle-input:disabled + .toggle-slider {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .toggle-label {
        font-size: 0.9rem;
        color: #495057;
    }

    /* Password Field with Visibility Toggle */
    .password-field-wrapper {
        position: relative;
    }

    .password-toggle-btn {
        position: absolute;
        right: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: #6c757d;
        cursor: pointer;
        padding: 0.25rem;
    }

    .password-toggle-btn:hover {
        color: #495057;
    }

    /* Progress Section */
    .progress-section {
        background: #f8f9fa;
        border-radius: 6px;
        padding: 1.5rem;
        margin: 2rem 0;
        border: 1px solid #e9ecef;
    }

    .progress-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .progress-title {
        font-size: 1rem;
        font-weight: 600;
        color: #2c3e50;
        margin: 0;
    }

    .progress-info {
        font-size: 0.9rem;
        color: #6c757d;
    }

    .progress-bar-wrapper {
        background-color: #e9ecef;
        border-radius: 10px;
        height: 8px;
        overflow: hidden;
        margin-bottom: 0.75rem;
    }

    .progress-bar-fill {
        height: 100%;
        border-radius: 10px;
        transition: width 0.5s ease;
    }

    .progress-complete {
        background-color: #28a745;
    }

    .progress-partial {
        background-color: #ffc107;
    }

    .progress-indicators {
        display: flex;
        justify-content: space-between;
        font-size: 0.85rem;
    }

    .progress-indicator {
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .indicator-configured {
        color: #28a745;
    }

    .indicator-missing {
        color: #ffc107;
    }

    /* Footer Actions */
    .config-footer {
        background: #f8f9fa;
        border-top: 1px solid #dee2e6;
        padding: 1.5rem 2rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .footer-actions {
        display: flex;
        gap: 0.75rem;
    }

    .security-note {
        display: flex;
        align-items: center;
        font-size: 0.85rem;
        color: #6c757d;
    }

    .security-note i {
        margin-right: 0.5rem;
    }

    /* Button Styling */
    .btn {
        padding: 0.5rem 1rem;
        border-radius: 4px;
        font-size: 0.9rem;
        font-weight: 500;
        transition: all 0.15s ease-in-out;
        border: 1px solid;
        cursor: pointer;
    }

    .btn-primary {
        background-color: #007bff;
        border-color: #007bff;
        color: white;
    }

    .btn-primary:hover {
        background-color: #0056b3;
        border-color: #004085;
    }

    .btn-outline-primary {
        background-color: transparent;
        border-color: #007bff;
        color: #007bff;
    }

    .btn-outline-primary:hover {
        background-color: #007bff;
        color: white;
    }

    .btn-outline-success {
        background-color: transparent;
        border-color: #28a745;
        color: #28a745;
    }

    .btn-outline-success:hover {
        background-color: #28a745;
        color: white;
    }

    .btn-outline-secondary {
        background-color: transparent;
        border-color: #6c757d;
        color: #6c757d;
    }

    .btn-outline-secondary:hover {
        background-color: #6c757d;
        color: white;
    }

    .btn-sm {
        padding: 0.375rem 0.75rem;
        font-size: 0.8rem;
    }

    /* Responsive Design */
    @media (max-width: 992px) {
        .form-grid {
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }
        
        .config-section-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 1rem;
        }
        
        .config-actions {
            width: 100%;
        }
        
        .progress-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.5rem;
        }
        
        .config-footer {
            flex-direction: column;
            align-items: flex-start;
            gap: 1rem;
        }
    }

    @media (max-width: 576px) {
        .secrets-header {
            padding: 1rem;
        }
        
        .secrets-nav-container {
            padding: 0 1rem;
        }
        
        .config-form-container {
            padding: 1rem;
        }
        
        .config-footer {
            padding: 1rem;
        }
    }

    .secrets-section {
        background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        border: 1px solid rgba(56, 142, 255, 0.15);
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }

    .section-title {
        color: #1565c0;
        font-size: clamp(1.1rem, 2.5vw, 1.3rem);
        font-weight: 600;
        margin: 0;
    }

    .status-badge {
        padding: 0.4rem 0.8rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .status-configured {
        background: linear-gradient(135deg, #4caf50, #388e3c);
        color: white;
    }

    .status-pending {
        background: linear-gradient(135deg, #ff9800, #f57c00);
        color: white;
    }

    .status-missing {
        background: linear-gradient(135deg, #f44336, #d32f2f);
        color: white;
    }

    .data-table-container {
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 3px 15px rgba(0,0,0,0.08);
        border: 1px solid rgba(230, 240, 250, 0.8);
    }

    .table {
        margin-bottom: 0;
        font-size: clamp(0.85rem, 1.8vw, 0.95rem);
    }

    .table thead th {
        background: linear-gradient(135deg, #f8fbff 0%, #e8f4f8 100%);
        border: none;
        color: #2c3e50;
        font-weight: 600;
        font-size: clamp(0.8rem, 1.5vw, 0.9rem);
        letter-spacing: 0.3px;
        padding: 1rem 0.8rem;
    }

    .table tbody td {
        padding: 0.8rem;
        vertical-align: middle;
        border-color: #f1f3f4;
        color: #495057;
        font-size: clamp(0.85rem, 1.8vw, 0.95rem);
    }

    .table tbody tr:hover {
        background: rgba(33, 150, 243, 0.05);
        transition: background-color 0.2s ease;
    }

    .secret-actions {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .btn-sm {
        font-size: 0.8rem;
        padding: 0.4rem 0.8rem;
        border-radius: 6px;
        font-weight: 500;
    }

    .btn-outline-primary {
        border-color: #2196f3;
        color: #2196f3;
    }

    .btn-outline-primary:hover {
        background: #2196f3;
        border-color: #2196f3;
    }

    .btn-outline-success {
        border-color: #4caf50;
        color: #4caf50;
    }

    .btn-outline-success:hover {
        background: #4caf50;
        border-color: #4caf50;
    }

    .btn-outline-danger {
        border-color: #f44336;
        color: #f44336;
    }

    .btn-outline-danger:hover {
        background: #f44336;
        border-color: #f44336;
    }

    .empty-state {
        text-align: center;
        padding: 3rem 1.5rem;
        color: #6c757d;
    }

    .empty-state-icon {
        font-size: 3rem;
        color: #bbb;
        margin-bottom: 1rem;
    }

    .empty-state h5 {
        color: #495057;
        margin-bottom: 0.5rem;
    }

    .alert {
        border-radius: 8px;
        border: none;
        margin-bottom: 1rem;
    }

    .alert-info {
        background: linear-gradient(135deg, #e3f2fd 0%, #f0f9ff 100%);
        color: #1565c0;
        border-left: 4px solid #2196f3;
    }

    .config-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 1rem;
    }

    /* Modern SMTP Configuration Styles */
    .config-group {
        background: linear-gradient(135deg, #ffffff 0%, #f8fbff 100%);
        border-radius: 16px;
        border: 1px solid rgba(59, 130, 246, 0.1);
        padding: 1.5rem;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }

    .config-group:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(59, 130, 246, 0.15);
        border-color: rgba(59, 130, 246, 0.2);
    }

    .group-header {
        margin-bottom: 1.5rem;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid rgba(59, 130, 246, 0.1);
    }

    .group-title {
        color: #374151;
        font-size: 1.1rem;
        font-weight: 600;
        margin: 0;
        display: flex;
        align-items: center;
    }

    .group-title i {
        color: #3b82f6;
        font-size: 1.2rem;
    }

    .field-container {
        background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%);
        border-radius: 12px;
        padding: 1.25rem;
        border: 2px solid transparent;
        transition: all 0.3s ease;
        position: relative;
        height: 100%;
    }

    .field-container.configured {
        border-color: rgba(34, 197, 94, 0.2);
        background: linear-gradient(135deg, #f0fdf4 0%, #ffffff 100%);
    }

    .field-container.missing {
        border-color: rgba(245, 158, 11, 0.2);
        background: linear-gradient(135deg, #fffbeb 0%, #ffffff 100%);
    }

    .field-label {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
        font-weight: 600;
        color: #374151;
        font-size: 0.95rem;
    }

    .required-indicator {
        color: #ef4444;
        font-weight: bold;
        margin-left: 0.25rem;
    }

    .config-badge {
        padding: 0.25rem 0.6rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .config-badge.configured {
        background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
        color: #166534;
    }

    .config-badge.missing {
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        color: #92400e;
    }

    .input-container {
        margin-bottom: 0.75rem;
    }

    .input-wrapper {
        position: relative;
        display: flex;
        align-items: center;
    }

    .input-icon {
        position: absolute;
        left: 0.75rem;
        color: #9ca3af;
        z-index: 2;
        font-size: 0.9rem;
    }

    .modern-input {
        padding-left: 2.5rem;
        padding-right: 2.5rem;
        border: 2px solid #e5e7eb;
        border-radius: 10px;
        font-size: 0.95rem;
        transition: all 0.3s ease;
        background: #ffffff;
        height: 48px;
    }

    .modern-input:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        outline: none;
    }

    .modern-input:read-only {
        background: #f9fafb;
        color: #6b7280;
    }

    .password-toggle {
        position: absolute;
        right: 0.75rem;
        background: none;
        border: none;
        color: #9ca3af;
        cursor: pointer;
        padding: 0.25rem;
        border-radius: 4px;
        transition: color 0.3s ease;
    }

    .password-toggle:hover {
        color: #3b82f6;
    }

    .form-switch-container {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem 0;
    }

    .modern-switch {
        width: 3rem !important;
        height: 1.5rem !important;
        border-radius: 1rem !important;
        background-color: #d1d5db !important;
        border: none !important;
        transition: all 0.3s ease !important;
    }

    .modern-switch:checked {
        background-color: #3b82f6 !important;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1) !important;
    }

    .field-description {
        color: #6b7280;
        font-size: 0.85rem;
        line-height: 1.4;
        margin-top: 0.5rem;
    }

    /* Modern SMTP Configuration Card Styles */
    .config-card {
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        border: 1px solid rgba(59, 130, 246, 0.15);
        border-radius: 16px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
        overflow: hidden;
    }

    .config-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 30px rgba(59, 130, 246, 0.2);
        border-color: rgba(59, 130, 246, 0.3);
    }

    .config-card-header {
        background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
        padding: 1.25rem 1.5rem;
        border-bottom: 1px solid rgba(59, 130, 246, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .config-card-title {
        margin: 0;
        color: #1e293b;
        font-size: 1.1rem;
        font-weight: 600;
        display: flex;
        align-items: center;
    }

    .config-card-title i {
        color: #3b82f6;
        font-size: 1.2rem;
    }

    .config-card-body {
        padding: 1.5rem;
    }

    .config-status-indicator {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.9rem;
        font-weight: 500;
        color: #64748b;
    }

    .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        display: inline-block;
    }

    .status-dot.status-success {
        background: #22c55e;
    }

    .status-dot.status-warning {
        background: #f59e0b;
    }

    .status-dot.status-danger {
        background: #ef4444;
    }

    .form-field {
        margin-bottom: 1rem;
    }

    .form-label {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
        
    /* Modern SMTP Configuration - ServiceNow Style - FORCE OVERRIDE */
    .smtp-modern-container {
        background: #ffffff !important;
        border-radius: 12px !important;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1) !important;
        margin: 1.5rem 0 !important;
        overflow: hidden !important;
        border: 1px solid rgba(59, 130, 246, 0.2) !important;
        /* Cache busting - v2.1 */
    }

    .smtp-header {
        background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%) !important;
        border-bottom: 2px solid rgba(59, 130, 246, 0.1) !important;
        padding: 2rem 2.5rem !important;
        display: flex !important;
        justify-content: space-between !important;
        align-items: flex-start !important;
    }

    .smtp-title {
        font-size: 1.6rem !important;
        font-weight: 700 !important;
        color: #1e293b !important;
        margin: 0 !important;
        line-height: 1.3 !important;
        display: flex !important;
        align-items: center !important;
        gap: 0.75rem !important;
    }

    .smtp-title::before {
        content: "ðŸ“§";
        font-size: 1.8rem;
    }

    .smtp-subtitle {
        color: #64748b;
        font-size: 1rem;
        margin: 0.5rem 0 0 0;
        line-height: 1.4;
        font-weight: 400;
    }

    .smtp-header-actions {
        display: flex;
        gap: 0.75rem;
        flex-shrink: 0;
    }

    .smtp-form-wrapper {
        padding: 2.5rem;
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    }

    .smtp-modern-form {
        max-width: 100%;
    }

    /* Enhanced Form Row Layout */
    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2.5rem;
        margin-bottom: 2.5rem;
    }

    .form-field-wrapper {
        display: flex;
        flex-direction: column;
        background: #ffffff;
        border-radius: 12px;
        padding: 1.5rem;
        border: 2px solid transparent;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }

    .form-field-wrapper:hover {
        border-color: rgba(59, 130, 246, 0.3);
        box-shadow: 0 8px 25px rgba(59, 130, 246, 0.15);
        transform: translateY(-2px);
    }

    .modern-label {
        font-size: 1rem;
        font-weight: 600;
        color: #374151;
        margin-bottom: 0.75rem;
        display: flex;
        align-items: center;
        line-height: 1.4;
    }

    .field-icon {
        margin-right: 0.75rem;
        color: #3b82f6;
        width: 16px;
        font-size: 1.1rem;
    }

    .modern-input {
        padding: 1rem 1.25rem;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 1rem;
        line-height: 1.4;
        background-color: #f9fafb;
        transition: all 0.3s ease;
        width: 100%;
        min-height: 48px;
    }

    .modern-input:focus {
        border-color: #3b82f6;
        outline: 0;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        background-color: #ffffff;
    }

    .modern-input:read-only {
        background-color: #f3f4f6;
        opacity: 1;
        cursor: not-allowed;
    }

    .modern-input::placeholder {
        color: #9ca3af;
        opacity: 1;
    }

    .field-help {
        color: #6b7280;
        font-size: 0.875rem;
        margin-top: 0.5rem;
        line-height: 1.3;
    }

    .required-indicator {
        color: #ef4444;
        font-weight: bold;
        margin-left: 0.5rem;
    }

    /* Toggle Switch Styling */
    .toggle-wrapper {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 24px;
        margin: 0.5rem 0;
    }

    .modern-toggle {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: 0.3s;
        border-radius: 24px;
    }

    .toggle-slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: 0.3s;
        border-radius: 50%;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
    }

    .modern-toggle:checked + .toggle-slider {
        background-color: #007bff;
    }

    .modern-toggle:checked + .toggle-slider:before {
        transform: translateX(26px);
    }

    .modern-toggle:disabled + .toggle-slider {
        opacity: 0.6;
        cursor: not-allowed;
    }

    /* Password Field */
    .password-field {
        position: relative;
        display: flex;
        align-items: center;
    }

    .password-visibility-btn {
        position: absolute;
        right: 0.75rem;
        background: none;
        border: none;
        color: #6c757d;
        cursor: pointer;
        padding: 0.25rem;
        z-index: 10;
        border-radius: 3px;
        transition: color 0.15s ease-in-out;
    }

    .password-visibility-btn:hover {
        color: #495057;
    }

    /* Configuration Progress Section */
    .config-progress-section {
        background: #f8f9fa;
        border-radius: 6px;
        padding: 1.5rem;
        margin-top: 2rem;
        border: 1px solid #e9ecef;
    }

    .progress-title {
        font-size: 1rem;
        font-weight: 600;
        color: #2c3e50;
        margin: 0 0 1rem 0;
    }

    .progress-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .progress-text {
        font-size: 0.9rem;
        color: #6c757d;
    }

    .test-connection-btn {
        font-size: 0.8rem;
        padding: 0.375rem 0.75rem;
    }

    .progress-bar-container {
        margin-top: 1rem;
    }

    .progress-bar-bg {
        background-color: #e9ecef;
        border-radius: 10px;
        height: 8px;
        overflow: hidden;
        margin-bottom: 0.75rem;
    }

    .progress-bar-fill {
        height: 100%;
        border-radius: 10px;
        transition: width 0.5s ease;
    }

    .progress-bar-fill.complete {
        background-color: #28a745;
    }

    .progress-bar-fill.partial {
        background-color: #ffc107;
    }

    .progress-indicators {
        display: flex;
        justify-content: space-between;
        font-size: 0.8rem;
    }

    .progress-indicator {
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .progress-indicator.configured {
        color: #28a745;
    }

    .progress-indicator.missing {
        color: #ffc107;
    }

    /* Footer Actions */
    .smtp-footer-actions {
        background: #f8f9fa;
        border-top: 1px solid #e9ecef;
        padding: 1.5rem 2rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .security-note {
        margin-left: auto;
        font-size: 0.8rem;
        color: #6c757d;
        display: flex;
        align-items: center;
    }

    /* Responsive Design */
    @media (max-width: 992px) {
        .form-row {
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }
        
        .smtp-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 1rem;
        }
        
        .smtp-header-actions {
            width: 100%;
            justify-content: flex-start;
        }
        
        .progress-info {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.75rem;
        }
        
        .smtp-footer-actions {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.75rem;
        }
        
        .security-note {
            margin-left: 0;
        }
    }

    @media (max-width: 576px) {
        .smtp-header {
            padding: 1rem;
        }
        
        .smtp-form-wrapper {
            padding: 1rem;
        }
        
        .smtp-footer-actions {
            padding: 1rem;
        }
        
        .form-row {
            gap: 1rem;
        }
    }
        font-weight: 600;
        color: #374151;
        font-size: 0.95rem;
    }

    .field-status {
        margin-left: auto;
        font-size: 0.9rem;
    }

    .required {
        color: #ef4444;
        font-weight: bold;
        margin-left: 0.25rem;
    }

    .input-group-text {
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border: 1px solid #e5e7eb;
        color: #6b7280;
        border-right: none;
    }

    .form-control {
        border-left: none;
        border-color: #e5e7eb;
        transition: all 0.3s ease;
    }

    .form-control:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .form-control:read-only {
        background-color: #f9fafb;
        color: #6b7280;
    }

    .form-text {
        color: #6b7280;
        font-size: 0.85rem;
        margin-top: 0.25rem;
    }

    .form-check-input:checked {
        background-color: #3b82f6;
        border-color: #3b82f6;
    }

    .config-summary-card {
        background: linear-gradient(135deg, #fefce8 0%, #fef3c7 100%);
        border: 1px solid #fbbf24;
        border-radius: 12px;
        padding: 1.5rem;
        margin-top: 2rem;
    }

    .progress-circle {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        margin-left: auto;
    }

    .progress-percentage {
        color: white;
        font-weight: bold;
        font-size: 0.9rem;
    }

    .config-actions {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
    }

    .config-actions .btn {
        border-radius: 8px;
        font-weight: 500;
        padding: 0.5rem 1rem;
        transition: all 0.3s ease;
    }

    .config-actions .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .status-summary {
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border: 2px solid rgba(59, 130, 246, 0.1);
        border-radius: 16px;
        padding: 1.5rem;
        margin-top: 2rem;
    }

    .status-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .status-title {
        color: #374151;
        font-size: 1.1rem;
        font-weight: 600;
        margin: 0;
    }

    .status-description {
        color: #6b7280;
        font-size: 0.9rem;
        margin: 0.25rem 0 0 0;
    }

    .percentage-text {
        font-size: 1.5rem;
        font-weight: bold;
        color: #3b82f6;
    }

    .progress-container {
        margin-bottom: 1rem;
    }

    .progress-bar-modern {
        background: #e5e7eb;
        border-radius: 10px;
        height: 8px;
        overflow: hidden;
    }

    .progress-fill {
        height: 100%;
        border-radius: 10px;
        transition: width 0.5s ease;
    }

    .progress-fill.complete {
        background: linear-gradient(90deg, #22c55e 0%, #16a34a 100%);
    }

    .progress-fill.partial {
        background: linear-gradient(90deg, #f59e0b 0%, #d97706 100%);
    }

    .status-indicators {
        display: flex;
        gap: 1.5rem;
    }

    .indicator-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.9rem;
        color: #6b7280;
    }

    .header-actions {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    @media (max-width: 768px) {
        .section-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 1rem;
        }

        .header-actions {
            width: 100%;
            justify-content: flex-start;
        }

        .status-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.5rem;
        }

        .status-indicators {
            flex-direction: column;
            gap: 0.75rem;
        }

        .config-group {
            padding: 1rem;
        }

        .field-container {
            padding: 1rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="secrets-management-container">
    <!-- Header Section -->
    <div class="secrets-header">
        <h1><i class="fas fa-shield-alt"></i>Secrets Management</h1>
        <p>Comprehensive configuration management for application settings, SMTP, ServiceNow integrations, and more</p>
    </div>

    <!-- Navigation Tabs -->
    <div class="secrets-nav-container">
        <ul class="nav nav-tabs" id="secretsTabs">
            <li class="nav-item">
                <button class="nav-link" id="servicenow-tab" data-bs-toggle="tab" data-bs-target="#servicenow" type="button">
                    <i class="fab fa-servicestack me-2"></i>ServiceNow
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link active" id="smtp-tab" data-bs-toggle="tab" data-bs-target="#smtp" type="button">
                    <i class="fas fa-envelope me-2"></i>SMTP
                    <span class="badge bg-success ms-2" style="font-size: 0.6rem;">NEW DESIGN</span>
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="application-tab" data-bs-toggle="tab" data-bs-target="#application" type="button">
                    <i class="fas fa-cogs me-2"></i>Application
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="oauth-tab" data-bs-toggle="tab" data-bs-target="#oauth" type="button">
                    <i class="fab fa-google me-2"></i>OAuth & SSO
                </button>
            </li>
        </ul>
    </div>

    <!-- Tab Content -->
    <div class="tab-content" id="secretsTabContent">
        
        <!-- ServiceNow Configuration Tab -->
        <div class="tab-pane fade" id="servicenow" role="tabpanel">
            <div class="config-section">
                <!-- Section Header -->
                <div class="config-section-header">
                    <div>
                        <h2 class="config-section-title">ServiceNow Integration Settings</h2>
                        <p class="config-section-subtitle">Configure your ServiceNow instance connection settings. These settings are stored securely in the database and can be updated anytime.</p>
                    </div>
                    <div class="config-actions">
                        <button class="btn btn-outline-primary btn-sm" onclick="editServiceNowConfig()">
                            <i class="fas fa-edit me-1"></i>Edit Configuration
                        </button>
                        <button class="btn btn-outline-success btn-sm" onclick="testServiceNowConnection()">
                            <i class="fas fa-vial me-1"></i>Test Connection
                        </button>
                    </div>
                </div>

                <!-- Info Banner -->
                <div class="config-info-banner">
                    <i class="fas fa-info-circle"></i>
                    <span>ServiceNow Configuration: Configure your ServiceNow instance connection settings. These settings are stored securely in the database and can be updated anytime.</span>
                </div>

                <!-- Form Container -->
                <div class="config-form-container">
                    <form id="servicenowConfigForm">
                        <!-- Basic Settings Grid -->
                        <div class="form-grid">
                            <div class="form-field">
                                <label class="field-label">
                                    <i class="fas fa-link field-icon"></i>
                                    Instance URL <span class="required-indicator">*</span>
                                </label>
                                <input type="text" class="field-input" id="servicenow_instance_url" 
                                       placeholder="e.g., yourcompany.service-now.com" readonly>
                                <small class="field-help">Your ServiceNow instance URL (without https://)</small>
                            </div>

                            <div class="form-field">
                                <label class="field-label">
                                    <i class="fas fa-user field-icon"></i>
                                    Username <span class="required-indicator">*</span>
                                </label>
                                <input type="text" class="field-input" id="servicenow_username" 
                                       placeholder="admin" readonly>
                                <small class="field-help">ServiceNow API user account</small>
                            </div>
                        </div>

                        <div class="form-grid">
                            <div class="form-field">
                                <label class="field-label">
                                    <i class="fas fa-key field-icon"></i>
                                    Password <span class="required-indicator">*</span>
                                </label>
                                <div class="password-field-wrapper">
                                    <input type="password" class="field-input" id="servicenow_password" 
                                           placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" readonly>
                                    <button type="button" class="password-toggle-btn" onclick="togglePasswordVisibility('servicenow_password')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                                <small class="field-help">ServiceNow API user password</small>
                            </div>

                            <div class="form-field">
                                <label class="field-label">
                                    <i class="fas fa-clock field-icon"></i>
                                    Timeout
                                </label>
                                <input type="number" class="field-input" id="servicenow_timeout" 
                                       placeholder="30" readonly>
                                <small class="field-help">API timeout (seconds)</small>
                            </div>
                        </div>

                        <div class="form-grid">
                            <div class="form-field">
                                <label class="field-label">
                                    <i class="fas fa-users field-icon"></i>
                                    Assignment Groups
                                </label>
                                <input type="text" class="field-input" id="servicenow_assignment_groups" 
                                       placeholder="e.g., Supply Chain - L2, Network Team" readonly>
                                <small class="field-help">Comma-separated list of groups to monitor (leave empty for all groups)</small>
                            </div>

                            <div class="form-field">
                                <label class="field-label">
                                    <i class="fas fa-chart-line field-icon"></i>
                                    Connection Status
                                </label>
                                <div class="toggle-field">
                                    <button class="btn btn-outline-info btn-sm" onclick="testServiceNowConnection()">
                                        <i class="fas fa-vial me-1"></i>Test Connection
                                    </button>
                                </div>
                                <small class="field-help">Test your ServiceNow connection</small>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Footer Actions -->
                <div class="config-footer">
                    <div class="footer-actions">
                        <button class="btn btn-primary" onclick="saveServiceNowSettings()">
                            <i class="fas fa-save me-2"></i>Save ServiceNow Settings
                        </button>
                        <button class="btn btn-outline-secondary" onclick="clearServiceNowSettings()">
                            <i class="fas fa-eraser me-2"></i>Clear Settings
                        </button>
                    </div>
                    <div class="security-note">
                        <i class="fas fa-shield-alt"></i>
                        Settings are encrypted and stored securely
                    </div>
                </div>
            </div>
        </div>

        <!-- SMTP Configuration Tab -->
        <div class="tab-pane fade show active" id="smtp" role="tabpanel">
            <div class="config-section">
                <!-- Section Header -->
                <div class="config-section-header">
                    <div>
                        <h2 class="config-section-title">SMTP Email Configuration</h2>
                        <p class="config-section-subtitle">Configure email server settings for notifications and system alerts. These settings are stored securely in the database and can be updated anytime.</p>
                    </div>
                    <div class="config-actions">
                        <button class="btn btn-outline-primary btn-sm" onclick="editSMTPConfig()">
                            <i class="fas fa-edit me-1"></i>Edit Configuration
                        </button>
                        <button class="btn btn-outline-success btn-sm" onclick="sendTestEmail()">
                            <i class="fas fa-paper-plane me-1"></i>Send Test Email
                        </button>
                    </div>
                </div>

                <!-- Info Banner -->
                <div class="config-info-banner">
                    <i class="fas fa-info-circle"></i>
                    <span>SMTP Configuration: Configure email server settings for notifications and system alerts. These settings are stored securely in the database and can be updated anytime.</span>
                </div>

                <!-- Form Container -->
                <div class="config-form-container">
                    <form id="smtpConfigForm">
                        <!-- Basic Settings Grid -->
                        <div class="form-grid">
                            <div class="form-field">
                                <label class="field-label">
                                    <i class="fas fa-server field-icon"></i>
                                    SMTP Server <span class="required-indicator">*</span>
                                </label>
                                <input type="text" class="field-input" id="smtp_server" 
                                       placeholder="smtp.gmail.com" readonly>
                                <small class="field-help">Your email provider's SMTP server hostname</small>
                            </div>

                            <div class="form-field">
                                <label class="field-label">
                                    <i class="fas fa-plug field-icon"></i>
                                    Port <span class="required-indicator">*</span>
                                </label>
                                <input type="number" class="field-input" id="smtp_port" 
                                       placeholder="587" readonly>
                                <small class="field-help">Port 587 (TLS) or 465 (SSL)</small>
                            </div>
                        </div>

                        <!-- Authentication Grid -->
                        <div class="form-grid">
                            <div class="form-field">
                                <label class="field-label">
                                    <i class="fas fa-user field-icon"></i>
                                    Email Username <span class="required-indicator">*</span>
                                </label>
                                <input type="email" class="field-input" id="smtp_username" 
                                       placeholder="your-email@company.com" readonly>
                                <small class="field-help">Your email address for authentication</small>
                            </div>

                            <div class="form-field">
                                <label class="field-label">
                                    <i class="fas fa-key field-icon"></i>
                                    Password <span class="required-indicator">*</span>
                                </label>
                                <div class="password-field-wrapper">
                                    <input type="password" class="field-input" id="smtp_password" 
                                           placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" readonly>
                                    <button type="button" class="password-toggle-btn" onclick="togglePasswordVisibility('smtp_password')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                                <small class="field-help">Password or app-specific password</small>
                            </div>
                        </div>

                        <!-- Additional Settings Grid -->
                        <div class="form-grid">
                            <div class="form-field">
                                <label class="field-label">
                                    <i class="fas fa-envelope-open field-icon"></i>
                                    From Email Address <span class="required-indicator">*</span>
                                </label>
                                <input type="email" class="field-input" id="smtp_from_email" 
                                       placeholder="noreply@yourcompany.com" readonly>
                                <small class="field-help">Email address shown as sender</small>
                            </div>

                            <div class="form-field">
                                <label class="field-label">
                                    <i class="fas fa-shield-alt field-icon"></i>
                                    Security Settings
                                </label>
                                <div class="toggle-field">
                                    <label class="toggle-label">
                                        <input type="checkbox" id="smtp_use_tls" checked disabled>
                                        <span class="toggle-text">Enable TLS encryption</span>
                                    </label>
                                </div>
                                <small class="field-help">Recommended for secure email transmission</small>
                            </div>
                        </div>

                        <!-- Test Connection -->
                        <div class="form-grid">
                            <div class="form-field">
                                <label class="field-label">
                                    <i class="fas fa-paper-plane field-icon"></i>
                                    Connection Status
                                </label>
                                <div class="toggle-field">
                                    <button class="btn btn-outline-info btn-sm" onclick="sendTestEmail()">
                                        <i class="fas fa-paper-plane me-1"></i>Send Test Email
                                    </button>
                                </div>
                                <small class="field-help">Test your SMTP configuration</small>
                            </div>

                            <div class="form-field">
                                <label class="field-label">
                                    <i class="fas fa-chart-line field-icon"></i>
                                    Configuration Status
                                </label>
                                <div class="status-display">
                                    <span class="status-badge status-incomplete">0% Complete</span>
                                    <span class="status-text">0 of 5 required fields configured</span>
                                </div>
                                <small class="field-help">Configuration completion status</small>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Footer Actions -->
                <div class="config-footer">
                    <div class="config-footer-actions">
                        <button class="btn btn-outline-primary" onclick="editSMTPConfig()">
                            <i class="fas fa-edit me-2"></i>Edit Settings
                        </button>
                        <button class="btn btn-primary" onclick="saveSMTPSettings()">
                            <i class="fas fa-save me-2"></i>Save Changes
                        </button>
                        <button class="btn btn-outline-success" onclick="sendTestEmail()">
                            <i class="fas fa-paper-plane me-2"></i>Send Test Email
                        </button>
                    </div>
                    <div class="config-footer-note">
                        <i class="fas fa-shield-alt"></i>
                        Settings are encrypted and stored securely
                    </div>
                </div>
            </div>
        </div>

        <!-- Application Configuration Tab -->
            <div class="smtp-modern-container" style="display: none !important;">
                <!-- DUPLICATE CONTENT - HIDDEN -->
                <div class="smtp-header">
                    <div>
                        <h2 class="smtp-title">SMTP Email Configuration</h2>
                        <p class="smtp-subtitle">Configure email server settings for notifications and system alerts</p>
                    </div>
                    <div class="smtp-header-actions">
                        <button class="btn btn-outline-primary btn-sm" onclick="editSMTPConfig()">
                            <i class="fas fa-edit me-1"></i>Edit Configuration
                        </button>
                        <button class="btn btn-outline-success btn-sm" onclick="sendTestEmail()">
                            <i class="fas fa-paper-plane me-1"></i>Send Test Email
                        </button>
                    </div>
                </div>

                <!-- Form Content -->
                <div class="smtp-form-wrapper">
                    <form id="smtpConfigForm" class="smtp-modern-form">
                        
                        <!-- Server Connection Section -->
                        <div class="form-row">
                            <div class="form-field-wrapper">
                                <label class="modern-label">
                                    <i class="fas fa-server field-icon"></i>
                                    SMTP Server
                                    <span class="required-indicator">*</span>
                                </label>
                                <input type="text" 
                                       class="modern-input" 
                                       id="smtp_server" 
                                       placeholder="smtp.gmail.com"
                                       value="{{ smtp_configs.SMTP_SERVER or '' }}" 
                                       readonly>
                                <div class="field-help">Your email provider's SMTP server hostname</div>
                            </div>

                            <div class="form-field-wrapper">
                                <label class="modern-label">
                                    <i class="fas fa-plug field-icon"></i>
                                    Port
                                    <span class="required-indicator">*</span>
                                </label>
                                <input type="number" 
                                       class="modern-input" 
                                       id="smtp_port" 
                                       placeholder="587"
                                       value="{{ smtp_configs.SMTP_PORT or '' }}" 
                                       readonly>
                                <div class="field-help">Port 587 (TLS) or 465 (SSL)</div>
                            </div>
                        </div>

                        <!-- Authentication Section -->
                        <div class="form-row">
                            <div class="form-field-wrapper">
                                <label class="modern-label">
                                    <i class="fas fa-user field-icon"></i>
                                    Email Username
                                    <span class="required-indicator">*</span>
                                </label>
                                <input type="email" 
                                       class="modern-input" 
                                       id="smtp_username" 
                                       placeholder="your-email@company.com"
                                       value="{{ smtp_configs.SMTP_USERNAME or '' }}" 
                                       readonly>
                                <div class="field-help">Your email address for authentication</div>
                            </div>

                            <div class="form-field-wrapper">
                                <label class="modern-label">
                                    <i class="fas fa-key field-icon"></i>
                                    Password
                                    <span class="required-indicator">*</span>
                                </label>
                                <div class="password-field">
                                    <input type="password" 
                                           class="modern-input" 
                                           id="smtp_password" 
                                           placeholder="Enter password or app password"
                                           value="{{ 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢' if smtp_configs.SMTP_PASSWORD else '' }}" 
                                           readonly>
                                    <button type="button" 
                                            class="password-visibility-btn" 
                                            onclick="togglePasswordVisibility('smtp_password')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                                <div class="field-help">Password or app-specific password</div>
                            </div>
                        </div>

                        <!-- Security Options -->
                        <div class="form-row">
                            <div class="form-field-wrapper">
                                <label class="modern-label">
                                    <i class="fas fa-shield-alt field-icon"></i>
                                    Security Settings
                                </label>
                                <div class="form-switch-container">
                                    <label class="toggle-wrapper">
                                        <input type="checkbox" 
                                               class="modern-toggle" 
                                               id="smtp_use_tls" 
                                               {{ 'checked' if smtp_configs.SMTP_USE_TLS == 'true' else '' }} 
                                               disabled>
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="modern-label" style="margin-bottom: 0;">Enable TLS encryption</span>
                                </div>
                                <div class="field-help">Recommended for secure email transmission</div>
                            </div>

                            <div class="form-field-wrapper">
                                <label class="modern-label">
                                    <i class="fas fa-signature field-icon"></i>
                                    From Email Address
                                    <span class="required-indicator">*</span>
                                </label>
                                <input type="email" 
                                       class="modern-input" 
                                       id="mail_from_address" 
                                       placeholder="noreply@yourcompany.com"
                                       value="{{ smtp_configs.MAIL_FROM_ADDRESS or '' }}" 
                                       readonly>
                                <div class="field-help">Email address shown as sender</div>
                            </div>
                        </div>

                        <!-- Configuration Progress -->
                        <div class="config-progress-section">
                            <div class="progress-info">
                                <div>
                                    <h6 class="progress-title">Configuration Status</h6>
                                    <div class="progress-text">{{ smtp_configured_count }} of {{ smtp_total_required }} required fields configured</div>
                                </div>
                                <div class="test-connection-btn">
                                    <button class="btn btn-outline-primary btn-sm" onclick="testSMTPConnection()">
                                        <i class="fas fa-vial me-1"></i>Test Connection
                                    </button>
                                </div>
                            </div>
                            
                            <div class="progress-bar-container">
                                <div class="progress-bar-bg">
                                    <div class="progress-bar-fill {% if smtp_completion_percentage == 100 %}complete{% else %}partial{% endif %}" 
                                         style="width: {{ smtp_completion_percentage }}%">
                                    </div>
                                </div>
                                
                                <div class="progress-indicators">
                                    <span class="progress-indicator configured">
                                        <i class="fas fa-check-circle"></i>
                                        {{ smtp_configured_count }} Configured
                                    </span>
                                    <span class="progress-indicator missing">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        {{ smtp_total_required - smtp_configured_count }} Missing
                                    </span>
                                    <span style="margin-left: auto; font-weight: 600; color: #3b82f6;">
                                        {{ smtp_completion_percentage }}% Complete
                                    </span>
                                </div>
                            </div>
                        </div>

                    </form>
                </div>

                <!-- Footer Actions -->
                <div class="smtp-footer-actions">
                    <button class="btn btn-outline-primary" onclick="editSMTPConfig()">
                        <i class="fas fa-edit me-2"></i>Edit Settings
                    </button>
                    <button class="btn btn-primary" onclick="saveSMTPSettings()">
                        <i class="fas fa-save me-2"></i>Save Changes
                    </button>
                    <button class="btn btn-outline-success" onclick="sendTestEmail()">
                        <i class="fas fa-paper-plane me-2"></i>Send Test Email
                    </button>
                    
                    <div class="security-note">
                        <i class="fas fa-lock me-1"></i>
                        All credentials are encrypted and stored securely
            </div>
        </div>

        <!-- Application Configuration Tab -->
        <div class="tab-pane fade" id="application" role="tabpanel">
            <div class="config-section">
                <!-- Section Header -->
                <div class="config-section-header">
                    <div>
                        <h2 class="config-section-title">Application Settings</h2>
                        <p class="config-section-subtitle">Configure general application settings and environment variables</p>
                    </div>
                    <div class="config-actions">
                        <button class="btn btn-outline-primary btn-sm" onclick="editApplicationConfig()">
                            <i class="fas fa-edit me-1"></i>Edit Configuration
                        </button>
                        <button class="btn btn-outline-success btn-sm" onclick="testApplicationSettings()">
                            <i class="fas fa-vial me-1"></i>Test Settings
                        </button>
                    </div>
                </div>

                <!-- Info Banner -->
                <div class="config-info-banner">
                    <i class="fas fa-info-circle"></i>
                    <span>Application Configuration: Configure general application settings and environment variables. These settings are stored securely in the database and can be updated anytime.</span>
                </div>

                <!-- Form Container -->
                <div class="config-form-container">
                    <form id="applicationConfigForm">
                        <!-- Database Settings -->
                        <div class="form-grid">
                            <div class="form-field">
                                <label class="field-label">
                                    <i class="fas fa-database field-icon"></i>
                                    Database URL <span class="required-indicator">*</span>
                                </label>
                                <input type="text" class="field-input" id="database_url" 
                                       placeholder="postgresql://user:password@localhost/dbname" readonly>
                                <small class="field-help">Database connection string</small>
                            </div>

                            <div class="form-field">
                                <label class="field-label">
                                    <i class="fas fa-key field-icon"></i>
                                    Secret Key <span class="required-indicator">*</span>
                                </label>
                                <div class="password-field-wrapper">
                                    <input type="password" class="field-input" id="secret_key" 
                                           placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" readonly>
                                    <button type="button" class="password-toggle-btn" onclick="togglePasswordVisibility('secret_key')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                                <small class="field-help">Flask application secret key</small>
                            </div>
                        </div>

                        <!-- Environment Settings -->
                        <div class="form-grid">
                            <div class="form-field">
                                <label class="field-label">
                                    <i class="fas fa-server field-icon"></i>
                                    Environment
                                </label>
                                <input type="text" class="field-input" id="environment" 
                                       placeholder="production" readonly>
                                <small class="field-help">Application environment (development, production, etc.)</small>
                            </div>

                            <div class="form-field">
                                <label class="field-label">
                                    <i class="fas fa-bug field-icon"></i>
                                    Debug Mode
                                </label>
                                <div class="toggle-field">
                                    <div class="toggle-switch">
                                        <input type="checkbox" class="toggle-input" id="debug_mode" disabled>
                                        <span class="toggle-slider"></span>
                                    </div>
                                    <span class="toggle-label">Enable debug mode for development</span>
                                </div>
                            </div>
                        </div>

                        <!-- Security Settings -->
                        <div class="form-grid">
                            <div class="form-field">
                                <label class="field-label">
                                    <i class="fas fa-shield-alt field-icon"></i>
                                    Encryption Key
                                </label>
                                <div class="password-field-wrapper">
                                    <input type="password" class="field-input" id="encryption_key" 
                                           placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" readonly>
                                    <button type="button" class="password-toggle-btn" onclick="togglePasswordVisibility('encryption_key')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                                <small class="field-help">Key for encrypting sensitive data</small>
                            </div>

                            <div class="form-field">
                                <label class="field-label">
                                    <i class="fas fa-clock field-icon"></i>
                                    Session Timeout
                                </label>
                                <input type="number" class="field-input" id="session_timeout" 
                                       placeholder="3600" readonly>
                                <small class="field-help">Session timeout in seconds</small>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Footer Actions -->
                <div class="config-footer">
                    <div class="footer-actions">
                        <button class="btn btn-primary" onclick="saveApplicationSettings()">
                            <i class="fas fa-save me-2"></i>Save Application Settings
                        </button>
                        <button class="btn btn-outline-secondary" onclick="clearApplicationSettings()">
                            <i class="fas fa-eraser me-2"></i>Clear Settings
                        </button>
                    </div>
                    <div class="security-note">
                        <i class="fas fa-shield-alt"></i>
                        Settings are encrypted and stored securely
                    </div>
                </div>
            </div>
        </div>

        <!-- OAuth & SSO Configuration Tab -->
        <div class="tab-pane fade" id="oauth" role="tabpanel">
            <div class="config-section">
                <!-- Section Header -->
                <div class="config-section-header">
                    <div>
                        <h2 class="config-section-title">OAuth & SSO Configuration</h2>
                        <p class="config-section-subtitle">Configure OAuth providers and Single Sign-On settings</p>
                    </div>
                    <div class="config-actions">
                        <button class="btn btn-outline-primary btn-sm" onclick="editOAuthConfig()">
                            <i class="fas fa-edit me-1"></i>Edit Configuration
                        </button>
                        <button class="btn btn-outline-success btn-sm" onclick="testOAuthConnection()">
                            <i class="fas fa-vial me-1"></i>Test Connection
                        </button>
                    </div>
                </div>

                <!-- Info Banner -->
                <div class="config-info-banner">
                    <i class="fas fa-info-circle"></i>
                    <span>OAuth & SSO Configuration: Configure OAuth providers and Single Sign-On settings. These settings are stored securely in the database and can be updated anytime.</span>
                </div>

                <!-- Form Container -->
                <div class="config-form-container">
                    <form id="oauthConfigForm">
                        <!-- Google OAuth Settings -->
                        <div class="form-grid">
                            <div class="form-field">
                                <label class="field-label">
                                    <i class="fab fa-google field-icon"></i>
                                    Google Client ID <span class="required-indicator">*</span>
                                </label>
                                <input type="text" class="field-input" id="google_client_id" 
                                       placeholder="your-app.googleusercontent.com" readonly>
                                <small class="field-help">Google OAuth 2.0 client ID</small>
                            </div>

                            <div class="form-field">
                                <label class="field-label">
                                    <i class="fas fa-key field-icon"></i>
                                    Google Client Secret <span class="required-indicator">*</span>
                                </label>
                                <div class="password-field-wrapper">
                                    <input type="password" class="field-input" id="google_client_secret" 
                                           placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" readonly>
                                    <button type="button" class="password-toggle-btn" onclick="togglePasswordVisibility('google_client_secret')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                                <small class="field-help">Google OAuth 2.0 client secret</small>
                            </div>
                        </div>

                        <!-- OAuth Settings -->
                        <div class="form-grid">
                            <div class="form-field">
                                <label class="field-label">
                                    <i class="fas fa-link field-icon"></i>
                                    Redirect URI
                                </label>
                                <input type="text" class="field-input" id="oauth_redirect_uri" 
                                       placeholder="https://yourapp.com/auth/callback" readonly>
                                <small class="field-help">OAuth redirect URI for authentication</small>
                            </div>

                            <div class="form-field">
                                <label class="field-label">
                                    <i class="fas fa-list field-icon"></i>
                                    OAuth Scopes
                                </label>
                                <input type="text" class="field-input" id="oauth_scopes" 
                                       placeholder="openid email profile" readonly>
                                <small class="field-help">Space-separated list of OAuth scopes</small>
                            </div>
                        </div>

                        <!-- SSO Settings -->
                        <div class="form-grid">
                            <div class="form-field">
                                <label class="field-label">
                                    <i class="fas fa-toggle-on field-icon"></i>
                                    Enable SSO
                                </label>
                                <div class="toggle-field">
                                    <div class="toggle-switch">
                                        <input type="checkbox" class="toggle-input" id="enable_sso" disabled>
                                        <span class="toggle-slider"></span>
                                    </div>
                                    <span class="toggle-label">Enable Single Sign-On authentication</span>
                                </div>
                            </div>

                            <div class="form-field">
                                <label class="field-label">
                                    <i class="fas fa-users field-icon"></i>
                                    Auto Provision Users
                                </label>
                                <div class="toggle-field">
                                    <div class="toggle-switch">
                                        <input type="checkbox" class="toggle-input" id="auto_provision" disabled>
                                        <span class="toggle-slider"></span>
                                    </div>
                                    <span class="toggle-label">Automatically create user accounts on first login</span>
                                </div>
                            </div>
                        </div>

                        <!-- Domain Settings -->
                        <div class="form-grid">
                            <div class="form-field">
                                <label class="field-label">
                                    <i class="fas fa-globe field-icon"></i>
                                    Allowed Domains
                                </label>
                                <input type="text" class="field-input" id="allowed_domains" 
                                       placeholder="company.com, subdomain.company.com" readonly>
                                <small class="field-help">Comma-separated list of allowed email domains</small>
                            </div>

                            <div class="form-field">
                                <label class="field-label">
                                    <i class="fas fa-user-tag field-icon"></i>
                                    Default Role
                                </label>
                                <input type="text" class="field-input" id="default_role" 
                                       placeholder="user" readonly>
                                <small class="field-help">Default role for new SSO users</small>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Footer Actions -->
                <div class="config-footer">
                    <div class="footer-actions">
                        <button class="btn btn-primary" onclick="saveOAuthSettings()">
                            <i class="fas fa-save me-2"></i>Save OAuth Settings
                        </button>
                        <button class="btn btn-outline-secondary" onclick="clearOAuthSettings()">
                            <i class="fas fa-eraser me-2"></i>Clear Settings
                        </button>
                    </div>
                    <div class="security-note">
                        <i class="fas fa-shield-alt"></i>
                        Settings are encrypted and stored securely
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>
                                <i class="fas fa-plus"></i> Add SMTP Setting
                            </button>
                            <button class="btn btn-outline-secondary" onclick="testEmailConnection()">
                                <i class="fas fa-paper-plane"></i> Send Test Email
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Application Configuration -->
                <div class="tab-pane fade" id="application" role="tabpanel">
                    <div class="secrets-section">
                        <div class="section-header">
                            <h5 class="section-title">Application Configuration</h5>
                            <span class="status-badge status-configured">Active</span>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            General application settings and API configurations.
                        </div>

                        <div class="data-table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Setting Name</th>
                                        <th>Description</th>
                                        <th>Last Updated</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for secret in secrets_by_category.get('Application', []) %}
                                    <tr>
                                        <td><strong>{{ secret.name }}</strong></td>
                                        <td>{{ secret.description or 'Application configuration setting' }}</td>
                                        <td>{{ secret.updated_at }}</td>
                                        <td>
                                            <div class="secret-actions">
                                                <button class="btn btn-outline-primary btn-sm" onclick="editSecret('{{ secret.name }}')">
                                                    <i class="fas fa-edit"></i> Edit
                                                </button>
                                                <button class="btn btn-outline-danger btn-sm" onclick="deleteSecret('{{ secret.name }}')">
                                                    <i class="fas fa-trash"></i> Delete
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% else %}
                                    <tr>
                                        <td colspan="4">
                                            <div class="empty-state">
                                                <div class="empty-state-icon">
                                                    <i class="fas fa-cogs"></i>
                                                </div>
                                                <h5>No Application Secrets</h5>
                                                <p>Add application configuration settings</p>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <div class="config-actions">
                            <button class="btn btn-primary" onclick="addSecret('Application')">
                                <i class="fas fa-plus"></i> Add Application Setting
                            </button>
                            <button class="btn btn-outline-secondary" onclick="exportConfig()">
                                <i class="fas fa-download"></i> Export Settings
                            </button>
                        </div>
                    </div>
                </div>

                <!-- OAuth & SSO Configuration -->
                <div class="tab-pane fade" id="oauth" role="tabpanel">
                    <div class="secrets-section">
                        <div class="section-header">
                            <h5 class="section-title">OAuth & SSO Configuration</h5>
                            <span class="status-badge {% if oauth_configured %}status-configured{% else %}status-pending{% endif %}">
                                {% if oauth_configured %}Configured{% else %}Pending{% endif %}
                            </span>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Configure OAuth client keys and SSO settings for user authentication.
                        </div>

                        <div class="data-table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Setting Name</th>
                                        <th>Description</th>
                                        <th>Last Updated</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for secret in secrets_by_category.get('OAuth', []) %}
                                    <tr>
                                        <td><strong>{{ secret.name }}</strong></td>
                                        <td>{{ secret.description or 'OAuth authentication setting' }}</td>
                                        <td>{{ secret.updated_at }}</td>
                                        <td>
                                            <div class="secret-actions">
                                                <button class="btn btn-outline-primary btn-sm" onclick="editSecret('{{ secret.name }}')">
                                                    <i class="fas fa-edit"></i> Edit
                                                </button>
                                                <button class="btn btn-outline-success btn-sm" onclick="testOAuthConnection()">
                                                    <i class="fas fa-check"></i> Test OAuth
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% else %}
                                    <tr>
                                        <td colspan="4">
                                            <div class="empty-state">
                                                <div class="empty-state-icon">
                                                    <i class="fab fa-google"></i>
                                                </div>
                                                <h5>No OAuth Secrets</h5>
                                                <p>Configure OAuth settings for single sign-on</p>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <div class="config-actions">
                            <button class="btn btn-primary" onclick="addSecret('OAuth')">
                                <i class="fas fa-plus"></i> Add OAuth Setting
                            </button>
                            <button class="btn btn-outline-secondary" onclick="setupOAuthProvider()">
                                <i class="fab fa-google"></i> Setup Google OAuth
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Secret Management Modal -->
<div class="modal fade" id="secretModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="secretModalTitle">Add Secret</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="secretForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-floating mb-3">
                                <input type="text" class="form-control" id="secretName" required>
                                <label for="secretName">Secret Name</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating mb-3">
                                <select class="form-select" id="secretCategory">
                                    <option value="ServiceNow">ServiceNow</option>
                                    <option value="SMTP">SMTP</option>
                                    <option value="Application">Application</option>
                                    <option value="OAuth">OAuth</option>
                                </select>
                                <label for="secretCategory">Category</label>
                            </div>
                        </div>
                    </div>
                    <div class="form-floating mb-3">
                        <textarea class="form-control" id="secretDescription" style="height: 80px"></textarea>
                        <label for="secretDescription">Description</label>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="password" class="form-control" id="secretValue" required>
                        <label for="secretValue">Secret Value</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveSecret()">Save Secret</button>
            </div>
        </div>
    </div>
</div>

<script>
// Enhanced secrets management functions
// SMTP Configuration Management
let smtpEditMode = false;
let originalSMTPConfig = {};

// Load SMTP configuration on page load
document.addEventListener('DOMContentLoaded', function() {
    loadSMTPConfig();
});

function loadSMTPConfig() {
    const container = document.getElementById('smtp-config-container');
    const statusBadge = document.getElementById('smtp-status-badge');
    
    console.log('Loading SMTP configuration...');
    
    fetch('/admin/secrets/api/smtp/config')
        .then(response => {
            console.log('SMTP API Response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('SMTP API Response data:', data);
            if (data.success) {
                originalSMTPConfig = data.smtp_config;
                renderSMTPConfig(data.smtp_config, data.status);
                updateSMTPStatusBadge(data.status);
            } else {
                container.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Error loading SMTP configuration: ${data.error}
                    </div>
                `;
                statusBadge.textContent = 'Error';
                statusBadge.className = 'status-badge status-missing';
            }
        })
        .catch(error => {
            console.error('Error loading SMTP config:', error);
            container.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Failed to load SMTP configuration: ${error.message}
                </div>
            `;
            statusBadge.textContent = 'Error';
            statusBadge.className = 'status-badge status-missing';
        });
}

function renderSMTPConfig(config, status) {
    const container = document.getElementById('smtp-config-container');
    const actionsContainer = document.getElementById('smtp-actions');
    
    // Group fields into logical sections
    const fieldGroups = {
        'Server Settings': ['SMTP_SERVER', 'SMTP_PORT', 'SMTP_USE_TLS', 'SMTP_USE_SSL'],
        'Authentication': ['SMTP_USERNAME', 'SMTP_PASSWORD'],
        'Email Settings': ['MAIL_FROM_NAME', 'MAIL_FROM_ADDRESS']
    };
    
    let html = '';
    
    for (const [groupName, fieldNames] of Object.entries(fieldGroups)) {
        html += `
            <div class="config-group mb-4">
                <div class="group-header">
                    <h6 class="group-title">
                        <i class="fas fa-${getGroupIcon(groupName)} me-2"></i>
                        ${groupName}
                    </h6>
                </div>
                <div class="group-content">
                    <div class="row g-3">
        `;
        
        fieldNames.forEach(fieldName => {
            if (config[fieldName]) {
                const field = config[fieldName];
                const isConfigured = field.configured;
                const colSize = field.type === 'boolean' ? 'col-md-6' : 'col-md-6';
                
                html += `
                    <div class="${colSize}">
                        <div class="field-container ${isConfigured ? 'configured' : 'missing'}">
                            <label class="field-label">
                                ${field.label}
                                ${field.required ? '<span class="required-indicator">*</span>' : ''}
                                <span class="config-badge ${isConfigured ? 'configured' : 'missing'}">
                                    <i class="fas fa-${isConfigured ? 'check-circle' : 'exclamation-triangle'}"></i>
                                    ${isConfigured ? 'Set' : 'Required'}
                                </span>
                            </label>
                `;
                
                if (field.type === 'boolean') {
                    html += `
                        <div class="form-switch-container">
                            <input type="checkbox" class="form-check-input modern-switch" 
                                   id="${fieldName}" name="${fieldName}"
                                   ${field.value === 'true' ? 'checked' : ''} 
                                   ${smtpEditMode ? '' : 'disabled'}>
                            <label class="form-check-label" for="${fieldName}">
                                Enable ${field.label}
                            </label>
                        </div>
                    `;
                } else {
                    const inputType = field.type === 'password' && !smtpEditMode ? 'password' : field.type;
                    const showValue = field.type === 'password' && !smtpEditMode ? 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢' : field.value;
                    const iconClass = getFieldIcon(field.type);
                    
                    html += `
                        <div class="input-container">
                            <div class="input-wrapper">
                                <i class="fas fa-${iconClass} input-icon"></i>
                                <input type="${inputType}" class="form-control modern-input" 
                                       id="${fieldName}" name="${fieldName}" 
                                       value="${showValue}" 
                                       placeholder="${field.placeholder || ''}"
                                       ${smtpEditMode ? '' : 'readonly'}>
                                ${field.type === 'password' && smtpEditMode ? `
                                    <button type="button" class="password-toggle" onclick="togglePassword('${fieldName}')">
                                        <i class="fas fa-eye" id="${fieldName}-toggle-icon"></i>
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }
                
                html += `
                            <div class="field-description">
                                ${field.description}
                            </div>
                        </div>
                    </div>
                `;
            }
        });
        
        html += `
                    </div>
                </div>
            </div>
        `;
    }
    
    // Add modern status summary
    html += `
        <div class="status-summary">
            <div class="status-header">
                <div class="status-info">
                    <h6 class="status-title">Configuration Progress</h6>
                    <p class="status-description">
                        ${status.configured_count} of ${status.total_required} required fields configured
                    </p>
                </div>
                <div class="status-percentage">
                    <span class="percentage-text">${status.percentage}%</span>
                </div>
            </div>
            <div class="progress-container">
                <div class="progress-bar-modern">
                    <div class="progress-fill ${status.config_status === 'complete' ? 'complete' : 'partial'}" 
                         style="width: ${status.percentage}%"></div>
                </div>
            </div>
            <div class="status-indicators">
                <div class="indicator-item">
                    <i class="fas fa-check-circle text-success"></i>
                    <span>${status.configured_count} Configured</span>
                </div>
                <div class="indicator-item">
                    <i class="fas fa-exclamation-triangle text-warning"></i>
                    <span>${status.total_required - status.configured_count} Missing</span>
                </div>
            </div>
        </div>
    `;
    
    container.innerHTML = html;
    actionsContainer.style.display = 'block';
}

function updateSMTPStatusBadge(status) {
    const statusBadge = document.getElementById('smtp-status-badge');
    
    if (status.config_status === 'complete') {
        statusBadge.textContent = 'Fully Configured';
        statusBadge.className = 'status-badge status-configured';
    } else if (status.config_status === 'partial') {
        statusBadge.textContent = `${status.configured_count}/${status.total_required} Configured`;
        statusBadge.className = 'status-badge status-pending';
    } else {
        statusBadge.textContent = 'Not Configured';
        statusBadge.className = 'status-badge status-missing';
    }
}

function toggleSMTPEditMode() {
    smtpEditMode = !smtpEditMode;
    
    const editBtn = document.getElementById('edit-smtp-btn');
    const saveBtn = document.getElementById('save-smtp-btn');
    const cancelBtn = document.getElementById('cancel-smtp-btn');
    
    if (smtpEditMode) {
        editBtn.innerHTML = '<i class="fas fa-eye"></i> View Mode';
        saveBtn.style.display = 'inline-block';
        cancelBtn.style.display = 'inline-block';
        
        // Re-render with editable fields
        loadSMTPConfig();
    } else {
        editBtn.innerHTML = '<i class="fas fa-edit"></i> Edit Configuration';
        saveBtn.style.display = 'none';
        cancelBtn.style.display = 'none';
        
        // Re-render in read-only mode
        loadSMTPConfig();
    }
}

function saveSMTPConfig() {
    const formData = {};
    const container = document.getElementById('smtp-config-container');
    
    // Collect all form data
    const inputs = container.querySelectorAll('input[name]');
    inputs.forEach(input => {
        if (input.type === 'checkbox') {
            formData[input.name] = input.checked;
        } else {
            formData[input.name] = input.value;
        }
    });
    
    // Show loading state
    const saveBtn = document.getElementById('save-smtp-btn');
    const originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    saveBtn.disabled = true;
    
    fetch('/admin/secrets/api/smtp/config', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', `SMTP configuration updated successfully! Updated ${data.updated_fields.length} fields.`);
            smtpEditMode = false;
            toggleSMTPEditMode();
            loadSMTPConfig();
        } else {
            showAlert('danger', `Error updating SMTP configuration: ${data.error}`);
        }
    })
    .catch(error => {
        console.error('Error saving SMTP config:', error);
        showAlert('danger', 'Failed to save SMTP configuration. Please try again.');
    })
    .finally(() => {
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
    });
}

function cancelSMTPEdit() {
    smtpEditMode = false;
    toggleSMTPEditMode();
}

function testSMTPConnection() {
    const testBtn = document.getElementById('test-smtp-btn');
    const originalText = testBtn.innerHTML;
    testBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
    testBtn.disabled = true;
    
    fetch('/admin/secrets/api/smtp/test', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
        } else {
            showAlert('danger', `SMTP test failed: ${data.error}`);
        }
    })
    .catch(error => {
        console.error('Error testing SMTP:', error);
        showAlert('danger', 'Failed to test SMTP connection. Please try again.');
    })
    .finally(() => {
        testBtn.innerHTML = originalText;
        testBtn.disabled = false;
    });
}

function showAlert(type, message) {
    const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    const container = document.querySelector('.secrets-section');
    container.insertAdjacentHTML('afterbegin', alertHtml);
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        const alert = container.querySelector('.alert');
        if (alert) {
            alert.remove();
        }
    }, 5000);
}

// Helper functions for modern UI
function getGroupIcon(groupName) {
    const icons = {
        'Server Settings': 'server',
        'Authentication': 'key',
        'Email Settings': 'envelope'
    };
    return icons[groupName] || 'cog';
}

function getFieldIcon(fieldType) {
    const icons = {
        'text': 'font',
        'email': 'envelope',
        'password': 'lock',
        'number': 'hashtag'
    };
    return icons[fieldType] || 'font';
}

function togglePassword(fieldId) {
    const input = document.getElementById(fieldId);
    const icon = document.getElementById(fieldId + '-toggle-icon');
    
    if (input.type === 'password') {
        input.type = 'text';
        icon.className = 'fas fa-eye-slash';
    } else {
        input.type = 'password';
        icon.className = 'fas fa-eye';
    }
}

function togglePasswordVisibility(fieldId) {
    const input = document.getElementById(fieldId);
    const toggle = document.getElementById(fieldId + '_toggle');
    
    if (input.type === 'password') {
        input.type = 'text';
        toggle.className = 'fas fa-eye-slash';
    } else {
        input.type = 'password';
        toggle.className = 'fas fa-eye';
    }
}

function toggleSMTPEditMode() {
    // Enable/disable all form fields
    const fields = document.querySelectorAll('#smtp input, #smtp select');
    fields.forEach(field => {
        field.readOnly = !field.readOnly;
        field.disabled = !field.disabled;
    });
    
    // Toggle button text
    const button = event.target.closest('button');
    if (button.innerHTML.includes('Configure')) {
        button.innerHTML = '<i class="fas fa-save"></i> Save Changes';
        button.className = 'btn btn-success btn-sm';
    } else {
        button.innerHTML = '<i class="fas fa-edit"></i> Configure';
        button.className = 'btn btn-outline-primary btn-sm';
    }
}

function testSMTPConnection() {
    // Show loading state
    const button = event.target.closest('button');
    const originalContent = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
    button.disabled = true;
    
    // Call the test API
    fetch('/admin/secrets/api/smtp/test', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('success', 'SMTP connection test successful!');
        } else {
            showNotification('danger', 'SMTP test failed: ' + data.error);
        }
    })
    .catch(error => {
        showNotification('danger', 'Error testing SMTP connection: ' + error.message);
    })
    .finally(() => {
        button.innerHTML = originalContent;
        button.disabled = false;
    });
}

function editSMTPConfig() {
    showNotification('info', 'SMTP configuration editing coming soon!');
}

function sendTestEmail() {
    showNotification('info', 'Test email functionality coming soon!');
}

function resetSMTPConfig() {
    if (confirm('Are you sure you want to reset all SMTP configuration? This action cannot be undone.')) {
        showNotification('warning', 'SMTP configuration reset functionality coming soon!');
    }
}

function showNotification(type, message) {
    // Create and show a toast notification
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 400px;';
    alertDiv.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}
    document.getElementById('secretModalTitle').textContent = 'Add New Secret';
    document.getElementById('secretCategory').value = category;
    document.getElementById('secretForm').reset();
    new bootstrap.Modal(document.getElementById('secretModal')).show();
}

function editSecret(name) {
    document.getElementById('secretModalTitle').textContent = 'Edit Secret: ' + name;
    document.getElementById('secretName').value = name;
    // Load existing values via AJAX
    loadSecretDetails(name);
    new bootstrap.Modal(document.getElementById('secretModal')).show();
}

function loadSecretDetails(name) {
    fetch(`/admin/secrets/api/secret/${name}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('secretDescription').value = data.secret.description || '';
                document.getElementById('secretCategory').value = data.secret.category || 'Application';
            }
        })
        .catch(error => console.error('Error loading secret:', error));
}

function saveSecret() {
    const form = document.getElementById('secretForm');
    const formData = new FormData(form);
    
    const secretData = {
        name: document.getElementById('secretName').value,
        value: document.getElementById('secretValue').value,
        description: document.getElementById('secretDescription').value,
        category: document.getElementById('secretCategory').value
    };

    fetch('/admin/secrets/api/secret', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(secretData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('secretModal')).hide();
            location.reload(); // Refresh to show updated data
        } else {
            alert('Error saving secret: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error saving secret:', error);
        alert('Error saving secret. Please try again.');
    });
}

function deleteSecret(name) {
    if (confirm('Are you sure you want to delete the secret: ' + name + '?')) {
        fetch(`/admin/secrets/api/secret/${name}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error deleting secret: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error deleting secret:', error);
            alert('Error deleting secret. Please try again.');
        });
    }
}

function testConnection(type) {
    fetch(`/admin/secrets/api/test/${type}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Connection test successful!');
        } else {
            alert('Connection test failed: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error testing connection:', error);
        alert('Error testing connection. Please try again.');
    });
}

function testEmailConnection() {
    testConnection('smtp');
}

function testOAuthConnection() {
    testConnection('oauth');
}

function importServiceNowConfig() {
    alert('ServiceNow configuration import functionality coming soon!');
}

function exportConfig() {
    window.location.href = '/admin/secrets/api/export';
}

function setupOAuthProvider() {
    alert('OAuth provider setup wizard coming soon!');
}

// Missing functions for new UI
function togglePasswordVisibility(fieldId) {
    const passwordField = document.getElementById(fieldId);
    const toggleIcon = passwordField.nextElementSibling?.querySelector('i') || document.getElementById(fieldId + '_toggle');
    
    if (passwordField.type === 'password') {
        passwordField.type = 'text';
        if (toggleIcon) toggleIcon.className = 'fas fa-eye-slash';
    } else {
        passwordField.type = 'password';
        if (toggleIcon) toggleIcon.className = 'fas fa-eye';
    }
}

function editServiceNowConfig() {
    alert('ServiceNow configuration edit functionality coming soon!');
}

function testServiceNowConnection() {
    testConnection('servicenow');
}

function saveServiceNowSettings() {
    alert('ServiceNow settings save functionality coming soon!');
}

function clearServiceNowSettings() {
    if (confirm('Are you sure you want to clear all ServiceNow settings?')) {
        alert('ServiceNow settings clear functionality coming soon!');
    }
}

function editSMTPConfig() {
    alert('SMTP configuration edit functionality coming soon!');
}

function testSMTPConnection() {
    testConnection('smtp');
}

function clearSMTPSettings() {
    if (confirm('Are you sure you want to clear all SMTP settings?')) {
        alert('SMTP settings clear functionality coming soon!');
    }
}

function addSMTPSetting() {
    alert('SMTP settings add functionality coming soon!');
}

function sendTestEmail() {
    alert('Test email functionality coming soon!');
}

function editApplicationConfig() {
    alert('Application configuration edit functionality coming soon!');
}

function testApplicationSettings() {
    alert('Application settings test functionality coming soon!');
}

function saveApplicationSettings() {
    alert('Application settings save functionality coming soon!');
}

function clearApplicationSettings() {
    if (confirm('Are you sure you want to clear all application settings?')) {
        alert('Application settings clear functionality coming soon!');
    }
}

function editOAuthConfig() {
    alert('OAuth configuration edit functionality coming soon!');
}

function saveOAuthSettings() {
    alert('OAuth settings save functionality coming soon!');
}

function clearOAuthSettings() {
    if (confirm('Are you sure you want to clear all OAuth settings?')) {
        alert('OAuth settings clear functionality coming soon!');
    }
}

// Auto-refresh functionality
setInterval(() => {
    // Optional: Auto-refresh data every 5 minutes
    // location.reload();
}, 300000);

// Tab functionality - Manual implementation for compatibility
document.addEventListener('DOMContentLoaded', function() {
    // Get all tab buttons and panes
    const tabButtons = document.querySelectorAll('[data-bs-toggle="tab"]');
    const tabPanes = document.querySelectorAll('.tab-pane');
    
    // Add click event listeners to tab buttons
    tabButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Remove active class from all buttons and panes
            tabButtons.forEach(btn => btn.classList.remove('active'));
            tabPanes.forEach(pane => {
                pane.classList.remove('active', 'show');
            });
            
            // Add active class to clicked button
            this.classList.add('active');
            
            // Show target pane
            const targetId = this.getAttribute('data-bs-target');
            const targetPane = document.querySelector(targetId);
            if (targetPane) {
                targetPane.classList.add('active', 'show');
            }
        });
    });
    
    // Ensure SMTP tab is active on load
    const smtpTab = document.getElementById('smtp-tab');
    const smtpPane = document.getElementById('smtp');
    if (smtpTab && smtpPane) {
        // Remove active from all
        tabButtons.forEach(btn => btn.classList.remove('active'));
        tabPanes.forEach(pane => {
            pane.classList.remove('active', 'show');
        });
        
        // Activate SMTP
        smtpTab.classList.add('active');
        smtpPane.classList.add('active', 'show');
    }
    
    // FORCE MODERN SMTP STYLING
    console.log('Applying modern SMTP styles...');
    
    // Find SMTP tab content
    const smtpTabContent = document.getElementById('smtp');
    if (smtpTabContent) {
        // Hide any old content that might interfere
        const oldSections = smtpTabContent.querySelectorAll('.config-section');
        oldSections.forEach(section => {
            section.style.display = 'none !important';
        });
        
        // Ensure modern container is visible and styled
        const modernContainer = smtpTabContent.querySelector('.smtp-modern-container');
        if (modernContainer) {
            modernContainer.style.display = 'block';
            modernContainer.style.background = '#ffffff';
            modernContainer.style.borderRadius = '12px';
            modernContainer.style.boxShadow = '0 4px 20px rgba(0, 0, 0, 0.1)';
            modernContainer.style.margin = '1.5rem 0';
            modernContainer.style.border = '1px solid rgba(59, 130, 246, 0.2)';
            
            // Style the header
            const header = modernContainer.querySelector('.smtp-header');
            if (header) {
                header.style.background = 'linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%)';
                header.style.padding = '2rem 2.5rem';
                header.style.borderBottom = '2px solid rgba(59, 130, 246, 0.1)';
                header.style.display = 'flex';
                header.style.justifyContent = 'space-between';
                header.style.alignItems = 'flex-start';
            }
            
            // Style all modern inputs
            const inputs = modernContainer.querySelectorAll('.modern-input');
            inputs.forEach(input => {
                input.style.width = '100%';
                input.style.padding = '0.875rem 1rem';
                input.style.border = '2px solid #e5e7eb';
                input.style.borderRadius = '8px';
                input.style.fontSize = '0.925rem';
                input.style.background = '#ffffff';
                input.style.color = '#374151';
                input.style.transition = 'all 0.2s ease';
            });
            
            // Style form rows
            const formRows = modernContainer.querySelectorAll('.form-row');
            formRows.forEach(row => {
                row.style.display = 'grid';
                row.style.gridTemplateColumns = '1fr 1fr';
                row.style.gap = '2rem';
                row.style.marginBottom = '2rem';
            });
            
            console.log('Modern SMTP styles applied successfully!');
        } else {
            console.error('Modern SMTP container not found!');
        }
    }
});
</script>
{% endblock %}