{% extends "base.html" %}

{% block title %}Secrets Management{% endblock %}

{% block extra_css %}
<style>
    /* Light, Clean Secrets Management Styling - Matching User Management */
    .management-container {
        background: linear-gradient(135deg, #f8fbff 0%, #e8f4f8 100%);
        min-height: 100vh;
        padding: 1.5rem 0;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .page-header {
        background: rgba(255, 255, 255, 0.98);
        border-radius: 12px;
        padding: 1.8rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        border: 1px solid rgba(230, 240, 250, 0.8);
    }

    .page-header h1 {
        color: #2c3e50;
        font-size: clamp(1.8rem, 4vw, 2.5rem);
        font-weight: 600;
        margin: 0;
        letter-spacing: -0.5px;
    }

    .page-header p {
        color: #6c757d;
        font-size: clamp(0.9rem, 2vw, 1.1rem);
        margin: 0.5rem 0 0 0;
    }

    .management-tabs {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        border: 1px solid rgba(230, 240, 250, 0.8);
    }

    .nav-tabs {
        border: none;
        background: linear-gradient(135deg, #f8fbff 0%, #e8f4f8 100%);
        border-radius: 12px 12px 0 0;
        padding: 0.5rem;
    }

    .nav-tabs .nav-link {
        color: #495057;
        font-weight: 500;
        font-size: clamp(0.9rem, 2vw, 1rem);
        border: none;
        border-radius: 8px;
        padding: 0.8rem 1.5rem;
        background: transparent;
        transition: all 0.3s ease;
        margin: 0 0.25rem;
    }

    .nav-tabs .nav-link:hover {
        background: rgba(25, 118, 210, 0.1);
        color: #1976d2;
        transform: translateY(-1px);
    }

    .nav-tabs .nav-link.active {
        background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
        color: white;
        box-shadow: 0 3px 10px rgba(33, 150, 243, 0.3);
    }

    .tab-content {
        padding: 1.5rem;
        background: white;
    }

    .secrets-section {
        background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        border: 1px solid rgba(56, 142, 255, 0.15);
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }

    .section-title {
        color: #1565c0;
        font-size: clamp(1.1rem, 2.5vw, 1.3rem);
        font-weight: 600;
        margin: 0;
    }

    .status-badge {
        padding: 0.4rem 0.8rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .status-configured {
        background: linear-gradient(135deg, #4caf50, #388e3c);
        color: white;
    }

    .status-pending {
        background: linear-gradient(135deg, #ff9800, #f57c00);
        color: white;
    }

    .status-missing {
        background: linear-gradient(135deg, #f44336, #d32f2f);
        color: white;
    }

    .data-table-container {
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 3px 15px rgba(0,0,0,0.08);
        border: 1px solid rgba(230, 240, 250, 0.8);
    }

    .table {
        margin-bottom: 0;
        font-size: clamp(0.85rem, 1.8vw, 0.95rem);
    }

    .table thead th {
        background: linear-gradient(135deg, #f8fbff 0%, #e8f4f8 100%);
        border: none;
        color: #2c3e50;
        font-weight: 600;
        font-size: clamp(0.8rem, 1.5vw, 0.9rem);
        letter-spacing: 0.3px;
        padding: 1rem 0.8rem;
    }

    .table tbody td {
        padding: 0.8rem;
        vertical-align: middle;
        border-color: #f1f3f4;
        color: #495057;
        font-size: clamp(0.85rem, 1.8vw, 0.95rem);
    }

    .table tbody tr:hover {
        background: rgba(33, 150, 243, 0.05);
        transition: background-color 0.2s ease;
    }

    .secret-actions {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .btn-sm {
        font-size: 0.8rem;
        padding: 0.4rem 0.8rem;
        border-radius: 6px;
        font-weight: 500;
    }

    .btn-outline-primary {
        border-color: #2196f3;
        color: #2196f3;
    }

    .btn-outline-primary:hover {
        background: #2196f3;
        border-color: #2196f3;
    }

    .btn-outline-success {
        border-color: #4caf50;
        color: #4caf50;
    }

    .btn-outline-success:hover {
        background: #4caf50;
        border-color: #4caf50;
    }

    .btn-outline-danger {
        border-color: #f44336;
        color: #f44336;
    }

    .btn-outline-danger:hover {
        background: #f44336;
        border-color: #f44336;
    }

    .empty-state {
        text-align: center;
        padding: 3rem 1.5rem;
        color: #6c757d;
    }

    .empty-state-icon {
        font-size: 3rem;
        color: #bbb;
        margin-bottom: 1rem;
    }

    .empty-state h5 {
        color: #495057;
        margin-bottom: 0.5rem;
    }

    .alert {
        border-radius: 8px;
        border: none;
        margin-bottom: 1rem;
    }

    .alert-info {
        background: linear-gradient(135deg, #e3f2fd 0%, #f0f9ff 100%);
        color: #1565c0;
        border-left: 4px solid #2196f3;
    }

    .config-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 1rem;
    }

    @media (max-width: 768px) {
        .section-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 1rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="management-container">
    <div class="container">
        <!-- Page Header -->
        <div class="page-header">
            <h1><i class="fas fa-shield-alt me-3"></i>Secrets Management</h1>
            <p>Comprehensive configuration management for application settings, SMTP, ServiceNow integrations, and more</p>
        </div>

        <!-- Secrets Management Sections -->
        <div class="management-tabs">
            <!-- Navigation Tabs -->
            <ul class="nav nav-tabs" id="secretsTabs">
                <li class="nav-item">
                    <button class="nav-link active" id="servicenow-tab" data-bs-toggle="tab" data-bs-target="#servicenow" type="button">
                        <i class="fab fa-servicestack me-2"></i>ServiceNow
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" id="smtp-tab" data-bs-toggle="tab" data-bs-target="#smtp" type="button">
                        <i class="fas fa-envelope me-2"></i>SMTP
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" id="application-tab" data-bs-toggle="tab" data-bs-target="#application" type="button">
                        <i class="fas fa-cogs me-2"></i>Application
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" id="oauth-tab" data-bs-toggle="tab" data-bs-target="#oauth" type="button">
                        <i class="fab fa-google me-2"></i>OAuth & SSO
                    </button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="secretsTabContent">
                <!-- ServiceNow Configuration -->
                <div class="tab-pane fade show active" id="servicenow" role="tabpanel">
                    <div class="secrets-section">
                        <div class="section-header">
                            <h5 class="section-title">ServiceNow Configuration</h5>
                            <span class="status-badge {% if servicenow_configured %}status-configured{% else %}status-missing{% endif %}">
                                {% if servicenow_configured %}Configured{% else %}Not Configured{% endif %}
                            </span>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Configure ServiceNow authentication parameters for ticket management integration.
                        </div>

                        <div class="data-table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Setting Name</th>
                                        <th>Description</th>
                                        <th>Last Updated</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for secret in secrets_by_category.get('ServiceNow', []) %}
                                    <tr>
                                        <td><strong>{{ secret.name }}</strong></td>
                                        <td>{{ secret.description or 'ServiceNow configuration parameter' }}</td>
                                        <td>{{ secret.updated_at }}</td>
                                        <td>
                                            <div class="secret-actions">
                                                <button class="btn btn-outline-primary btn-sm" onclick="editSecret('{{ secret.name }}')">
                                                    <i class="fas fa-edit"></i> Edit
                                                </button>
                                                <button class="btn btn-outline-success btn-sm" onclick="testConnection('servicenow')">
                                                    <i class="fas fa-check"></i> Test
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% else %}
                                    <tr>
                                        <td colspan="4">
                                            <div class="empty-state">
                                                <div class="empty-state-icon">
                                                    <i class="fab fa-servicestack"></i>
                                                </div>
                                                <h5>No ServiceNow Secrets</h5>
                                                <p>Configure ServiceNow integration to get started</p>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <div class="config-actions">
                            <button class="btn btn-primary" onclick="addSecret('ServiceNow')">
                                <i class="fas fa-plus"></i> Add ServiceNow Setting
                            </button>
                            <button class="btn btn-outline-secondary" onclick="importServiceNowConfig()">
                                <i class="fas fa-download"></i> Import Config
                            </button>
                        </div>
                    </div>
                </div>

                <!-- SMTP Configuration -->
                <div class="tab-pane fade" id="smtp" role="tabpanel">
                    <div class="secrets-section">
                        <div class="section-header">
                            <h5 class="section-title">SMTP Configuration</h5>
                            <span class="status-badge {% if smtp_configured %}status-configured{% else %}status-missing{% endif %}">
                                {% if smtp_configured %}Configured{% else %}Not Configured{% endif %}
                            </span>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Configure SMTP server mail settings for email notifications and alerts.
                        </div>

                        <div class="data-table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Setting Name</th>
                                        <th>Description</th>
                                        <th>Last Updated</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for secret in secrets_by_category.get('SMTP', []) %}
                                    <tr>
                                        <td><strong>{{ secret.name }}</strong></td>
                                        <td>{{ secret.description or 'SMTP server configuration' }}</td>
                                        <td>{{ secret.updated_at }}</td>
                                        <td>
                                            <div class="secret-actions">
                                                <button class="btn btn-outline-primary btn-sm" onclick="editSecret('{{ secret.name }}')">
                                                    <i class="fas fa-edit"></i> Edit
                                                </button>
                                                <button class="btn btn-outline-success btn-sm" onclick="testConnection('smtp')">
                                                    <i class="fas fa-check"></i> Test
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% else %}
                                    <tr>
                                        <td colspan="4">
                                            <div class="empty-state">
                                                <div class="empty-state-icon">
                                                    <i class="fas fa-envelope"></i>
                                                </div>
                                                <h5>No SMTP Secrets</h5>
                                                <p>Configure email settings to enable notifications</p>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <div class="config-actions">
                            <button class="btn btn-primary" onclick="addSecret('SMTP')">
                                <i class="fas fa-plus"></i> Add SMTP Setting
                            </button>
                            <button class="btn btn-outline-secondary" onclick="testEmailConnection()">
                                <i class="fas fa-paper-plane"></i> Send Test Email
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Application Configuration -->
                <div class="tab-pane fade" id="application" role="tabpanel">
                    <div class="secrets-section">
                        <div class="section-header">
                            <h5 class="section-title">Application Configuration</h5>
                            <span class="status-badge status-configured">Active</span>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            General application settings and API configurations.
                        </div>

                        <div class="data-table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Setting Name</th>
                                        <th>Description</th>
                                        <th>Last Updated</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for secret in secrets_by_category.get('Application', []) %}
                                    <tr>
                                        <td><strong>{{ secret.name }}</strong></td>
                                        <td>{{ secret.description or 'Application configuration setting' }}</td>
                                        <td>{{ secret.updated_at }}</td>
                                        <td>
                                            <div class="secret-actions">
                                                <button class="btn btn-outline-primary btn-sm" onclick="editSecret('{{ secret.name }}')">
                                                    <i class="fas fa-edit"></i> Edit
                                                </button>
                                                <button class="btn btn-outline-danger btn-sm" onclick="deleteSecret('{{ secret.name }}')">
                                                    <i class="fas fa-trash"></i> Delete
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% else %}
                                    <tr>
                                        <td colspan="4">
                                            <div class="empty-state">
                                                <div class="empty-state-icon">
                                                    <i class="fas fa-cogs"></i>
                                                </div>
                                                <h5>No Application Secrets</h5>
                                                <p>Add application configuration settings</p>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <div class="config-actions">
                            <button class="btn btn-primary" onclick="addSecret('Application')">
                                <i class="fas fa-plus"></i> Add Application Setting
                            </button>
                            <button class="btn btn-outline-secondary" onclick="exportConfig()">
                                <i class="fas fa-download"></i> Export Settings
                            </button>
                        </div>
                    </div>
                </div>

                <!-- OAuth & SSO Configuration -->
                <div class="tab-pane fade" id="oauth" role="tabpanel">
                    <div class="secrets-section">
                        <div class="section-header">
                            <h5 class="section-title">OAuth & SSO Configuration</h5>
                            <span class="status-badge {% if oauth_configured %}status-configured{% else %}status-pending{% endif %}">
                                {% if oauth_configured %}Configured{% else %}Pending{% endif %}
                            </span>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Configure OAuth client keys and SSO settings for user authentication.
                        </div>

                        <div class="data-table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Setting Name</th>
                                        <th>Description</th>
                                        <th>Last Updated</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for secret in secrets_by_category.get('OAuth', []) %}
                                    <tr>
                                        <td><strong>{{ secret.name }}</strong></td>
                                        <td>{{ secret.description or 'OAuth authentication setting' }}</td>
                                        <td>{{ secret.updated_at }}</td>
                                        <td>
                                            <div class="secret-actions">
                                                <button class="btn btn-outline-primary btn-sm" onclick="editSecret('{{ secret.name }}')">
                                                    <i class="fas fa-edit"></i> Edit
                                                </button>
                                                <button class="btn btn-outline-success btn-sm" onclick="testOAuthConnection()">
                                                    <i class="fas fa-check"></i> Test OAuth
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% else %}
                                    <tr>
                                        <td colspan="4">
                                            <div class="empty-state">
                                                <div class="empty-state-icon">
                                                    <i class="fab fa-google"></i>
                                                </div>
                                                <h5>No OAuth Secrets</h5>
                                                <p>Configure OAuth settings for single sign-on</p>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <div class="config-actions">
                            <button class="btn btn-primary" onclick="addSecret('OAuth')">
                                <i class="fas fa-plus"></i> Add OAuth Setting
                            </button>
                            <button class="btn btn-outline-secondary" onclick="setupOAuthProvider()">
                                <i class="fab fa-google"></i> Setup Google OAuth
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Secret Management Modal -->
<div class="modal fade" id="secretModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="secretModalTitle">Add Secret</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="secretForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-floating mb-3">
                                <input type="text" class="form-control" id="secretName" required>
                                <label for="secretName">Secret Name</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating mb-3">
                                <select class="form-select" id="secretCategory">
                                    <option value="ServiceNow">ServiceNow</option>
                                    <option value="SMTP">SMTP</option>
                                    <option value="Application">Application</option>
                                    <option value="OAuth">OAuth</option>
                                </select>
                                <label for="secretCategory">Category</label>
                            </div>
                        </div>
                    </div>
                    <div class="form-floating mb-3">
                        <textarea class="form-control" id="secretDescription" style="height: 80px"></textarea>
                        <label for="secretDescription">Description</label>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="password" class="form-control" id="secretValue" required>
                        <label for="secretValue">Secret Value</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveSecret()">Save Secret</button>
            </div>
        </div>
    </div>
</div>

<script>
// Enhanced secrets management functions
function addSecret(category) {
    document.getElementById('secretModalTitle').textContent = 'Add New Secret';
    document.getElementById('secretCategory').value = category;
    document.getElementById('secretForm').reset();
    new bootstrap.Modal(document.getElementById('secretModal')).show();
}

function editSecret(name) {
    document.getElementById('secretModalTitle').textContent = 'Edit Secret: ' + name;
    document.getElementById('secretName').value = name;
    // Load existing values via AJAX
    loadSecretDetails(name);
    new bootstrap.Modal(document.getElementById('secretModal')).show();
}

function loadSecretDetails(name) {
    fetch(`/admin/secrets/api/secret/${name}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('secretDescription').value = data.secret.description || '';
                document.getElementById('secretCategory').value = data.secret.category || 'Application';
            }
        })
        .catch(error => console.error('Error loading secret:', error));
}

function saveSecret() {
    const form = document.getElementById('secretForm');
    const formData = new FormData(form);
    
    const secretData = {
        name: document.getElementById('secretName').value,
        value: document.getElementById('secretValue').value,
        description: document.getElementById('secretDescription').value,
        category: document.getElementById('secretCategory').value
    };

    fetch('/admin/secrets/api/secret', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(secretData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('secretModal')).hide();
            location.reload(); // Refresh to show updated data
        } else {
            alert('Error saving secret: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error saving secret:', error);
        alert('Error saving secret. Please try again.');
    });
}

function deleteSecret(name) {
    if (confirm('Are you sure you want to delete the secret: ' + name + '?')) {
        fetch(`/admin/secrets/api/secret/${name}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error deleting secret: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error deleting secret:', error);
            alert('Error deleting secret. Please try again.');
        });
    }
}

function testConnection(type) {
    fetch(`/admin/secrets/api/test/${type}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Connection test successful!');
        } else {
            alert('Connection test failed: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error testing connection:', error);
        alert('Error testing connection. Please try again.');
    });
}

function testEmailConnection() {
    testConnection('smtp');
}

function testOAuthConnection() {
    testConnection('oauth');
}

function importServiceNowConfig() {
    alert('ServiceNow configuration import functionality coming soon!');
}

function exportConfig() {
    window.location.href = '/admin/secrets/api/export';
}

function setupOAuthProvider() {
    alert('OAuth provider setup wizard coming soon!');
}

// Auto-refresh functionality
setInterval(() => {
    // Optional: Auto-refresh data every 5 minutes
    // location.reload();
}, 300000);
</script>
{% endblock %}