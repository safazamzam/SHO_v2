{% extends 'base.html' %}
{% block content %}
<style>
/* Light, Clean User Management Styling */
.management-container {
    background: linear-gradient(135deg, #f8fbff 0%, #e8f4f8 100%);
    min-height: 100vh;
    padding: 1.5rem 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

.page-header {
    background: rgba(255, 255, 255, 0.98);
    border-radius: 12px;
    padding: 1.8rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    border: 1px solid rgba(230, 240, 250, 0.8);
}

.page-header h1 {
    color: #2c3e50;
    font-size: clamp(1.8rem, 4vw, 2.5rem);
    font-weight: 600;
    margin: 0;
    letter-spacing: -0.5px;
}

.page-header p {
    color: #6c757d;
    font-size: clamp(0.9rem, 2vw, 1.1rem);
    margin: 0.5rem 0 0 0;
}

.stats-cards {
    display: flex;
    gap: 1rem;
    margin-top: 1.5rem;
    flex-wrap: wrap;
}

.stat-card {
    background: linear-gradient(135deg, #e3f2fd 0%, #f0f9ff 100%);
    border-radius: 10px;
    padding: 1rem;
    text-align: center;
    border: 1px solid #b3d9ff;
    flex: 1;
    min-width: 120px;
}

.stat-number {
    font-size: clamp(1.5rem, 3vw, 2rem);
    font-weight: 700;
    color: #1976d2;
}

.stat-label {
    font-size: clamp(0.8rem, 1.5vw, 0.9rem);
    color: #5c6bc0;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.management-tabs {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    border: 1px solid rgba(230, 240, 250, 0.8);
}

.nav-tabs {
    border: none;
    background: linear-gradient(135deg, #f8fbff 0%, #e8f4f8 100%);
    border-radius: 12px 12px 0 0;
    padding: 0.5rem;
}

.nav-tabs .nav-link {
    color: #495057;
    font-weight: 500;
    font-size: clamp(0.9rem, 2vw, 1rem);
    border: none;
    border-radius: 8px;
    padding: 0.8rem 1.5rem;
    background: transparent;
    transition: all 0.3s ease;
    margin: 0 0.25rem;
}

.nav-tabs .nav-link:hover {
    background: rgba(25, 118, 210, 0.1);
    color: #1976d2;
    transform: translateY(-1px);
}

.nav-tabs .nav-link.active {
    background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
    color: white;
    box-shadow: 0 3px 10px rgba(33, 150, 243, 0.3);
}

.tab-content {
    padding: 1.5rem;
    background: white;
}

.add-form-card {
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    border-radius: 10px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    border: 1px solid rgba(56, 142, 255, 0.15);
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
}

.add-form-card h5 {
    color: #1565c0;
    font-size: clamp(1.1rem, 2.5vw, 1.3rem);
    font-weight: 600;
    margin-bottom: 1rem;
}

.form-floating {
    margin-bottom: 1rem;
}

.form-floating .form-control,
.form-floating .form-select {
    border-radius: 8px;
    border: 2px solid #e3f2fd;
    transition: all 0.3s ease;
    font-size: clamp(0.9rem, 2vw, 1rem);
    background-color: #fafbfc;
}

.form-floating .form-control:focus,
.form-floating .form-select:focus {
    border-color: #2196f3;
    box-shadow: 0 0 0 0.2rem rgba(33, 150, 243, 0.15);
    background-color: white;
}

.form-floating label {
    color: #6c757d;
    font-size: clamp(0.85rem, 1.8vw, 0.95rem);
}

.data-table-container {
    background: white;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 3px 15px rgba(0,0,0,0.08);
    border: 1px solid rgba(230, 240, 250, 0.8);
}

.table {
    margin-bottom: 0;
    font-size: clamp(0.85rem, 1.8vw, 0.95rem);
}

.table thead th {
    background: linear-gradient(135deg, #f8fbff 0%, #e8f4f8 100%);
    border: none;
    color: #2c3e50;
    font-weight: 600;
    font-size: clamp(0.8rem, 1.5vw, 0.9rem);
    letter-spacing: 0.3px;
    padding: 1rem 0.8rem;
}

.table tbody td {
    padding: 0.8rem;
    vertical-align: middle;
    border-color: #f1f3f4;
    color: #495057;
    font-size: clamp(0.85rem, 1.8vw, 0.95rem);
}

.table tbody tr:hover {
    background: rgba(33, 150, 243, 0.05);
    transition: background-color 0.2s ease;
}

/* User Avatar Styling */
.user-avatar {
    width: 35px;
    height: 35px;
    border-radius: 50%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    color: white;
    font-size: 0.9rem;
    margin-right: 0.8rem;
}

.user-avatar-img {
    width: 35px;
    height: 35px;
    border-radius: 50%;
    object-fit: cover;
    margin-right: 0.8rem;
    border: 2px solid rgba(255, 255, 255, 0.8);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

/* Status Badge Styling */
.status-badge {
    padding: 0.4rem 0.8rem;
    border-radius: 20px;
    font-weight: 500;
    font-size: clamp(0.75rem, 1.5vw, 0.85rem);
    text-transform: capitalize;
    letter-spacing: 0.3px;
}

.status-badge.active {
    background: linear-gradient(135deg, #c8e6c9 0%, #a5d6a7 100%);
    color: #2e7d32;
    border: 1px solid #81c784;
}

.status-badge.disabled {
    background: linear-gradient(135deg, #ffecb3 0%, #ffe082 100%);
    color: #f57c00;
    border: 1px solid #ffb74d;
}

/* Role Badge Styling */
.role-badge {
    padding: 0.3rem 0.7rem;
    border-radius: 15px;
    font-weight: 500;
    font-size: clamp(0.7rem, 1.4vw, 0.8rem);
    text-transform: capitalize;
    letter-spacing: 0.2px;
}

.role-badge.super-admin {
    background: linear-gradient(135deg, #ffcdd2 0%, #f8bbd9 100%);
    color: #c2185b;
}

.role-badge.account-admin {
    background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
    color: #ef6c00;
}

.role-badge.team-admin {
    background: linear-gradient(135deg, #e1f5fe 0%, #b3e5fc 100%);
    color: #0277bd;
}

.role-badge.user {
    background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
    color: #7b1fa2;
}

.role-badge.engineer {
    background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
    color: #388e3c;
}

/* Action Buttons */
.action-buttons {
    display: flex;
    gap: 0.4rem;
    flex-wrap: wrap;
    align-items: center;
}

.btn-sm {
    padding: 0.4rem 0.8rem;
    font-size: clamp(0.75rem, 1.5vw, 0.85rem);
    border-radius: 6px;
    font-weight: 500;
    transition: all 0.2s ease;
}

.btn-primary {
    background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
    border: none;
    color: white;
}

.btn-primary:hover {
    background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
    transform: translateY(-1px);
    box-shadow: 0 3px 8px rgba(33, 150, 243, 0.3);
}

.btn-warning {
    background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
    border: none;
    color: white;
}

.btn-warning:hover {
    background: linear-gradient(135deg, #f57c00 0%, #ef6c00 100%);
    transform: translateY(-1px);
    box-shadow: 0 3px 8px rgba(255, 152, 0, 0.3);
}

.btn-outline-danger {
    border: 2px solid #f44336;
    color: #f44336;
    background: transparent;
}

.btn-outline-danger:hover {
    background: #f44336;
    color: white;
    transform: translateY(-1px);
    box-shadow: 0 3px 8px rgba(244, 67, 54, 0.3);
}

/* Modal Styling */
.modal-content {
    border-radius: 12px;
    border: none;
    box-shadow: 0 10px 30px rgba(0,0,0,0.15);
}

.modal-header {
    background: linear-gradient(135deg, #f8fbff 0%, #e8f4f8 100%);
    border-bottom: 1px solid #e3f2fd;
    border-radius: 12px 12px 0 0;
}

.modal-title {
    color: #1976d2;
    font-weight: 600;
    font-size: clamp(1.1rem, 2.5vw, 1.3rem);
}

.modal-body {
    padding: 1.5rem;
}

.btn-close {
    background: none;
    border: none;
    font-size: 1.2rem;
    opacity: 0.6;
}

/* Responsive Design */
@media (max-width: 768px) {
    .management-container {
        padding: 1rem 0;
    }
    
    .page-header {
        padding: 1.2rem;
        margin-bottom: 1rem;
    }
    
    .stats-cards {
        flex-direction: column;
        gap: 0.8rem;
    }
    
    .stat-card {
        min-width: 100%;
    }
    
    .nav-tabs .nav-link {
        padding: 0.6rem 1rem;
        font-size: 0.9rem;
    }
    
    .tab-content {
        padding: 1rem;
    }
    
    .table-responsive {
        border-radius: 8px;
    }
    
    .action-buttons {
        flex-direction: column;
        gap: 0.3rem;
        width: 100%;
    }
    
    .action-buttons .btn {
        width: 100%;
        justify-content: center;
    }
    
    .modal-dialog {
        margin: 1rem;
    }
    
    .form-floating {
        margin-bottom: 0.8rem;
    }
}

@media (max-width: 576px) {
    .management-container {
        padding: 0.5rem 0;
    }
    
    .page-header h1 {
        font-size: 1.5rem;
    }
    
    .table thead th,
    .table tbody td {
        padding: 0.5rem 0.3rem;
        font-size: 0.8rem;
    }
    
    .btn-sm {
        padding: 0.3rem 0.6rem;
        font-size: 0.75rem;
    }
    
    .status-badge,
    .role-badge {
        font-size: 0.7rem;
        padding: 0.2rem 0.5rem;
    }
}

/* Loading and Animation States */
.fade-in {
    animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.table tbody tr {
    transition: all 0.2s ease;
}

.form-control:focus,
.form-select:focus {
    transform: translateY(-1px);
}

/* Account and Team name styling */
.account-name, .team-name {
    font-weight: 500;
    color: #1976d2;
    background: linear-gradient(135deg, #e3f2fd 0%, #f0f9ff 100%);
    padding: 0.3rem 0.6rem;
    border-radius: 8px;
    font-size: clamp(0.75rem, 1.5vw, 0.85rem);
    border: 1px solid #b3d9ff;
}

/* User Groups Styling */
.user-group {
    background: white;
    border-radius: 12px;
    margin-bottom: 1.5rem;
    box-shadow: 0 3px 15px rgba(0,0,0,0.08);
    border: 1px solid rgba(230, 240, 250, 0.8);
    overflow: hidden;
}

.group-header {
    background: linear-gradient(135deg, #f8fbff 0%, #e8f4f8 100%);
    padding: 1rem 1.5rem;
    border-bottom: 1px solid #e3f2fd;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.group-header:hover {
    background: linear-gradient(135deg, #e3f2fd 0%, #f0f9ff 100%);
}

.group-title {
    display: flex;
    align-items: center;
    margin: 0;
    font-size: clamp(1.1rem, 2.5vw, 1.3rem);
    font-weight: 600;
    color: #1976d2;
}

.group-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 1rem;
    font-size: 1.2rem;
    color: white;
}

.group-icon.super-admin {
    background: linear-gradient(135deg, #e91e63 0%, #c2185b 100%);
}

.group-icon.account-admin {
    background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
}

.group-icon.team-admin {
    background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
}

.group-icon.user {
    background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%);
}

.group-icon.engineer {
    background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);
}

.group-count {
    background: rgba(25, 118, 210, 0.1);
    color: #1976d2;
    padding: 0.3rem 0.8rem;
    border-radius: 20px;
    font-weight: 600;
    font-size: clamp(0.8rem, 1.5vw, 0.9rem);
}

.group-toggle {
    color: #1976d2;
    transition: transform 0.3s ease;
    font-size: 1.2rem;
}

.group-toggle.collapsed {
    transform: rotate(-90deg);
}

.group-content {
    padding: 0;
}

/* Action Buttons Alignment */
.action-buttons {
    display: flex;
    gap: 0.4rem;
    flex-wrap: nowrap;
    align-items: center;
    justify-content: flex-start;
}

.action-buttons .btn {
    white-space: nowrap;
    min-width: auto;
    flex-shrink: 0;
}

.action-buttons form {
    margin: 0;
}

.action-buttons .d-inline {
    display: inline-flex !important;
}

.btn-sm {
    padding: 0.4rem 0.8rem;
    font-size: clamp(0.75rem, 1.5vw, 0.85rem);
    border-radius: 6px;
    font-weight: 500;
    transition: all 0.2s ease;
    line-height: 1.2;
}

.group-table {
    margin: 0;
    border-collapse: separate;
    border-spacing: 0;
}

.group-table thead {
    display: none; /* Hide individual group headers */
}

.group-table tbody tr:last-child td {
    border-bottom: none;
}

.empty-group {
    padding: 2rem;
    text-align: center;
    color: #6c757d;
    background: #f8f9fa;
}

/* Responsive adjustments for groups */
@media (max-width: 768px) {
    .group-header {
        padding: 0.8rem 1rem;
    }
    
    .group-title {
        font-size: 1rem;
    }
    
    .group-icon {
        width: 35px;
        height: 35px;
        margin-right: 0.8rem;
        font-size: 1rem;
    }
}

/* Search functionality */
.search-container {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 3px 15px rgba(0,0,0,0.08);
    border: 1px solid rgba(230, 240, 250, 0.8);
}

.search-box {
    position: relative;
}

.search-input {
    padding: 0.8rem 1rem 0.8rem 3rem;
    border: 2px solid #e3f2fd;
    border-radius: 25px;
    font-size: clamp(0.9rem, 2vw, 1rem);
    transition: all 0.3s ease;
    background-color: #fafbfc;
    width: 100%;
}

.search-input:focus {
    border-color: #2196f3;
    box-shadow: 0 0 0 0.2rem rgba(33, 150, 243, 0.15);
    background-color: white;
    outline: none;
}

.search-icon {
    position: absolute;
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: #6c757d;
    pointer-events: none;
}

.search-controls {
    display: flex;
    gap: 1rem;
    align-items: center;
    margin-top: 1rem;
    flex-wrap: wrap;
}

.filter-btn {
    padding: 0.4rem 1rem;
    border-radius: 20px;
    border: 2px solid #e3f2fd;
    background: transparent;
    color: #1976d2;
    font-size: 0.85rem;
    font-weight: 500;
    transition: all 0.3s ease;
    cursor: pointer;
}

.filter-btn.active,
.filter-btn:hover {
    background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
    color: white;
    border-color: #1976d2;
}

.expand-collapse-all {
    display: flex;
    gap: 0.5rem;
    margin-left: auto;
}

.expand-collapse-all .btn {
    padding: 0.4rem 0.8rem;
    font-size: 0.85rem;
    border-radius: 6px;
}

.search-results-info {
    margin-top: 1rem;
    padding: 0.8rem;
    background: linear-gradient(135deg, #e8f5e8 0%, #f0f9f0 100%);
    border-radius: 8px;
    border: 1px solid #c8e6c9;
    color: #2e7d32;
    font-size: 0.9rem;
    display: none;
}

/* Highlight search results */
.search-highlight {
    background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
    padding: 0.1rem 0.3rem;
    border-radius: 3px;
    font-weight: 600;
}

/* Enhanced collapse animations */
.collapse {
    transition: all 0.4s ease;
}

.group-header {
    position: relative;
    overflow: hidden;
}

.group-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    transition: left 0.6s ease;
}

.group-header:hover::before {
    left: 100%;
}

.user-row {
    transition: all 0.3s ease;
}

.user-row.hidden {
    display: none;
}

.group-content.searching .user-row:not(.search-match) {
    opacity: 0.3;
    pointer-events: none;
}

.group-content.searching .user-row.search-match {
    background: rgba(33, 150, 243, 0.05);
    border-left: 3px solid #2196f3;
}

.btn-action {
    padding: 0.375rem 0.75rem;
    border-radius: 6px;
    font-size: 0.875rem;
    font-weight: 500;
    transition: all 0.3s ease;
}

.role-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 15px;
    font-size: 0.8rem;
    font-weight: 500;
}

.empty-state {
    text-align: center;
    padding: 3rem;
    color: #6c757d;
}

.stats-row {
    margin-bottom: 2rem;
}

.stat-card {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    border-left: 4px solid;
    transition: transform 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-2px);
}

.stat-number {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
}

.stat-label {
    color: #6c757d;
    font-weight: 500;
    text-transform: uppercase;
    font-size: 0.875rem;
    letter-spacing: 0.5px;
}
</style>

<div class="management-container">
    <div class="container">
        <!-- Flash Messages -->
        {% with messages = get_flashed_messages() %}
            {% if messages %}
                <div class="alert alert-info alert-dismissible fade show" role="alert">
                    <i class="bi bi-info-circle me-2"></i>
                    {% for message in messages %}
                        {{ message }}{% if not loop.last %}<br>{% endif %}
                    {% endfor %}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endif %}
        {% endwith %}

        <!-- Page Header -->
        <div class="page-header fade-in">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="mb-2">
                        <i class="bi bi-people-fill text-primary me-3"></i>
                        User Management
                    </h1>
                    <p class="text-muted mb-0">Manage users, teams, and accounts across your organization</p>
                </div>
                <div class="col-md-4">
                    <div class="stats-cards">
                        <div class="stat-card">
                            <div class="stat-number">{{ users|length }}</div>
                            <div class="stat-label">Total Users</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">{{ teams|length }}</div>
                            <div class="stat-label">Teams</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">{{ accounts|length }}</div>
                            <div class="stat-label">Accounts</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Management Tabs -->
        <div class="management-tabs">
            <ul class="nav nav-tabs" id="managementTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button" role="tab">
                        <i class="bi bi-person-lines-fill me-2"></i>Users
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="teams-tab" data-bs-toggle="tab" data-bs-target="#teams" type="button" role="tab">
                        <i class="bi bi-people me-2"></i>Teams
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="accounts-tab" data-bs-toggle="tab" data-bs-target="#accounts" type="button" role="tab">
                        <i class="bi bi-building me-2"></i>Accounts
                    </button>
                </li>
            </ul>

            <div class="tab-content" id="managementTabsContent">
                <!-- Users Tab -->
                <div class="tab-pane fade show active" id="users" role="tabpanel" aria-labelledby="users-tab">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h4 class="mb-0">
                            <i class="bi bi-person-plus text-primary me-2"></i>
                            User Management
                        </h4>
                        <span class="badge bg-primary fs-6 px-3 py-2">{{ users|length }} Users</span>
                    </div>

                    <!-- Add User Form -->
                    <div class="add-form-card">
                        <h5 class="mb-3">
                            <i class="bi bi-plus-circle text-primary me-2"></i>
                            Add New User
                        </h5>
                        <form method="post" action="/user-management">
                            <input type="hidden" name="action" value="add">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <input type="text" name="username" class="form-control" id="username" placeholder="Username" required>
                                        <label for="username">
                                            <i class="bi bi-person me-1"></i>Username
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <input type="password" name="password" class="form-control" id="password" placeholder="Password" required>
                                        <label for="password">
                                            <i class="bi bi-lock me-1"></i>Password
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <input type="text" name="first_name" class="form-control" id="first_name" placeholder="First Name">
                                        <label for="first_name">
                                            <i class="bi bi-person-badge me-1"></i>First Name
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <input type="text" name="last_name" class="form-control" id="last_name" placeholder="Last Name">
                                        <label for="last_name">
                                            <i class="bi bi-person-badge-fill me-1"></i>Last Name
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4" id="role-group">
                                    <div class="form-floating">
                                        <select name="role" class="form-select" id="role" required>
                                            <option value="user">User</option>
                                            <option value="team_admin">Team Admin</option>
                                            <option value="account_admin">Account Admin</option>
                                            <option value="super_admin">Super Admin</option>
                                        </select>
                                        <label for="role">
                                            <i class="bi bi-shield me-1"></i>Role
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4" id="account-group">
                                    <div class="form-floating">
                                        <select name="account_id" class="form-select" id="account_id" required>
                                            <option value="">Select Account</option>
                                            {% for account in accounts %}
                                                <option value="{{ account.id }}">{{ account.name }}</option>
                                            {% endfor %}
                                        </select>
                                        <label for="account_id">
                                            <i class="bi bi-building me-1"></i>Account
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4" id="team-group">
                                    <div class="form-floating">
                                        <select name="team_id" class="form-select" id="team_id">
                                            <option value="">(None)</option>
                                            {% for team in teams %}
                                                <option value="{{ team.id }}" data-account="{{ team.account_id }}">{{ team.name }}</option>
                                            {% endfor %}
                                        </select>
                                        <label for="team_id">
                                            <i class="bi bi-people me-1"></i>Team
                                        </label>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <button type="submit" class="btn btn-primary btn-lg px-4">
                                        <i class="bi bi-plus-circle me-2"></i>Add User
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>

                    <!-- Search and Filter Section -->
                    <div class="search-container fade-in">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="search-box">
                                    <i class="bi bi-search search-icon"></i>
                                    <input type="text" id="userSearch" class="search-input" placeholder="Search users by name, email, account, or team...">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="search-controls">
                                    <div class="expand-collapse-all">
                                        <button type="button" class="btn btn-outline-primary btn-sm" id="expandAll">
                                            <i class="bi bi-chevron-double-down me-1"></i>Expand All
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary btn-sm" id="collapseAll">
                                            <i class="bi bi-chevron-double-up me-1"></i>Collapse All
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="d-flex flex-wrap gap-2">
                                    <span class="text-muted small me-2">Filter by role:</span>
                                    <button type="button" class="filter-btn active" data-role="all">All Users</button>
                                    <button type="button" class="filter-btn" data-role="super_admin">Super Admins</button>
                                    <button type="button" class="filter-btn" data-role="account_admin">Account Admins</button>
                                    <button type="button" class="filter-btn" data-role="team_admin">Team Admins</button>
                                    <button type="button" class="filter-btn" data-role="user">Users</button>
                                </div>
                            </div>
                        </div>
                        <div class="search-results-info" id="searchResults">
                            <i class="bi bi-info-circle me-2"></i>
                            <span id="searchResultsText"></span>
                        </div>
                    </div>

                    <!-- Users Grouped by Role -->
                    <!-- Group users by role using Jinja2 groupby filter -->
                    {% set user_groups = users | groupby('role') %}
                    
                    {% set group_config = {
                        'super_admin': {'title': 'Super Administrators', 'icon': 'bi-shield-fill-exclamation', 'color': 'super-admin'},
                        'account_admin': {'title': 'Account Administrators', 'icon': 'bi-building-fill', 'color': 'account-admin'},
                        'team_admin': {'title': 'Team Administrators', 'icon': 'bi-people-fill', 'color': 'team-admin'},
                        'user': {'title': 'Users', 'icon': 'bi-person-fill', 'color': 'user'},
                        'engineer': {'title': 'Engineers', 'icon': 'bi-gear-fill', 'color': 'engineer'}
                    } %}
                    
                    {% for role, role_users in user_groups %}
                        {% if role_users %}
                        {% set role_config = group_config.get(role, {'title': role.title(), 'icon': 'bi-person-circle', 'color': 'user'}) %}
                        <div class="user-group fade-in">
                            <div class="group-header" data-bs-toggle="collapse" data-bs-target="#group-{{ role }}" aria-expanded="false">
                                <div class="group-title">
                                    <div class="group-icon {{ role_config['color'] }}">
                                        <i class="{{ role_config['icon'] }}"></i>
                                    </div>
                                    {{ role_config['title'] }}
                                    <span class="group-count ms-2">{{ role_users|length }}</span>
                                </div>
                                <i class="bi bi-chevron-down group-toggle collapsed"></i>
                            </div>
                            <div class="collapse" id="group-{{ role }}">
                                <div class="group-content">
                                    <div class="table-responsive">
                                        <table class="table group-table">
                                            <thead>
                                                <tr>
                                                    <th><i class="bi bi-person me-1"></i>User</th>
                                                    <th><i class="bi bi-building me-1"></i>Account</th>
                                                    <th><i class="bi bi-people me-1"></i>Team</th>
                                                    <th><i class="bi bi-check-circle me-1"></i>Status</th>
                                                    <th><i class="bi bi-gear me-1"></i>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for user in role_users %}
                                                <tr class="user-row" 
                                                    data-username="{{ user.username|lower }}" 
                                                    data-email="{{ user.email|lower if user.email else '' }}" 
                                                    data-role="{{ user.role }}"
                                                    data-account="{% for account in accounts %}{% if account.id == user.account_id %}{{ account.name|lower }}{% endif %}{% endfor %}"
                                                    data-team="{% for team in teams %}{% if team.id == user.team_id %}{{ team.name|lower }}{% endif %}{% endfor %}">
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            {% if user.profile_picture %}
                                                                <img src="{{ user.profile_picture }}" class="user-avatar-img" 
                                                                     alt="{{ user.display_name }}" 
                                                                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                                                <div class="user-avatar" style="display: none; background: linear-gradient(135deg, #{{ ['4f46e5', '06b6d4', 'f59e0b', 'ef4444', '10b981', '8b5cf6'][(user.username|length) % 6] }}, #{{ ['6366f1', '0891b2', 'd97706', 'dc2626', '059669', '7c3aed'][(user.username|length) % 6] }});">
                                                                    {{ user.initials }}
                                                                </div>
                                                            {% else %}
                                                                <div class="user-avatar" style="background: linear-gradient(135deg, #{{ ['4f46e5', '06b6d4', 'f59e0b', 'ef4444', '10b981', '8b5cf6'][(user.username|length) % 6] }}, #{{ ['6366f1', '0891b2', 'd97706', 'dc2626', '059669', '7c3aed'][(user.username|length) % 6] }});">
                                                                    {{ user.initials }}
                                                                </div>
                                                            {% endif %}
                                                            <div>
                                                                <strong class="user-name">{{ user.display_name }}</strong>
                                                                {% if user.email %}
                                                                    <div class="text-muted small user-email">{{ user.email }}</div>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        {% for account in accounts %}
                                                            {% if account.id == user.account_id %}
                                                                <span class="account-name">{{ account.name }}</span>
                                                            {% endif %}
                                                        {% endfor %}
                                                    </td>
                                                    <td>
                                                        {% for team in teams %}
                                                            {% if team.id == user.team_id %}
                                                                <span class="team-name">{{ team.name }}</span>
                                                            {% endif %}
                                                        {% else %}
                                                            <span class="text-muted">-</span>
                                                        {% endfor %}
                                                    </td>
                                                    <td>
                                                        {% if user.status == 'active' %}
                                                            <span class="status-badge active">
                                                                <i class="bi bi-check-circle me-1"></i>Active
                                                            </span>
                                                        {% else %}
                                                            <span class="status-badge disabled">
                                                                <i class="bi bi-pause-circle me-1"></i>Disabled
                                                            </span>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        {% if current_user.role == 'super_admin' or (current_user.role == 'account_admin' and user.role != 'super_admin') or (current_user.role == 'team_admin' and user.role == 'user') %}
                                                        <div class="action-buttons">
                                                            <!-- Edit Button -->
                                                            <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#editUserModal{{ user.id }}">
                                                                <i class="bi bi-pencil me-1"></i>Edit
                                                            </button>
                                                            
                                                            <form method="post" class="d-inline">
                                                                <input type="hidden" name="user_id" value="{{ user.id }}">
                                                                {% if user.status == 'active' %}
                                                                <input type="hidden" name="action" value="disable_user">
                                                                <button type="submit" class="btn btn-warning btn-sm">
                                                                    <i class="bi bi-pause-circle me-1"></i>Disable
                                                                </button>
                                                                {% else %}
                                                                <input type="hidden" name="action" value="enable_user">
                                                                <button type="submit" class="btn btn-success btn-sm">
                                                                    <i class="bi bi-play-circle me-1"></i>Enable
                                                                </button>
                                                                {% endif %}
                                                            </form>
                                                            {% if user.username != 'admin' %}
                                                            <form method="post" class="d-inline">
                                                                <input type="hidden" name="action" value="delete">
                                                                <input type="hidden" name="user_id" value="{{ user.id }}">
                                                                <button type="submit" class="btn btn-outline-danger btn-sm" onclick="return confirm('Are you sure you want to delete this user?')">
                                                                    <i class="bi bi-trash me-1"></i>Delete
                                                                </button>
                                                            </form>
                                                            {% endif %}
                                                        </div>
                                                        {% else %}
                                                        <span class="badge bg-light text-muted">
                                                            <i class="bi bi-shield-lock me-1"></i>Protected
                                                        </span>
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    {% endfor %}
                    
                    {% if not users %}
                    <div class="user-group fade-in">
                        <div class="empty-group">
                            <i class="bi bi-people text-muted" style="font-size: 3rem;"></i>
                            <p class="mt-3 mb-0">No users found</p>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Edit User Modals -->
                    {% for user in users %}
                    <div class="modal fade" id="editUserModal{{ user.id }}" tabindex="-1" aria-labelledby="editUserModalLabel{{ user.id }}" aria-hidden="true">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="editUserModalLabel{{ user.id }}">
                                        <i class="bi bi-pencil me-2"></i>Edit User: {{ user.display_name }}
                                    </h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <form method="post" action="/user-management">
                                    <div class="modal-body">
                                        <input type="hidden" name="action" value="edit_user">
                                        <input type="hidden" name="user_id" value="{{ user.id }}">
                                        
                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <div class="form-floating">
                                                    <input type="text" name="username" class="form-control" id="edit_username{{ user.id }}" 
                                                           value="{{ user.username }}" placeholder="Username" required>
                                                    <label for="edit_username{{ user.id }}">
                                                        <i class="bi bi-person me-1"></i>Username
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-floating">
                                                    <input type="email" name="email" class="form-control" id="edit_email{{ user.id }}" 
                                                           value="{{ user.email }}" placeholder="Email">
                                                    <label for="edit_email{{ user.id }}">
                                                        <i class="bi bi-envelope me-1"></i>Email
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-floating">
                                                    <input type="text" name="first_name" class="form-control" id="edit_first_name{{ user.id }}" 
                                                           value="{{ user.first_name or '' }}" placeholder="First Name">
                                                    <label for="edit_first_name{{ user.id }}">
                                                        <i class="bi bi-person-badge me-1"></i>First Name
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-floating">
                                                    <input type="text" name="last_name" class="form-control" id="edit_last_name{{ user.id }}" 
                                                           value="{{ user.last_name or '' }}" placeholder="Last Name">
                                                    <label for="edit_last_name{{ user.id }}">
                                                        <i class="bi bi-person-badge-fill me-1"></i>Last Name
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-floating">
                                                    <select name="role" class="form-select" id="edit_role{{ user.id }}" onchange="updateEditRoleFields({{ user.id }})" required>
                                                        {% if current_user.role == 'super_admin' %}
                                                            <option value="super_admin" {{ 'selected' if user.role == 'super_admin' else '' }}>Super Admin</option>
                                                            <option value="account_admin" {{ 'selected' if user.role == 'account_admin' else '' }}>Account Admin</option>
                                                            <option value="team_admin" {{ 'selected' if user.role == 'team_admin' else '' }}>Team Admin</option>
                                                            <option value="user" {{ 'selected' if user.role == 'user' else '' }}>User</option>
                                                        {% elif current_user.role == 'account_admin' %}
                                                            <option value="team_admin" {{ 'selected' if user.role == 'team_admin' else '' }}>Team Admin</option>
                                                            <option value="user" {{ 'selected' if user.role == 'user' else '' }}>User</option>
                                                        {% else %}
                                                            <option value="user" {{ 'selected' if user.role == 'user' else '' }}>User</option>
                                                        {% endif %}
                                                    </select>
                                                    <label for="edit_role{{ user.id }}">
                                                        <i class="bi bi-shield me-1"></i>Role
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="col-md-6" id="edit_account_group{{ user.id }}">
                                                <div class="form-floating">
                                                    <select name="account_id" class="form-select" id="edit_account_id{{ user.id }}" onchange="updateEditTeamOptions({{ user.id }})">
                                                        <option value="">Select Account</option>
                                                        {% for account in accounts %}
                                                            <option value="{{ account.id }}" {{ 'selected' if user.account_id == account.id else '' }}>{{ account.name }}</option>
                                                        {% endfor %}
                                                    </select>
                                                    <label for="edit_account_id{{ user.id }}">
                                                        <i class="bi bi-building me-1"></i>Account
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="col-md-6" id="edit_team_group{{ user.id }}">
                                                <div class="form-floating">
                                                    <select name="team_id" class="form-select" id="edit_team_id{{ user.id }}">
                                                        <option value="">Select Team</option>
                                                        {% for team in teams %}
                                                            <option value="{{ team.id }}" data-account="{{ team.account_id }}" {{ 'selected' if user.team_id == team.id else '' }}>{{ team.name }}</option>
                                                        {% endfor %}
                                                    </select>
                                                    <label for="edit_team_id{{ user.id }}">
                                                        <i class="bi bi-people me-1"></i>Team
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="col-12">
                                                <div class="form-floating">
                                                    <input type="password" name="new_password" class="form-control" id="edit_password{{ user.id }}" placeholder="New Password">
                                                    <label for="edit_password{{ user.id }}">
                                                        <i class="bi bi-lock me-1"></i>New Password (leave blank to keep current)
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                            <i class="bi bi-x-circle me-1"></i>Cancel
                                        </button>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="bi bi-check-circle me-1"></i>Update User
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- Teams Tab -->
                <div class="tab-pane fade" id="teams" role="tabpanel" aria-labelledby="teams-tab">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h4 class="mb-0">
                            <i class="bi bi-people text-success me-2"></i>
                            Team Management
                        </h4>
                        <span class="badge bg-success fs-6 px-3 py-2">{{ teams|length }} Teams</span>
                    </div>

                    <!-- Add Team Form -->
                    {% if current_user.role == 'super_admin' %}
                    <div class="add-form-card">
                        <h5 class="mb-3">
                            <i class="bi bi-plus-circle text-success me-2"></i>
                            Add New Team
                        </h5>
                        <form method="post" action="/user-management">
                            <input type="hidden" name="action" value="add_team">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <input type="text" name="team_name" class="form-control" id="team_name" placeholder="Team Name" required>
                                        <label for="team_name">
                                            <i class="bi bi-people me-1"></i>Team Name
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <select name="account_id" class="form-select" id="team_account_id" required>
                                            <option value="">Select Account</option>
                                            {% for account in accounts %}
                                                <option value="{{ account.id }}">{{ account.name }}</option>
                                            {% endfor %}
                                        </select>
                                        <label for="team_account_id">
                                            <i class="bi bi-building me-1"></i>Account
                                        </label>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <button type="submit" class="btn btn-success btn-lg px-4">
                                        <i class="bi bi-plus-circle me-2"></i>Add Team
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                    {% endif %}

                    <!-- Teams Table -->
                    <div class="data-table-container">
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>
                                            <i class="bi bi-people me-1"></i>Team
                                        </th>
                                        <th>
                                            <i class="bi bi-building me-1"></i>Account
                                        </th>
                                        <th>
                                            <i class="bi bi-check-circle me-1"></i>Status
                                        </th>
                                        <th>
                                            <i class="bi bi-gear me-1"></i>Actions
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for team in teams %}
                                    <tr>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="avatar-circle bg-success text-white me-3">
                                                    <i class="bi bi-people"></i>
                                                </div>
                                                <strong>{{ team.name }}</strong>
                                            </div>
                                        </td>
                                        <td>
                                            {% for account in accounts %}
                                                {% if account.id == team.account_id %}
                                                    <span class="text-primary fw-semibold">{{ account.name }}</span>
                                                {% endif %}
                                            {% endfor %}
                                        </td>
                                        <td>
                                            {% if team.status == 'active' %}
                                                <span class="status-badge bg-success text-white">
                                                    <i class="bi bi-check-circle me-1"></i>Active
                                                </span>
                                            {% else %}
                                                <span class="status-badge bg-secondary text-white">
                                                    <i class="bi bi-pause-circle me-1"></i>Disabled
                                                </span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if current_user.role == 'super_admin' or current_user.role == 'account_admin' %}
                                            <div class="action-buttons">
                                                <form method="post" class="d-inline">
                                                    <input type="hidden" name="team_id" value="{{ team.id }}">
                                                    {% if team.status == 'active' %}
                                                    <input type="hidden" name="action" value="disable_team">
                                                    <button type="submit" class="btn btn-warning btn-action btn-sm">
                                                        <i class="bi bi-pause-circle me-1"></i>Disable
                                                    </button>
                                                    {% else %}
                                                    <input type="hidden" name="action" value="enable_team">
                                                    <button type="submit" class="btn btn-success btn-action btn-sm">
                                                        <i class="bi bi-play-circle me-1"></i>Enable
                                                    </button>
                                                    {% endif %}
                                                </form>
                                                <form method="post" class="d-inline">
                                                    <input type="hidden" name="action" value="delete_team">
                                                    <input type="hidden" name="team_id" value="{{ team.id }}">
                                                    <button type="submit" class="btn btn-outline-danger btn-action btn-sm" onclick="return confirm('Are you sure you want to delete this team?')">
                                                        <i class="bi bi-trash me-1"></i>Delete
                                                    </button>
                                                </form>
                                            </div>
                                            {% else %}
                                            <span class="badge bg-light text-muted">
                                                <i class="bi bi-shield-lock me-1"></i>Protected
                                            </span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% else %}
                                    <tr>
                                        <td colspan="4" class="empty-state">
                                            <i class="bi bi-people text-muted" style="font-size: 3rem;"></i>
                                            <p class="mt-3">No teams found</p>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Accounts Tab -->
                <div class="tab-pane fade" id="accounts" role="tabpanel" aria-labelledby="accounts-tab">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h4 class="mb-0">
                            <i class="bi bi-building text-info me-2"></i>
                            Account Management
                        </h4>
                        <span class="badge bg-info fs-6 px-3 py-2">{{ accounts|length }} Accounts</span>
                    </div>

                    <!-- Add Account Form -->
                    {% if current_user.role == 'super_admin' %}
                    <div class="add-form-card">
                        <h5 class="mb-3">
                            <i class="bi bi-plus-circle text-info me-2"></i>
                            Add New Account
                        </h5>
                        <form method="post" action="/user-management">
                            <input type="hidden" name="action" value="add_account">
                            <div class="row g-3">
                                <div class="col-md-8">
                                    <div class="form-floating">
                                        <input type="text" name="account_name" class="form-control" id="account_name" placeholder="Account Name" required>
                                        <label for="account_name">
                                            <i class="bi bi-building me-1"></i>Account Name
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <button type="submit" class="btn btn-info btn-lg px-4 w-100">
                                        <i class="bi bi-plus-circle me-2"></i>Add Account
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                    {% endif %}

                    <!-- Accounts Table -->
                    <div class="data-table-container">
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>
                                            <i class="bi bi-building me-1"></i>Account
                                        </th>
                                        <th>
                                            <i class="bi bi-check-circle me-1"></i>Status
                                        </th>
                                        <th>
                                            <i class="bi bi-gear me-1"></i>Actions
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for account in accounts %}
                                    <tr>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="avatar-circle bg-info text-white me-3">
                                                    <i class="bi bi-building"></i>
                                                </div>
                                                <strong>{{ account.name }}</strong>
                                            </div>
                                        </td>
                                        <td>
                                            {% if account.status == 'active' %}
                                                <span class="status-badge bg-success text-white">
                                                    <i class="bi bi-check-circle me-1"></i>Active
                                                </span>
                                            {% else %}
                                                <span class="status-badge bg-secondary text-white">
                                                    <i class="bi bi-pause-circle me-1"></i>Disabled
                                                </span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if current_user.role == 'super_admin' %}
                                            <div class="action-buttons">
                                                <form method="post" class="d-inline">
                                                    <input type="hidden" name="account_id" value="{{ account.id }}">
                                                    {% if account.status == 'active' %}
                                                    <input type="hidden" name="action" value="disable_account">
                                                    <button type="submit" class="btn btn-warning btn-action btn-sm">
                                                        <i class="bi bi-pause-circle me-1"></i>Disable
                                                    </button>
                                                    {% else %}
                                                    <input type="hidden" name="action" value="enable_account">
                                                    <button type="submit" class="btn btn-success btn-action btn-sm">
                                                        <i class="bi bi-play-circle me-1"></i>Enable
                                                    </button>
                                                    {% endif %}
                                                </form>
                                                <form method="post" class="d-inline">
                                                    <input type="hidden" name="action" value="delete_account">
                                                    <input type="hidden" name="account_id" value="{{ account.id }}">
                                                    <button type="submit" class="btn btn-outline-danger btn-action btn-sm" onclick="return confirm('Are you sure you want to delete this account?')">
                                                        <i class="bi bi-trash me-1"></i>Delete
                                                    </button>
                                                </form>
                                            </div>
                                            {% else %}
                                            <span class="badge bg-light text-muted">
                                                <i class="bi bi-shield-lock me-1"></i>Protected
                                            </span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% else %}
                                    <tr>
                                        <td colspan="3" class="empty-state">
                                            <i class="bi bi-building text-muted" style="font-size: 3rem;"></i>
                                            <p class="mt-3">No accounts found</p>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Additional CSS for avatar circles -->
<style>
.avatar-circle {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    flex-shrink: 0;
}
</style>

<!-- JavaScript for form interactions -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Filter teams by selected account
    var accountSelect = document.getElementById('account_id');
    if (accountSelect) {
        accountSelect.addEventListener('change', function() {
            var selectedAccount = this.value;
            var teamSelect = document.getElementById('team_id');
            var options = teamSelect.options;
            for (var i = 0; i < options.length; i++) {
                var opt = options[i];
                if (!opt.value) { 
                    opt.style.display = ''; 
                    continue; 
                }
                if (opt.getAttribute('data-account') === selectedAccount) {
                    opt.style.display = '';
                } else {
                    opt.style.display = 'none';
                }
            }
            teamSelect.value = '';
        });
    }

    // Hide/show account/team fields based on role
    function updateRoleFields() {
        var roleSelect = document.getElementById('role');
        if (!roleSelect) return;
        
        var role = roleSelect.value;
        var accountGroup = document.getElementById('account-group');
        var teamGroup = document.getElementById('team-group');
        
        if (role === 'super_admin') {
            accountGroup.style.display = 'none';
            teamGroup.style.display = 'none';
        } else if (role === 'account_admin') {
            accountGroup.style.display = '';
            teamGroup.style.display = 'none';
        } else {
            accountGroup.style.display = '';
            teamGroup.style.display = '';
        }
    }

    var roleSelect = document.getElementById('role');
    if (roleSelect) {
        roleSelect.addEventListener('change', updateRoleFields);
        updateRoleFields(); // Initial call
    }
    
    // Functions for edit modals
    function updateEditRoleFields(userId) {
        var roleSelect = document.getElementById('edit_role' + userId);
        if (!roleSelect) return;
        
        var role = roleSelect.value;
        var accountGroup = document.getElementById('edit_account_group' + userId);
        var teamGroup = document.getElementById('edit_team_group' + userId);
        
        if (role === 'super_admin') {
            accountGroup.style.display = 'none';
            teamGroup.style.display = 'none';
        } else if (role === 'account_admin') {
            accountGroup.style.display = '';
            teamGroup.style.display = 'none';
        } else {
            accountGroup.style.display = '';
            teamGroup.style.display = '';
        }
    }
    
    function updateEditTeamOptions(userId) {
        var accountSelect = document.getElementById('edit_account_id' + userId);
        var teamSelect = document.getElementById('edit_team_id' + userId);
        if (!accountSelect || !teamSelect) return;
        
        var selectedAccount = accountSelect.value;
        var currentTeamValue = teamSelect.value; // Preserve current selection
        var options = teamSelect.getElementsByTagName('option');
        
        for (var i = 0; i < options.length; i++) {
            var opt = options[i];
            if (!opt.value) { 
                opt.style.display = ''; 
                continue; 
            }
            if (opt.getAttribute('data-account') === selectedAccount) {
                opt.style.display = '';
            } else {
                opt.style.display = 'none';
            }
        }
        
        // Only clear selection if current team doesn't belong to selected account
        if (currentTeamValue) {
            var currentTeamOption = teamSelect.querySelector('option[value="' + currentTeamValue + '"]');
            if (currentTeamOption && currentTeamOption.getAttribute('data-account') !== selectedAccount) {
                teamSelect.value = '';
            }
        }
    }
    
    // Initialize edit modals when they open
    document.addEventListener('shown.bs.modal', function (event) {
        var modal = event.target;
        if (modal.id.startsWith('editUserModal')) {
            var userId = modal.id.replace('editUserModal', '');
            updateEditRoleFields(userId);
            updateEditTeamOptions(userId);
        }
    });
    
    // Search functionality
    const searchInput = document.getElementById('userSearch');
    const searchResults = document.getElementById('searchResults');
    const searchResultsText = document.getElementById('searchResultsText');
    const filterButtons = document.querySelectorAll('.filter-btn');
    const expandAllBtn = document.getElementById('expandAll');
    const collapseAllBtn = document.getElementById('collapseAll');
    
    let currentFilter = 'all';
    
    // Search function
    function performSearch() {
        const searchTerm = searchInput.value.toLowerCase().trim();
        const userRows = document.querySelectorAll('.user-row');
        const userGroups = document.querySelectorAll('.user-group');
        let matchCount = 0;
        let visibleGroups = 0;
        
        userGroups.forEach(group => {
            const groupContent = group.querySelector('.group-content');
            const groupRows = group.querySelectorAll('.user-row');
            let groupHasMatches = false;
            
            groupRows.forEach(row => {
                const username = row.getAttribute('data-username') || '';
                const email = row.getAttribute('data-email') || '';
                const account = row.getAttribute('data-account') || '';
                const team = row.getAttribute('data-team') || '';
                const role = row.getAttribute('data-role') || '';
                
                const searchableText = (username + ' ' + email + ' ' + account + ' ' + team).toLowerCase();
                const roleMatch = currentFilter === 'all' || role === currentFilter;
                const textMatch = !searchTerm || searchableText.includes(searchTerm);
                
                if (roleMatch && textMatch) {
                    row.classList.remove('hidden');
                    row.classList.add('search-match');
                    groupHasMatches = true;
                    matchCount++;
                    
                    // Highlight search terms
                    if (searchTerm) {
                        highlightSearchTerm(row, searchTerm);
                    } else {
                        removeHighlights(row);
                    }
                } else {
                    row.classList.add('hidden');
                    row.classList.remove('search-match');
                }
            });
            
            // Show/hide entire group based on matches
            if (groupHasMatches) {
                group.style.display = '';
                visibleGroups++;
                // Auto-expand groups with search results
                if (searchTerm) {
                    const collapse = group.querySelector('.collapse');
                    const toggle = group.querySelector('.group-toggle');
                    if (collapse && !collapse.classList.contains('show')) {
                        collapse.classList.add('show');
                        toggle.classList.remove('collapsed');
                    }
                }
            } else {
                group.style.display = currentFilter === 'all' ? 'none' : '';
            }
            
            // Add searching class for styling
            if (searchTerm) {
                groupContent.classList.add('searching');
            } else {
                groupContent.classList.remove('searching');
            }
        });
        
        // Update search results info
        if (searchTerm) {
            searchResults.style.display = 'block';
            searchResultsText.textContent = `Found ${matchCount} user${matchCount !== 1 ? 's' : ''} matching "${searchTerm}"`;
        } else {
            searchResults.style.display = 'none';
        }
    }
    
    // Highlight search terms
    function highlightSearchTerm(row, term) {
        const nameElement = row.querySelector('.user-name');
        const emailElement = row.querySelector('.user-email');
        const accountElement = row.querySelector('.account-name');
        const teamElement = row.querySelector('.team-name');
        
        [nameElement, emailElement, accountElement, teamElement].forEach(element => {
            if (element && element.textContent) {
                const text = element.textContent;
                const regex = new RegExp(`(${term})`, 'gi');
                const highlightedText = text.replace(regex, '<span class="search-highlight">$1</span>');
                element.innerHTML = highlightedText;
            }
        });
    }
    
    // Remove highlights
    function removeHighlights(row) {
        const highlightedElements = row.querySelectorAll('.search-highlight');
        highlightedElements.forEach(element => {
            element.outerHTML = element.textContent;
        });
    }
    
    // Search input event listener
    if (searchInput) {
        searchInput.addEventListener('input', performSearch);
    }
    
    // Filter buttons
    filterButtons.forEach(button => {
        button.addEventListener('click', function() {
            // Update active button
            filterButtons.forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            
            // Update current filter
            currentFilter = this.getAttribute('data-role');
            
            // Perform search with new filter
            performSearch();
        });
    });
    
    // Expand all groups
    if (expandAllBtn) {
        expandAllBtn.addEventListener('click', function() {
            const collapses = document.querySelectorAll('.user-group .collapse');
            const toggles = document.querySelectorAll('.group-toggle');
            
            collapses.forEach(collapse => {
                collapse.classList.add('show');
            });
            
            toggles.forEach(toggle => {
                toggle.classList.remove('collapsed');
            });
        });
    }
    
    // Collapse all groups
    if (collapseAllBtn) {
        collapseAllBtn.addEventListener('click', function() {
            const collapses = document.querySelectorAll('.user-group .collapse');
            const toggles = document.querySelectorAll('.group-toggle');
            
            collapses.forEach(collapse => {
                collapse.classList.remove('show');
            });
            
            toggles.forEach(toggle => {
                toggle.classList.add('collapsed');
            });
        });
    }
    
    // Group toggle functionality (enhanced)
    document.addEventListener('click', function (event) {
        if (event.target.closest('.group-header')) {
            const header = event.target.closest('.group-header');
            const toggle = header.querySelector('.group-toggle');
            const target = header.getAttribute('data-bs-target');
            const collapse = document.querySelector(target);
            
            if (collapse) {
                // Toggle the chevron icon with smooth animation
                setTimeout(function() {
                    if (collapse.classList.contains('show')) {
                        toggle.classList.remove('collapsed');
                    } else {
                        toggle.classList.add('collapsed');
                    }
                }, 10);
            }
        }
    });
    
    // Initialize all group toggles (all collapsed by default)
    document.querySelectorAll('.group-toggle').forEach(function(toggle) {
        toggle.classList.add('collapsed');
    });
    
    // Ensure all collapse elements are hidden initially
    document.querySelectorAll('.user-group .collapse').forEach(function(collapse) {
        collapse.classList.remove('show');
    });
    
    // Initialize search on page load
    performSearch();
});
</script>

{% endblock %}
