{% extends "base.html" %}
{% block content %}
<div class="container-fluid px-0">
    <!-- Header Section -->
    <div class="mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="h3 mb-1 text-primary">Shift Roster Management</h1>
                <p class="text-muted mb-0">Manage and view team shift schedules and availability</p>
            </div>
            <div class="d-flex align-items-center gap-2">
                <span class="badge bg-primary fs-6 px-3 py-2">
                    <i class="bi bi-calendar3 me-2"></i>{{ selected_month }}/{{ selected_year }}
                </span>
                {% if all_members %}
                <span class="badge bg-success fs-6 px-3 py-2">
                    <i class="bi bi-people-fill me-2"></i>{{ all_members|length }} Members
                </span>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Filter Section -->
    {% if current_user.role in ['super_admin', 'account_admin'] %}
    <div class="card mb-4 border-0 shadow-sm">
        <div class="card-body py-3">
            <form method="get" class="row g-3 align-items-end">
                {% if current_user.role == 'super_admin' %}
                <div class="col-md-3">
                    <label for="account_id" class="form-label fw-semibold text-secondary">
                        <i class="bi bi-building me-1"></i>Account
                    </label>
                    <select name="account_id" id="account_id" class="form-select" onchange="updateTeamsDropdown(this.value)">
                        <option value="">All Accounts</option>
                        {% for account in accounts %}
                        <option value="{{ account.id }}" {% if account.id|string == request.args.get('account_id') %}selected{% endif %}>
                            {{ account.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                {% endif %}
                <div class="col-md-3">
                    <label for="team_id" class="form-label fw-semibold text-secondary">
                        <i class="bi bi-people me-1"></i>Team
                    </label>
                    <select name="team_id" id="team_id" class="form-select">
                        <option value="">All Teams</option>
                        {% for team in teams %}
                        <option value="{{ team.id }}" {% if team.id|string == request.args.get('team_id') %}selected{% endif %}>
                            {{ team.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-outline-primary">
                        <i class="bi bi-funnel me-1"></i>Filter
                    </button>
                </div>
            </form>
        </div>
    </div>
    {% endif %}

    <!-- Filter Controls Row -->
    <div class="row g-4 mb-4">
        <!-- Roster Table Filter -->
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-light border-0 py-3">
                    <h5 class="mb-0 text-secondary">
                        <i class="bi bi-calendar-month me-2"></i>Roster View Filter
                    </h5>
                </div>
                <div class="card-body">
                    <form method="GET" class="row g-3 align-items-end">
                        <div class="col-md-5">
                            <label for="month" class="form-label fw-semibold">Month</label>
                            <select name="month" id="month" class="form-select">
                                <option value="">All Months</option>
                                {% for m in months %}
                                <option value="{{ m }}" {% if m == months[selected_month-1] %}selected{% endif %}>{{ m }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="year" class="form-label fw-semibold">Year</label>
                            <select name="year" id="year" class="form-select">
                                <option value="">All Years</option>
                                {% for y in years %}
                                <option value="{{ y }}" {% if selected_year == y %}selected{% endif %}>{{ y }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="bi bi-search me-1"></i>View
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Present Team Filter -->
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-light border-0 py-3">
                    <h5 class="mb-0 text-secondary">
                        <i class="bi bi-person-check me-2"></i>Team Availability Filter
                    </h5>
                </div>
                <div class="card-body">
                    <form method="GET" class="row g-3 align-items-end">
                        <div class="col-md-5">
                            <label for="filter_date" class="form-label fw-semibold">Date</label>
                            <input type="date" name="filter_date" id="filter_date" class="form-control" 
                                   value="{{ filter_date or '' }}">
                        </div>
                        <div class="col-md-4">
                            <label for="filter_shift" class="form-label fw-semibold">Shift</label>
                            <select name="filter_shift" id="filter_shift" class="form-select">
                                <option value="">All Shifts</option>
                                <option value="D" {% if filter_shift == 'D' %}selected{% endif %}>Day</option>
                                <option value="E" {% if filter_shift == 'E' %}selected{% endif %}>Evening</option>
                                <option value="N" {% if filter_shift == 'N' %}selected{% endif %}>Night</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <button type="submit" class="btn btn-success w-100">
                                <i class="bi bi-people me-1"></i>Check
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Present Team Members Display -->
    {% if filter_date %}
        {% if filter_shift and present_members %}
        <div class="card mb-4 border-0 shadow-sm">
            <div class="card-header bg-success text-white py-3">
                <h5 class="mb-0">
                    <i class="bi bi-people-fill me-2"></i>Present Team Members - {{ filter_date }} 
                    ({% if filter_shift == 'D' %}Day{% elif filter_shift == 'E' %}Evening{% elif filter_shift == 'N' %}Night{% endif %} Shift)
                </h5>
            </div>
            <div class="card-body">
                <div class="row g-2">
                    {% for member in present_members %}
                    <div class="col-md-3">
                        <div class="d-flex align-items-center p-2 bg-light rounded">
                            <i class="bi bi-person-check-fill text-success me-2"></i>
                            <span class="fw-semibold">{{ member.name }}</span>
                        </div>
                    </div>
                    {% else %}
                    <div class="col-12">
                        <div class="alert alert-info mb-0">
                            <i class="bi bi-info-circle me-2"></i>No team members found for this shift.
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% elif present_members_by_shift %}
        <div class="card mb-4 border-0 shadow-sm">
            <div class="card-header bg-info text-white py-3">
                <h5 class="mb-0">
                    <i class="bi bi-calendar-day me-2"></i>Team Availability - {{ filter_date }} (All Shifts)
                </h5>
            </div>
            <div class="card-body">
                {% for code, members in present_members_by_shift.items() %}
                <div class="mb-4">
                    <h6 class="text-secondary mb-3">
                        <i class="bi bi-clock me-1"></i>
                        {% if code == 'D' %}Day Shift{% elif code == 'E' %}Evening Shift{% elif code == 'N' %}Night Shift{% elif code == 'LE' %}Late Evening Shift{% elif code == 'G' %}General Shift{% else %}{{ code }} Shift{% endif %}
                    </h6>
                    <div class="row g-2">
                        {% for member in members %}
                        <div class="col-md-3">
                            <div class="d-flex align-items-center p-2 bg-light rounded">
                                <i class="bi bi-person-check-fill 
                                   {% if code == 'D' %}text-warning{% elif code == 'E' %}text-primary{% elif code == 'N' %}text-dark{% else %}text-success{% endif %} me-2"></i>
                                <span class="fw-semibold">{{ member.name }}</span>
                            </div>
                        </div>
                        {% else %}
                        <div class="col-12">
                            <div class="alert alert-warning mb-0">
                                <i class="bi bi-exclamation-triangle me-2"></i>No team members scheduled for this shift.
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    {% endif %}

    <!-- Shift Legend -->
    <div class="card mb-4 border-0 shadow-sm">
        <div class="card-body py-3">
            <div class="d-flex flex-wrap gap-3 align-items-center">
                <span class="fw-semibold text-secondary me-2">
                    <i class="bi bi-palette me-1"></i>Shift Legend:
                </span>
                <span class="badge roster-shift-D fs-6 px-3 py-2">
                    <i class="bi bi-sun me-1"></i>Day
                </span>
                <span class="badge roster-shift-E fs-6 px-3 py-2">
                    <i class="bi bi-sunset me-1"></i>Evening
                </span>
                <span class="badge roster-shift-N fs-6 px-3 py-2">
                    <i class="bi bi-moon me-1"></i>Night
                </span>
                <span class="badge roster-shift-LE fs-6 px-3 py-2">
                    <i class="bi bi-moon-stars me-1"></i>Late Evening
                </span>
                <span class="badge roster-shift-G fs-6 px-3 py-2">
                    <i class="bi bi-clock me-1"></i>General
                </span>
                <span class="badge roster-shift-empty fs-6 px-3 py-2">
                    <i class="bi bi-dash-circle me-1"></i>Off Duty
                </span>
            </div>
        </div>
    </div>

    <!-- Roster Table -->
    {% if all_members|length == 0 or all_dates|length == 0 %}
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center py-5">
                <div class="mb-3">
                    <i class="bi bi-calendar-x" style="font-size: 3rem; color: #6c757d;"></i>
                </div>
                <h5 class="text-muted">No Roster Data Available</h5>
                <p class="text-muted mb-0">No roster data found for the selected filters. Please adjust your filters or upload roster data.</p>
            </div>
        </div>
    {% else %}
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 py-3">
                <h5 class="mb-0 text-secondary">
                    <i class="bi bi-table me-2"></i>Shift Roster - {{ selected_month }}/{{ selected_year }}
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover roster-heatmap-table mb-0">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th class="border-0 fw-semibold py-3 px-4 position-sticky start-0 bg-light" style="z-index: 10;">
                                    <i class="bi bi-person me-1"></i>Team Member
                                </th>
                                {% for date in all_dates %}
                                <th class="border-0 fw-semibold py-3 text-center" style="min-width: 50px;">
                                    <div class="d-flex flex-column align-items-center">
                                        <span class="fs-6">{{ date }}</span>
                                        <small class="text-muted">{{ date|date_day_name }}</small>
                                    </div>
                                </th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for member in all_members %}
                            <tr class="border-bottom">
                                <td class="fw-semibold py-3 px-4 position-sticky start-0 bg-white border-end" style="z-index: 5;">
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-person-circle text-secondary me-2"></i>
                                        {{ member.name }}
                                    </div>
                                </td>
                                {% for date in all_dates %}
                                    {% set shift_code = roster_data[member.name][date] %}
                                    <td class="text-center py-3 roster-cell
                                        {% if shift_code == 'D' %}roster-shift-D{% elif shift_code == 'E' %}roster-shift-E{% elif shift_code == 'N' %}roster-shift-N{% elif shift_code == 'LE' %}roster-shift-LE{% elif shift_code == 'G' %}roster-shift-G{% else %}roster-shift-empty{% endif %}"
                                        title="{% if shift_code %}{{ shift_code }} Shift{% else %}Off Duty{% endif %} - {{ date }}">
                                        {% if shift_code %}
                                            <span class="fw-bold">{{ shift_code }}</span>
                                        {% else %}
                                            <i class="bi bi-dash text-muted"></i>
                                        {% endif %}
                                    </td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    {% endif %}
</div>

<!-- JavaScript for Dynamic Team Loading -->
<script>
function updateTeamsDropdown(accountId) {
    const teamSelect = document.getElementById('team_id');
    
    if (!accountId) {
        teamSelect.innerHTML = '<option value="">All Teams</option>';
        return;
    }
    
    // Show loading state
    teamSelect.innerHTML = '<option value="">Loading teams...</option>';
    teamSelect.disabled = true;
    
    fetch('/get_teams?account_id=' + accountId)
        .then(response => response.json())
        .then(data => {
            teamSelect.innerHTML = '<option value="">All Teams</option>';
            data.teams.forEach(team => {
                teamSelect.innerHTML += `<option value="${team.id}">${team.name}</option>`;
            });
        })
        .catch(error => {
            console.error('Error loading teams:', error);
            teamSelect.innerHTML = '<option value="">Error loading teams</option>';
        })
        .finally(() => {
            teamSelect.disabled = false;
        });
}

// Add a filter to get day name from date
document.addEventListener('DOMContentLoaded', function() {
    // Add hover effects for roster cells
    const rosterCells = document.querySelectorAll('.roster-cell');
    rosterCells.forEach(cell => {
        cell.addEventListener('mouseenter', function() {
            this.style.transform = 'scale(1.1)';
            this.style.transition = 'transform 0.2s ease';
        });
        cell.addEventListener('mouseleave', function() {
            this.style.transform = 'scale(1)';
        });
    });
});
</script>

<!-- Custom Styles -->
<style>
.roster-cell {
    transition: all 0.2s ease;
    cursor: pointer;
    position: relative;
}

.roster-cell:hover {
    box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.25);
    z-index: 3;
}

.table-responsive {
    max-height: 600px;
    overflow-y: auto;
}

.sticky-top {
    position: sticky !important;
    top: 0;
    z-index: 10;
}

.position-sticky {
    position: sticky !important;
}

.start-0 {
    left: 0 !important;
}

.card {
    transition: box-shadow 0.2s ease;
}

.card:hover {
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1) !important;
}

/* Roster shift color improvements */
.roster-shift-D {
    background-color: #fff3cd;
    color: #856404;
    border: 1px solid #ffeaa7;
}

.roster-shift-E {
    background-color: #cfe2ff;
    color: #084298;
    border: 1px solid #b3d4fc;
}

.roster-shift-N {
    background-color: #d1ecf1;
    color: #0c5460;
    border: 1px solid #b8daff;
}

.roster-shift-LE {
    background-color: #e2e3e5;
    color: #41464b;
    border: 1px solid #d3d3d4;
}

.roster-shift-G {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.roster-shift-empty {
    background-color: #f8f9fa;
    color: #6c757d;
    border: 1px solid #e9ecef;
}

.text-primary {
    color: #0d6efd !important;
}

.text-secondary {
    color: #6c757d !important;
}

.badge {
    font-size: 0.875rem;
}
</style>

{% endblock %}

