{% extends 'base.html' %}
{% block content %}
<div class="container-fluid px-0">
    <!-- Header Section -->
    <div class="mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="h3 mb-1 text-primary">Key Points Updates</h1>
                <p class="text-muted mb-0">Track and manage daily updates for key points across teams</p>
            </div>
            <div class="d-flex align-items-center gap-2">
                {% if key_points %}
                <span class="badge bg-primary fs-6 px-3 py-2">
                    <i class="bi bi-list-check me-2"></i>{{ key_points|length }} Key Points
                </span>
                {% endif %}
                {% if date_filter %}
                <span class="badge bg-info fs-6 px-3 py-2">
                    <i class="bi bi-calendar-date me-2"></i>{{ date_filter }}
                </span>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="card mb-4 border-0 shadow-sm">
        <div class="card-header bg-light border-0 py-3">
            <h5 class="mb-0 text-secondary">
                <i class="bi bi-funnel me-2"></i>Filter Key Points
            </h5>
        </div>
        <div class="card-body">
            <form method="get" class="row g-3 align-items-end">
                {% if current_user.role == 'super_admin' %}
                <div class="col-md-3">
                    <label for="account_id" class="form-label fw-semibold text-secondary">
                        <i class="bi bi-building me-1"></i>Account
                    </label>
                    <select name="account_id" id="account_id" class="form-select" onchange="updateTeamsDropdown(this.value)">
                        <option value="">All Accounts</option>
                        {% for account in accounts %}
                        <option value="{{ account.id }}" {% if account.id|string == selected_account_id|string %}selected{% endif %}>
                            {{ account.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                {% endif %}
                <div class="col-md-3">
                    <label for="team_id" class="form-label fw-semibold text-secondary">
                        <i class="bi bi-people me-1"></i>Team
                    </label>
                    <select name="team_id" id="team_id" class="form-select">
                        <option value="">All Teams</option>
                        {% for team in teams %}
                        <option value="{{ team.id }}" {% if team.id|string == selected_team_id|string %}selected{% endif %}>
                            {{ team.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="status" class="form-label fw-semibold text-secondary">
                        <i class="bi bi-flag me-1"></i>Status
                    </label>
                    <select name="status" id="status" class="form-select">
                        <option value="all" {% if status_filter=='all' %}selected{% endif %}>All Status</option>
                        <option value="Open" {% if status_filter=='Open' %}selected{% endif %}>Open</option>
                        <option value="Closed" {% if status_filter=='Closed' %}selected{% endif %}>Closed</option>
                        <option value="In Progress" {% if status_filter=='In Progress' %}selected{% endif %}>In Progress</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="date" class="form-label fw-semibold text-secondary">
                        <i class="bi bi-calendar3 me-1"></i>Date
                    </label>
                    <input type="date" name="date" id="date" class="form-control" value="{{ date_filter or '' }}">
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-search me-1"></i>Filter
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Key Points Section -->
    {% if key_points %}
        <div class="row g-4">
            {% for kp in key_points %}
            <div class="col-12">
                <div class="card border-0 shadow-sm keypoint-card">
                    <div class="card-header bg-white border-0 py-3">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h5 class="mb-2 text-primary fw-bold">
                                    <i class="bi bi-bookmark me-2"></i>{{ kp.description }}
                                </h5>
                                <div class="d-flex flex-wrap gap-2 align-items-center">
                                    <span class="badge bg-{{ 'success' if kp.status == 'Closed' else 'warning' if kp.status == 'In Progress' else 'secondary' }} fs-6 px-3 py-2">
                                        {% if kp.status == 'Closed' %}<i class="bi bi-check-circle me-1"></i>{% elif kp.status == 'In Progress' %}<i class="bi bi-clock me-1"></i>{% else %}<i class="bi bi-circle me-1"></i>{% endif %}
                                        {{ kp.status }}
                                    </span>
                                    {% if kp.jira_id %}
                                    <span class="badge bg-info fs-6 px-3 py-2">
                                        <i class="bi bi-link-45deg me-1"></i>{{ kp.jira_id }}
                                    </span>
                                    {% else %}
                                    <span class="badge bg-light text-dark border fs-6 px-3 py-2">
                                        <i class="bi bi-dash-circle me-1"></i>No JIRA ID
                                    </span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Updates Section -->
                        <div class="mb-4">
                            <h6 class="mb-3 text-secondary">
                                <i class="bi bi-clock-history me-2"></i>Daily Updates
                                {% if updates_by_kp[kp.id] %}
                                <span class="badge bg-primary ms-2">{{ updates_by_kp[kp.id]|length }}</span>
                                {% endif %}
                            </h6>
                            
                            {% if updates_by_kp[kp.id] %}
                            <div class="updates-timeline">
                                {% for upd in updates_by_kp[kp.id] %}
                                <div class="update-item mb-3">
                                    <div class="card border-0 bg-light">
                                        <div class="card-body p-3">
                                            <div class="d-flex justify-content-between align-items-start mb-2">
                                                <div class="flex-grow-1">
                                                    <p class="mb-2 fw-semibold text-dark">{{ upd.update_text }}</p>
                                                    <div class="d-flex align-items-center gap-3">
                                                        <small class="text-muted">
                                                            <i class="bi bi-calendar3 me-1"></i>{{ upd.update_date }}
                                                        </small>
                                                        <small class="text-muted">
                                                            <i class="bi bi-person me-1"></i>{{ upd.updated_by }}
                                                        </small>
                                                    </div>
                                                </div>
                                                <div class="d-flex gap-1">
                                                    <a href="{{ url_for('keypoints.edit_keypoint_update', update_id=upd.id) }}" 
                                                       class="btn btn-sm btn-outline-primary" title="Edit Update">
                                                        <i class="bi bi-pencil"></i>
                                                    </a>
                                                    <form method="post" action="{{ url_for('keypoints.delete_keypoint_update', update_id=upd.id) }}" 
                                                          style="display:inline;" onsubmit="return confirm('Delete this update?');">
                                                        <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete Update">
                                                            <i class="bi bi-trash"></i>
                                                        </button>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <div class="text-center py-4">
                                <i class="bi bi-clock-history text-muted" style="font-size: 2rem;"></i>
                                <p class="text-muted mt-2 mb-0">No updates yet. Add the first update below.</p>
                            </div>
                            {% endif %}
                        </div>

                        <!-- Add Update Form -->
                        <div class="add-update-section">
                            <h6 class="mb-3 text-secondary">
                                <i class="bi bi-plus-circle me-2"></i>Add New Update
                            </h6>
                            <form method="post" action="{{ url_for('keypoints.add_keypoint_update', key_point_id=kp.id) }}" 
                                  class="card border-0 bg-light">
                                <div class="card-body p-3">
                                    <div class="row g-3 align-items-end">
                                        <div class="col-md-7">
                                            <label for="update_text_{{ kp.id }}" class="form-label fw-semibold text-secondary">
                                                <i class="bi bi-chat-text me-1"></i>Update Text
                                            </label>
                                            <textarea name="update_text" id="update_text_{{ kp.id }}" 
                                                    class="form-control" rows="2" 
                                                    placeholder="Describe the progress, changes, or status update..." required></textarea>
                                        </div>
                                        <div class="col-md-3">
                                            <label for="update_date_{{ kp.id }}" class="form-label fw-semibold text-secondary">
                                                <i class="bi bi-calendar3 me-1"></i>Date
                                            </label>
                                            <input type="date" name="update_date" id="update_date_{{ kp.id }}" 
                                                   class="form-control" value="{{ date_filter or '' }}">
                                        </div>
                                        <div class="col-md-2">
                                            <button type="submit" class="btn btn-success w-100">
                                                <i class="bi bi-plus me-1"></i>Add Update
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
    <!-- Empty State -->
    <div class="card border-0 shadow-sm">
        <div class="card-body text-center py-5">
            <div class="mb-3">
                <i class="bi bi-list-check" style="font-size: 3rem; color: #6c757d;"></i>
            </div>
            <h5 class="text-muted">No Key Points Found</h5>
            <p class="text-muted mb-0">No key points match your current filters. Try adjusting your search criteria.</p>
        </div>
    </div>
    {% endif %}
</div>

<!-- JavaScript for Dynamic Team Loading -->
<script>
function updateTeamsDropdown(accountId) {
    const teamSelect = document.getElementById('team_id');
    
    if (!accountId) {
        teamSelect.innerHTML = '<option value="">All Teams</option>';
        return;
    }
    
    // Show loading state
    teamSelect.innerHTML = '<option value="">Loading teams...</option>';
    teamSelect.disabled = true;
    
    fetch('/get_teams?account_id=' + accountId)
        .then(response => response.json())
        .then(data => {
            const selectedTeam = teamSelect.value;
            teamSelect.innerHTML = '<option value="">All Teams</option>';
            let foundSelected = false;
            
            data.teams.forEach(team => {
                let selected = '';
                if (selectedTeam == team.id.toString()) { 
                    selected = 'selected'; 
                    foundSelected = true; 
                }
                teamSelect.innerHTML += `<option value="${team.id}" ${selected}>${team.name}</option>`;
            });
            
            // Maintain selection state
            if (selectedTeam === '') {
                teamSelect.value = '';
            } else if (!foundSelected) {
                teamSelect.value = '';
            } else {
                teamSelect.value = selectedTeam;
            }
        })
        .catch(error => {
            console.error('Error loading teams:', error);
            teamSelect.innerHTML = '<option value="">Error loading teams</option>';
        })
        .finally(() => {
            teamSelect.disabled = false;
        });
}

// Add interactive effects
document.addEventListener('DOMContentLoaded', function() {
    // Add hover effects for keypoint cards
    const keypointCards = document.querySelectorAll('.keypoint-card');
    keypointCards.forEach(card => {
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-2px)';
            this.style.transition = 'transform 0.2s ease';
        });
        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
        });
    });

    // Add focus effects for textareas
    const textareas = document.querySelectorAll('textarea');
    textareas.forEach(textarea => {
        textarea.addEventListener('focus', function() {
            this.parentElement.parentElement.parentElement.style.borderColor = '#0d6efd';
            this.parentElement.parentElement.parentElement.style.borderWidth = '2px';
        });
        textarea.addEventListener('blur', function() {
            this.parentElement.parentElement.parentElement.style.borderColor = '';
            this.parentElement.parentElement.parentElement.style.borderWidth = '';
        });
    });
});
</script>

<!-- Custom Styles -->
<style>
.keypoint-card {
    transition: all 0.2s ease;
}

.keypoint-card:hover {
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
}

.updates-timeline {
    position: relative;
}

.update-item {
    position: relative;
}

.update-item::before {
    content: '';
    position: absolute;
    left: -20px;
    top: 12px;
    width: 8px;
    height: 8px;
    background-color: #0d6efd;
    border-radius: 50%;
    border: 2px solid #fff;
    box-shadow: 0 0 0 2px #0d6efd;
}

.update-item:not(:last-child)::after {
    content: '';
    position: absolute;
    left: -16px;
    top: 20px;
    width: 2px;
    height: calc(100% - 8px);
    background-color: #e9ecef;
}

.updates-timeline {
    padding-left: 20px;
    border-left: 2px solid #e9ecef;
    margin-left: 10px;
}

.add-update-section .card {
    transition: border-color 0.2s ease;
}

.badge {
    font-size: 0.875rem;
}

.text-primary {
    color: #0d6efd !important;
}

.text-secondary {
    color: #6c757d !important;
}

.fw-semibold {
    font-weight: 600 !important;
}

.btn:hover {
    transform: translateY(-1px);
    transition: transform 0.2s ease;
}

.card {
    transition: box-shadow 0.2s ease;
}
</style>

{% endblock %}

