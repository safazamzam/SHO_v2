{% extends "base.html" %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header" style="background: linear-gradient(135deg, #4a90e2 0%, #2c5aa0 100%); color: white;">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <h3 class="card-title mb-1" style="color: white !important;">
                                <i class="fas fa-exchange-alt me-2"></i>
                                Shift Handover Form
                            </h3>
                            <div class="small" style="color: rgba(255,255,255,0.8);">
                                <i class="fas fa-clock me-1"></i>
                                {{ current_time.strftime('%B %d, %Y at %I:%M %p') }}
                            </div>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-light text-dark px-3 py-2">
                                <i class="fas fa-clipboard-check me-1"></i>
                                Handover Documentation
                            </span>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <form method="POST">
                        <!-- Basic Information -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label for="handover_date" class="form-label">Handover Date</label>
                                <input type="date" class="form-control" id="handover_date" name="handover_date" 
                                       value="{{ today if today else '' }}" required>
                            </div>
                            <div class="col-md-6">
                                <label for="team_id" class="form-label">Team</label>
                                <select class="form-select" id="team_id" name="team_id" required>
                                    <option value="">Select Team</option>
                                    {% for team in teams %}
                                    <option value="{{ team.id }}">{{ team.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label for="current_shift_type" class="form-label">Current Shift</label>
                                <select class="form-select" id="current_shift_type" name="current_shift_type" required>
                                    <option value="">Select Shift</option>
                                    <option value="Morning" {{ 'selected' if current_shift_type == 'Morning' else '' }}>Morning</option>
                                    <option value="Evening" {{ 'selected' if current_shift_type == 'Evening' else '' }}>Evening</option>
                                    <option value="Night" {{ 'selected' if current_shift_type == 'Night' else '' }}>Night</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="next_shift_type" class="form-label">Next Shift</label>
                                <select class="form-select" id="next_shift_type" name="next_shift_type" required>
                                    <option value="">Select Shift</option>
                                    <option value="Morning" {{ 'selected' if next_shift_type == 'Morning' else '' }}>Morning</option>
                                    <option value="Evening" {{ 'selected' if next_shift_type == 'Evening' else '' }}>Evening</option>
                                    <option value="Night" {{ 'selected' if next_shift_type == 'Night' else '' }}>Night</option>
                                </select>
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label class="form-label">Current Shift Engineers</label>
                                <div class="border rounded p-3 bg-light" id="current_engineers_display">
                                    <div id="current_engineers_list">
                                        <span class="text-muted">Loading engineers...</span>
                                    </div>
                                </div>
                                <!-- Hidden input to store current engineers for form submission -->
                                <input type="hidden" id="current_engineers" name="current_engineers" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Next Shift Engineers</label>
                                <div class="border rounded p-3 bg-light" id="next_engineers_display">
                                    <div id="next_engineers_list">
                                        <span class="text-muted">Loading engineers...</span>
                                    </div>
                                </div>
                                <!-- Hidden input to store next engineers for form submission -->
                                <input type="hidden" id="next_engineers" name="next_engineers" />
                            </div>
                        </div>

                        <!-- Incidents Section -->
                        <div class="mb-4">
                            <h5 class="mb-4"><i class="fas fa-exclamation-triangle me-2"></i>Incidents Management</h5>
                            
                            <!-- Open Incidents -->
                            <div class="card mb-3">
                                <div class="card-header bg-warning bg-opacity-10 border-warning">
                                    <h6 class="mb-0"><i class="fas fa-folder-open me-2"></i>Open Incidents</h6>
                                </div>
                                <div class="card-body">
                                    <div id="open-incidents-container">
                                        <div class="incident-entry mb-3 border p-3 rounded">
                                            <div class="row">
                                                <div class="col-md-3">
                                                    <label class="form-label">Application Name</label>
                                                    <input type="text" class="form-control" name="open_incident_app[]" placeholder="Application Name">
                                                </div>
                                                <div class="col-md-3">
                                                    <label class="form-label">Incident ID</label>
                                                    <input type="text" class="form-control" name="open_incident_id[]" placeholder="INC0001234">
                                                </div>
                                                <div class="col-md-3">
                                                    <label class="form-label">Priority</label>
                                                    <select class="form-select" name="open_incident_priority[]">
                                                        <option value="Low">Low</option>
                                                        <option value="Medium">Medium</option>
                                                        <option value="High">High</option>
                                                        <option value="Critical">Critical</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-3">
                                                    <label class="form-label">Assigned To</label>
                                                    <select class="form-select next-engineers-select" name="open_incident_assigned[]">
                                                        <option value="">Select Next Shift Engineer</option>
                                                        <!-- Will be populated by JavaScript -->
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="row mt-2">
                                                <div class="col-11">
                                                    <label class="form-label">Description</label>
                                                    <textarea class="form-control" name="open_incident_description[]" rows="2" placeholder="Brief description of the open incident"></textarea>
                                                </div>
                                                <div class="col-1 d-flex align-items-end">
                                                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="this.closest('.incident-entry').remove()">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <button type="button" class="btn btn-outline-warning" onclick="addIncident('open')">
                                        <i class="fas fa-plus"></i> Add Open Incident
                                    </button>
                                </div>
                            </div>

                            <!-- Closed Incidents -->
                            <div class="card mb-3">
                                <div class="card-header bg-success bg-opacity-10 border-success">
                                    <h6 class="mb-0"><i class="fas fa-check-circle me-2"></i>Closed Incidents</h6>
                                </div>
                                <div class="card-body">
                                    <div id="closed-incidents-container">
                                        <div class="incident-entry mb-3 border p-3 rounded">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <label class="form-label">Application Name</label>
                                                    <input type="text" class="form-control" name="closed_incident_app[]" placeholder="Application Name">
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label">Incident ID</label>
                                                    <input type="text" class="form-control" name="closed_incident_id[]" placeholder="INC0001234">
                                                </div>
                                            </div>
                                            <div class="row mt-2">
                                                <div class="col-11">
                                                    <label class="form-label">Resolution Summary</label>
                                                    <textarea class="form-control" name="closed_incident_resolution[]" rows="2" placeholder="Brief summary of how the incident was resolved"></textarea>
                                                </div>
                                                <div class="col-1 d-flex align-items-end">
                                                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="this.closest('.incident-entry').remove()">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <button type="button" class="btn btn-outline-success" onclick="addIncident('closed')">
                                        <i class="fas fa-plus"></i> Add Closed Incident
                                    </button>
                                </div>
                            </div>

                            <!-- Priority Incidents -->
                            <div class="card mb-3">
                                <div class="card-header bg-danger bg-opacity-10 border-danger">
                                    <h6 class="mb-0"><i class="fas fa-star me-2"></i>Priority Incidents</h6>
                                </div>
                                <div class="card-body">
                                    <div id="priority-incidents-container">
                                        <div class="incident-entry mb-3 border p-3 rounded">
                                            <div class="row">
                                                <div class="col-md-3">
                                                    <label class="form-label">Application Name</label>
                                                    <input type="text" class="form-control" name="priority_incident_app[]" placeholder="Application Name">
                                                </div>
                                                <div class="col-md-3">
                                                    <label class="form-label">Incident ID</label>
                                                    <input type="text" class="form-control" name="priority_incident_id[]" placeholder="INC0001234">
                                                </div>
                                                <div class="col-md-3">
                                                    <label class="form-label">Priority Level</label>
                                                    <select class="form-select" name="priority_incident_level[]">
                                                        <option value="High">High</option>
                                                        <option value="Critical">Critical</option>
                                                        <option value="Emergency">Emergency</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-3">
                                                    <label class="form-label">Escalated To</label>
                                                    <input type="text" class="form-control" name="priority_incident_escalated[]" placeholder="Manager/Team">
                                                </div>
                                            </div>
                                            <div class="row mt-2">
                                                <div class="col-11">
                                                    <label class="form-label">Impact & Actions Taken</label>
                                                    <textarea class="form-control" name="priority_incident_impact[]" rows="2" placeholder="Business impact and actions taken"></textarea>
                                                </div>
                                                <div class="col-1 d-flex align-items-end">
                                                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="this.closest('.incident-entry').remove()">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <button type="button" class="btn btn-outline-danger" onclick="addIncident('priority')">
                                        <i class="fas fa-plus"></i> Add Priority Incident
                                    </button>
                                </div>
                            </div>

                            <!-- Handover Incidents -->
                            <div class="card mb-3">
                                <div class="card-header bg-info bg-opacity-10 border-info">
                                    <h6 class="mb-0"><i class="fas fa-hand-paper me-2"></i>Handover Incidents</h6>
                                </div>
                                <div class="card-body">
                                    <div id="handover-incidents-container">
                                        <div class="incident-entry mb-3 border p-3 rounded">
                                            <div class="row">
                                                <div class="col-md-3">
                                                    <label class="form-label">Application Name</label>
                                                    <input type="text" class="form-control" name="handover_incident_app[]" placeholder="Application Name">
                                                </div>
                                                <div class="col-md-3">
                                                    <label class="form-label">Incident ID</label>
                                                    <input type="text" class="form-control" name="handover_incident_id[]" placeholder="INC0001234">
                                                </div>
                                                <div class="col-md-3">
                                                    <label class="form-label">Current Status</label>
                                                    <select class="form-select" name="handover_incident_status[]">
                                                        <option value="Monitoring">Monitoring</option>
                                                        <option value="Pending Vendor">Pending Vendor</option>
                                                        <option value="Pending Customer">Pending Customer</option>
                                                        <option value="In Progress">In Progress</option>
                                                        <option value="Waiting for Approval">Waiting for Approval</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-3">
                                                    <label class="form-label">Next Action By</label>
                                                    <select class="form-select next-engineers-select" name="handover_incident_next_by[]">
                                                        <option value="">Select Next Shift Engineer</option>
                                                        <!-- Will be populated by JavaScript -->
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="row mt-2">
                                                <div class="col-11">
                                                    <label class="form-label">Handover Notes & Next Actions</label>
                                                    <textarea class="form-control" name="handover_incident_notes[]" rows="3" placeholder="Important notes for the next shift and specific actions to be taken"></textarea>
                                                </div>
                                                <div class="col-1 d-flex align-items-end">
                                                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="this.closest('.incident-entry').remove()">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <button type="button" class="btn btn-outline-info" onclick="addIncident('handover')">
                                        <i class="fas fa-plus"></i> Add Handover Incident
                                    </button>
                                </div>
                            </div>

                            <!-- Escalated Incidents -->
                            <div class="card mb-3">
                                <div class="card-header bg-secondary bg-opacity-10 border-secondary">
                                    <h6 class="mb-0"><i class="fas fa-level-up-alt me-2"></i>Escalated Incidents</h6>
                                </div>
                                <div class="card-body">
                                    <div id="escalated-incidents-container">
                                        <div class="incident-entry mb-3 border p-3 rounded">
                                            <div class="row">
                                                <div class="col-md-4">
                                                    <label class="form-label">Application Name</label>
                                                    <input type="text" class="form-control" name="escalated_incident_app[]" placeholder="Application Name">
                                                </div>
                                                <div class="col-md-4">
                                                    <label class="form-label">Incident ID</label>
                                                    <input type="text" class="form-control" name="escalated_incident_id[]" placeholder="INC0001234">
                                                </div>
                                                <div class="col-md-4">
                                                    <label class="form-label">Escalated To</label>
                                                    <input type="text" class="form-control" name="escalated_incident_to[]" placeholder="Person/Team Name">
                                                </div>
                                            </div>
                                            <div class="row mt-2">
                                                <div class="col-md-6">
                                                    <label class="form-label">Escalation Reason</label>
                                                    <textarea class="form-control" name="escalated_incident_reason[]" rows="2" placeholder="Why was this incident escalated?"></textarea>
                                                </div>
                                                <div class="col-md-5">
                                                    <label class="form-label">Current Status & Next Steps</label>
                                                    <textarea class="form-control" name="escalated_incident_status[]" rows="2" placeholder="Current status and expected next steps"></textarea>
                                                </div>
                                                <div class="col-md-1 d-flex align-items-end">
                                                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="this.closest('.incident-entry').remove()">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <button type="button" class="btn btn-outline-secondary" onclick="addIncident('escalated')">
                                        <i class="fas fa-plus"></i> Add Escalated Incident
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Key Points Section -->
                        <div class="mb-4">
                            <h5>Key Points</h5>
                            <div id="keypoints-container">
                                {% for kp in open_key_points %}
                                <div class="keypoint-entry mb-3 border p-3 rounded">
                                    <div class="row">
                                        <div class="col-md-5">
                                            <label class="form-label">Key Point Details</label>
                                            <textarea class="form-control" name="keypoint_description[]" style="height: 38px; resize: vertical; min-height: 38px;" placeholder="Describe the key point details">{{ kp.description if kp else '' }}</textarea>
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label">Assigned To</label>
                                            <select class="form-control keypoint-team-member-dropdown" name="keypoint_assigned_to[]">
                                                <option value="">Select Team Member</option>
                                                {% for member in team_members %}
                                                <option value="{{ member.name }}" {{ 'selected' if kp and kp.assigned_to == member.name else '' }}>{{ member.name }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label">Status</label>
                                            <select class="form-control" name="keypoint_status[]">
                                                <option value="Open" {{ 'selected' if kp and kp.status == 'Open' else '' }}>Open</option>
                                                <option value="In Progress" {{ 'selected' if kp and kp.status == 'In Progress' else '' }}>In Progress</option>
                                                <option value="Closed" {{ 'selected' if kp and kp.status == 'Closed' else '' }}>Closed</option>
                                            </select>
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label">JIRA ID <span class="text-muted">(Optional)</span></label>
                                            <input type="text" class="form-control" name="keypoint_jira_id[]" value="{{ kp.jira_id if kp else '' }}" placeholder="JIRA-123">
                                        </div>
                                        <div class="col-md-1 d-flex align-items-end">
                                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="this.closest('.keypoint-entry').remove()">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                                <!-- Add at least one empty keypoint if none exist -->
                                {% if not open_key_points %}
                                <div class="keypoint-entry mb-3 border p-3 rounded">
                                    <div class="row">
                                        <div class="col-md-5">
                                            <label class="form-label">Key Point Details</label>
                                            <textarea class="form-control" name="keypoint_description[]" style="height: 38px; resize: vertical; min-height: 38px;" placeholder="Describe the key point details"></textarea>
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label">Assigned To</label>
                                            <select class="form-control keypoint-team-member-dropdown" name="keypoint_assigned_to[]">
                                                <option value="">Select Team Member</option>
                                                {% for member in team_members %}
                                                <option value="{{ member.name }}">{{ member.name }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label">Status</label>
                                            <select class="form-control" name="keypoint_status[]">
                                                <option value="Open" selected>Open</option>
                                                <option value="In Progress">In Progress</option>
                                                <option value="Closed">Closed</option>
                                            </select>
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label">JIRA ID <span class="text-muted">(Optional)</span></label>
                                            <input type="text" class="form-control" name="keypoint_jira_id[]" placeholder="JIRA-123">
                                        </div>
                                        <div class="col-md-1 d-flex align-items-end">
                                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="this.closest('.keypoint-entry').remove()">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                            <button type="button" class="btn btn-outline-primary" onclick="addKeyPoint()">
                                <i class="fas fa-plus"></i> Add Another Key Point
                            </button>
                        </div>

                        <!-- Additional Notes -->
                        <div class="mb-4">
                            <label for="additional_notes" class="form-label">Additional Notes</label>
                            <textarea class="form-control" id="additional_notes" name="additional_notes" rows="4" placeholder="Any additional information or notes for the next shift"></textarea>
                        </div>

                        <!-- Submit Buttons -->
                        <div class="text-end">
                            <button type="submit" name="action" value="draft" class="btn btn-secondary me-3" style="background: linear-gradient(135deg, #6c757d, #495057); border: none; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'">
                                <i class="fas fa-save me-2"></i>
                                Save as Draft
                            </button>
                            <button type="submit" name="action" value="submit" class="btn btn-primary" style="background: linear-gradient(135deg, #007bff, #0056b3); border: none; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'">
                                <i class="fas fa-paper-plane me-2"></i>
                                Submit Handover
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Page initialization
document.addEventListener('DOMContentLoaded', function() {
    // Initialize team member dropdowns for keypoints
    updateKeypointTeamMembersDropdowns();
    
    // Initialize engineer dropdowns for incidents if date and shift are available
    const dateElement = document.getElementById('handover_date');
    const nextShiftElement = document.getElementById('next_shift_type');
    
    if (dateElement && nextShiftElement) {
        const date = dateElement.value;
        const nextShift = nextShiftElement.value;
        if (date && nextShift) {
            updateIncidentEngineersDropdowns(date, nextShift);
        }
    }
});

// Set smart defaults for current and next shift based on time
function setShiftDefaults() {
    const now = new Date();
    const hours = now.getHours();
    const minutes = now.getMinutes();
    const totalMinutes = hours * 60 + minutes;
    
    const currentShiftSelect = document.getElementById('current_shift_type');
    const nextShiftSelect = document.getElementById('next_shift_type');
    
    let currentShift, nextShift;
    
    // Shift timings (IST): Morning: 6:30-15:30, Evening: 14:45-23:45, Night: 21:45-6:45
    if (totalMinutes >= 390 && totalMinutes < 930) { // 6:30 - 15:30
        currentShift = 'morning';
        nextShift = 'evening';
    } else if (totalMinutes >= 885 && totalMinutes < 1425) { // 14:45 - 23:45
        currentShift = 'evening';
        nextShift = 'night';
    } else { // Night shift
        currentShift = 'night';
        nextShift = 'morning';
    }
    
    // Set the values if not already set
    if (!currentShiftSelect.value) {
        currentShiftSelect.value = currentShift;
    }
    if (!nextShiftSelect.value) {
        nextShiftSelect.value = nextShift;
    }
}

// Update engineers when date or shift changes
function updateEngineers() {
    const date = document.getElementById('handover_date').value;
    const currentShift = document.getElementById('current_shift_type').value;
    const nextShift = document.getElementById('next_shift_type').value;
    
    if (date && currentShift) {
        fetchEngineers(date, currentShift, 'current_engineers');
    }
    if (date && nextShift) {
        fetchEngineers(date, nextShift, 'next_engineers');
        // Also update all next-engineers-select dropdowns in incidents
        updateIncidentEngineersDropdowns(date, nextShift);
    }
    
    // Update keypoint team member dropdowns (not dependent on shift)
    updateKeypointTeamMembersDropdowns();
}

// Function to update engineer dropdowns in incident sections
function updateIncidentEngineersDropdowns(date, shiftType) {
    const shiftMap = {
        'morning': 'Morning',
        'evening': 'Evening', 
        'night': 'Night'
    };
    
    const properShiftType = shiftMap[shiftType] || shiftType;
    
    fetch(`/api/get_engineers?date=${date}&shift_type=${properShiftType}`)
        .then(response => response.json())
        .then(data => {
            // Update all engineer dropdowns for incidents
            const engineerSelects = document.querySelectorAll('.next-engineers-select');
            
            engineerSelects.forEach(select => {
                // Store current value
                const currentValue = select.value;
                
                // Clear and populate options
                select.innerHTML = '<option value="">Select Next Shift Engineer</option>';
                
                if (data.engineers && data.engineers.length > 0) {
                    data.engineers.forEach(engineer => {
                        const option = document.createElement('option');
                        // Handle both old format (string) and new format (object)
                        if (typeof engineer === 'string') {
                            option.value = engineer;
                            option.textContent = engineer;
                        } else {
                            option.value = engineer.id;
                            option.textContent = engineer.name;
                        }
                        select.appendChild(option);
                    });
                    
                    // Restore previous selection if it still exists
                    const engineerValues = data.engineers.map(eng => typeof eng === 'string' ? eng : eng.id);
                    if (currentValue && engineerValues.includes(currentValue)) {
                        select.value = currentValue;
                    }
                } else {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'No engineers available';
                    option.disabled = true;
                    select.appendChild(option);
                }
            });
        })
        .catch(error => {
            console.error('Error fetching engineers for incidents:', error);
        });
}

// Function to update team member dropdowns in keypoint sections
function updateKeypointTeamMembersDropdowns() {
    // First check if dropdowns already have options from template
    const teamMemberSelects = document.querySelectorAll('.keypoint-team-member-dropdown');
    
    // Check if any dropdown already has team members loaded from template
    let hasTemplateData = false;
    teamMemberSelects.forEach(select => {
        if (select.options.length > 1) { // More than just the "Select Team Member" option
            hasTemplateData = true;
        }
    });
    
    // If template data exists, don't override it unless we get fresh API data
    if (hasTemplateData) {
        return;
    }
    
    fetch('/api/get_all_team_members')
        .then(response => response.json())
        .then(data => {
            teamMemberSelects.forEach(select => {
                // Store current value
                const currentValue = select.value;
                
                // Clear and populate options
                select.innerHTML = '<option value="">Select Team Member</option>';
                
                if (data.team_members && data.team_members.length > 0) {
                    data.team_members.forEach(member => {
                        const option = document.createElement('option');
                        option.value = member.id || member.name; // Use ID if available, fallback to name
                        option.textContent = member.name;
                        select.appendChild(option);
                    });
                    
                    // Restore previous selection if it still exists
                    if (currentValue && data.team_members.some(member => (member.id || member.name) === currentValue)) {
                        select.value = currentValue;
                    }
                } else {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'No team members available';
                    option.disabled = true;
                    select.appendChild(option);
                }
            });
        })
        .catch(error => {
            console.error('Error fetching team members for keypoints:', error);
        });
}

function fetchEngineers(date, shiftType, targetId) {
    // Map shift types to proper case
    const shiftMap = {
        'morning': 'Morning',
        'evening': 'Evening', 
        'night': 'Night'
    };
    
    const properShiftType = shiftMap[shiftType] || shiftType;
    
    // Determine if this is for current or next engineers
    const isCurrentShift = targetId === 'current_engineers';
    const displayListId = isCurrentShift ? 'current_engineers_list' : 'next_engineers_list';
    const hiddenInputId = targetId; // Keep the same ID for hidden input
    
    fetch(`/api/get_engineers?date=${date}&shift_type=${properShiftType}`)
        .then(response => response.json())
        .then(data => {
            const displayList = document.getElementById(displayListId);
            const hiddenInput = document.getElementById(hiddenInputId);
            
            if (data.engineers && data.engineers.length > 0) {
                // Display engineers as badges/chips
                const engineerBadges = data.engineers.map(engineer => {
                    // Handle both old format (string) and new format (object)
                    const engineerName = typeof engineer === 'string' ? engineer : engineer.name;
                    return `<span class="badge bg-primary me-2 mb-1">${engineerName}</span>`;
                }).join('');
                
                displayList.innerHTML = engineerBadges;
                
                // Store engineer names in hidden input (comma-separated)
                const engineerNames = data.engineers.map(engineer => 
                    typeof engineer === 'string' ? engineer : engineer.name
                );
                hiddenInput.value = engineerNames.join(', ');
            } else {
                displayList.innerHTML = '<span class="text-muted"><i class="fas fa-info-circle me-1"></i>No engineers scheduled for this shift</span>';
                hiddenInput.value = '';
            }
        })
        .catch(error => {
            console.error('Error fetching engineers:', error);
            const displayList = document.getElementById(displayListId);
            displayList.innerHTML = '<span class="text-danger"><i class="fas fa-exclamation-triangle me-1"></i>Error loading engineers</span>';
            document.getElementById(hiddenInputId).value = '';
        });
}

// Add event listeners when page loads
document.addEventListener('DOMContentLoaded', function() {
    const dateInput = document.getElementById('handover_date');
    const currentShiftSelect = document.getElementById('current_shift_type');
    const nextShiftSelect = document.getElementById('next_shift_type');
    
    // Set default date to today if not set
    if (!dateInput.value) {
        const today = new Date();
        const dateString = today.getFullYear() + '-' + 
                          String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                          String(today.getDate()).padStart(2, '0');
        dateInput.value = dateString;
    }
    
    // Set smart defaults for shifts based on current time
    setShiftDefaults();
    
    // Add event listeners for date and shift changes
    dateInput.addEventListener('change', updateEngineers);
    currentShiftSelect.addEventListener('change', updateEngineers);
    nextShiftSelect.addEventListener('change', updateEngineers);
    
    // Initial load to populate engineers
    updateEngineers();
});

function addIncident(type, incidentData = null) {
    let container, incidentHTML;
    
    switch(type) {
        case 'open':
            container = document.getElementById('open-incidents-container');
            incidentHTML = `
                <div class="incident-entry mb-3 border p-3 rounded">
                    <div class="row">
                        <div class="col-md-3">
                            <label class="form-label">Application Name</label>
                            <input type="text" class="form-control" name="open_incident_app[]" placeholder="Application Name">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Incident ID</label>
                            <input type="text" class="form-control" name="open_incident_id[]" placeholder="INC0001234">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Priority</label>
                            <select class="form-select" name="open_incident_priority[]">
                                <option value="Low">Low</option>
                                <option value="Medium">Medium</option>
                                <option value="High">High</option>
                                <option value="Critical">Critical</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Assigned To</label>
                            <select class="form-select next-engineers-select" name="open_incident_assigned[]">
                                <option value="">Select Next Shift Engineer</option>
                                <!-- Will be populated by JavaScript -->
                            </select>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-11">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" name="open_incident_description[]" rows="2" placeholder="Brief description of the open incident"></textarea>
                        </div>
                        <div class="col-1 d-flex align-items-end">
                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="this.closest('.incident-entry').remove()">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            break;
            
        case 'closed':
            container = document.getElementById('closed-incidents-container');
            incidentHTML = `
                <div class="incident-entry mb-3 border p-3 rounded">
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">Application Name</label>
                            <input type="text" class="form-control" name="closed_incident_app[]" placeholder="Application Name">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Incident ID</label>
                            <input type="text" class="form-control" name="closed_incident_id[]" placeholder="INC0001234">
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-11">
                            <label class="form-label">Resolution Summary</label>
                            <textarea class="form-control" name="closed_incident_resolution[]" rows="2" placeholder="Brief summary of how the incident was resolved"></textarea>
                        </div>
                        <div class="col-1 d-flex align-items-end">
                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="this.closest('.incident-entry').remove()">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            break;
            
        case 'priority':
            container = document.getElementById('priority-incidents-container');
            incidentHTML = `
                <div class="incident-entry mb-3 border p-3 rounded">
                    <div class="row">
                        <div class="col-md-3">
                            <label class="form-label">Application Name</label>
                            <input type="text" class="form-control" name="priority_incident_app[]" placeholder="Application Name">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Incident ID</label>
                            <input type="text" class="form-control" name="priority_incident_id[]" placeholder="INC0001234">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Priority Level</label>
                            <select class="form-select" name="priority_incident_level[]">
                                <option value="High">High</option>
                                <option value="Critical">Critical</option>
                                <option value="Emergency">Emergency</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Escalated To</label>
                            <input type="text" class="form-control" name="priority_incident_escalated[]" placeholder="Manager/Team">
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-11">
                            <label class="form-label">Impact & Actions Taken</label>
                            <textarea class="form-control" name="priority_incident_impact[]" rows="2" placeholder="Business impact and actions taken"></textarea>
                        </div>
                        <div class="col-1 d-flex align-items-end">
                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="this.closest('.incident-entry').remove()">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            break;
            
        case 'handover':
            container = document.getElementById('handover-incidents-container');
            incidentHTML = `
                <div class="incident-entry mb-3 border p-3 rounded">
                    <div class="row">
                        <div class="col-md-3">
                            <label class="form-label">Application Name</label>
                            <input type="text" class="form-control" name="handover_incident_app[]" placeholder="Application Name">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Incident ID</label>
                            <input type="text" class="form-control" name="handover_incident_id[]" placeholder="INC0001234">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Current Status</label>
                            <select class="form-select" name="handover_incident_status[]">
                                <option value="Monitoring">Monitoring</option>
                                <option value="Pending Vendor">Pending Vendor</option>
                                <option value="Pending Customer">Pending Customer</option>
                                <option value="In Progress">In Progress</option>
                                <option value="Waiting for Approval">Waiting for Approval</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Next Action By</label>
                            <select class="form-select next-engineers-select" name="handover_incident_next_by[]">
                                <option value="">Select Next Shift Engineer</option>
                                <!-- Will be populated by JavaScript -->
                            </select>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-11">
                            <label class="form-label">Handover Notes & Next Actions</label>
                            <textarea class="form-control" name="handover_incident_notes[]" rows="3" placeholder="Important notes for the next shift and specific actions to be taken"></textarea>
                        </div>
                        <div class="col-1 d-flex align-items-end">
                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="this.closest('.incident-entry').remove()">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            break;
            
        case 'escalated':
            container = document.getElementById('escalated-incidents-container');
            incidentHTML = `
                <div class="incident-entry mb-3 border p-3 rounded">
                    <div class="row">
                        <div class="col-md-4">
                            <label class="form-label">Application Name</label>
                            <input type="text" class="form-control" name="escalated_incident_app[]" placeholder="Application Name">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Incident ID</label>
                            <input type="text" class="form-control" name="escalated_incident_id[]" placeholder="INC0001234">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Escalated To</label>
                            <input type="text" class="form-control" name="escalated_incident_to[]" placeholder="Person/Team Name">
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-md-6">
                            <label class="form-label">Escalation Reason</label>
                            <textarea class="form-control" name="escalated_incident_reason[]" rows="2" placeholder="Why was this incident escalated?"></textarea>
                        </div>
                        <div class="col-md-5">
                            <label class="form-label">Current Status & Next Steps</label>
                            <textarea class="form-control" name="escalated_incident_status[]" rows="2" placeholder="Current status and expected next steps"></textarea>
                        </div>
                        <div class="col-md-1 d-flex align-items-end">
                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="this.closest('.incident-entry').remove()">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            break;
    }
    
    if (container && incidentHTML) {
        container.insertAdjacentHTML('beforeend', incidentHTML);
        
        // If incident data is provided, populate the newly created entry
        if (incidentData) {
            const newEntry = container.lastElementChild;
            populateIncidentEntry(newEntry, incidentData, type);
        }
        
        // Populate engineer dropdowns for the newly added incident
        const date = document.getElementById('handover_date').value;
        const nextShift = document.getElementById('next_shift_type').value;
        if (date && nextShift) {
            updateIncidentEngineersDropdowns(date, nextShift);
        }
    }
}

function populateIncidentEntry(entryElement, incident, type) {
    console.log('Populating entry with incident:', incident, 'Type:', type); // Debug log
    
    // Populate based on incident type
    if (type === 'open') {
        const appInput = entryElement.querySelector('input[name="open_incident_app[]"]');
        const idInput = entryElement.querySelector('input[name="open_incident_id[]"]');
        const prioritySelect = entryElement.querySelector('select[name="open_incident_priority[]"]');
        const descTextarea = entryElement.querySelector('textarea[name="open_incident_description[]"]');
        
        if (appInput) appInput.value = incident.assignment_group || 'ServiceNow';
        if (idInput) idInput.value = incident.number || '';
        if (prioritySelect) prioritySelect.value = incident.priority || 'Medium';
        if (descTextarea) descTextarea.value = incident.title || '';
        
    } else if (type === 'closed') {
        const appInput = entryElement.querySelector('input[name="closed_incident_app[]"]');
        const idInput = entryElement.querySelector('input[name="closed_incident_id[]"]');
        const resolutionTextarea = entryElement.querySelector('textarea[name="closed_incident_resolution[]"]');
        
        if (appInput) appInput.value = incident.assignment_group || 'ServiceNow';
        if (idInput) idInput.value = incident.number || '';
        if (resolutionTextarea) {
            const resolvedText = incident.resolved_at || incident.closed_at || 'Recently resolved';
            resolutionTextarea.value = `${incident.title} - Resolved: ${resolvedText}`;
        }
        
    } else if (type === 'priority') {
        const appInput = entryElement.querySelector('input[name="priority_incident_app[]"]');
        const idInput = entryElement.querySelector('input[name="priority_incident_id[]"]');
        const levelSelect = entryElement.querySelector('select[name="priority_incident_level[]"]');
        const descTextarea = entryElement.querySelector('textarea[name="priority_incident_impact[]"]');
        
        if (appInput) appInput.value = incident.assignment_group || 'ServiceNow';
        if (idInput) idInput.value = incident.number || '';
        if (levelSelect) levelSelect.value = incident.priority || 'High';
        if (descTextarea) descTextarea.value = incident.title || '';
    }
}

function addKeyPoint() {
    const container = document.getElementById('keypoints-container');
    const keypointHTML = `
        <div class="keypoint-entry mb-3 border p-3 rounded">
            <div class="row">
                <div class="col-md-5">
                    <label class="form-label">Key Point Details</label>
                    <textarea class="form-control" name="keypoint_description[]" style="height: 38px; resize: vertical; min-height: 38px;" placeholder="Describe the key point details"></textarea>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Assigned To</label>
                    <select class="form-control keypoint-team-member-dropdown" name="keypoint_assigned_to[]">
                        <option value="">Select Team Member</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Status</label>
                    <select class="form-control" name="keypoint_status[]">
                        <option value="Open" selected>Open</option>
                        <option value="In Progress">In Progress</option>
                        <option value="Closed">Closed</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">JIRA ID <span class="text-muted">(Optional)</span></label>
                    <input type="text" class="form-control" name="keypoint_jira_id[]" placeholder="JIRA-123">
                </div>
                <div class="col-md-1 d-flex align-items-end">
                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="this.closest('.keypoint-entry').remove()">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    `;
    container.insertAdjacentHTML('beforeend', keypointHTML);
    
    // Populate team member dropdowns for the newly added keypoint
    const newDropdown = container.lastElementChild.querySelector('.keypoint-team-member-dropdown');
    if (newDropdown) {
        fetch('/api/get_all_team_members')
            .then(response => response.json())
            .then(data => {
                newDropdown.innerHTML = '<option value="">Select Team Member</option>';
                
                if (data.team_members && data.team_members.length > 0) {
                    data.team_members.forEach(member => {
                        const option = document.createElement('option');
                        option.value = member.name;
                        option.textContent = member.name;
                        newDropdown.appendChild(option);
                    });
                }
            })
            .catch(error => {
                console.error('Error populating new keypoint dropdown:', error);
            });
    }
}

// ServiceNow Incident Auto-Population
function fetchServiceNowIncidents() {
    const shiftType = document.getElementById('current_shift_type').value;
    const handoverDate = document.getElementById('handover_date').value;
    
    if (!shiftType || !handoverDate) {
        return; // Need both values to fetch incidents
    }
    
    // Show loading indicator
    showServiceNowLoading(true);
    
    fetch(`/api/get_servicenow_incidents?shift_type=${shiftType}&date=${handoverDate}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                populateServiceNowIncidents(data.incidents, data.summary);
                // Success notification removed for cleaner UI
            } else {
                showServiceNowNotification('warning', `⚠️ ServiceNow: ${data.error}`);
            }
        })
        .catch(error => {
            console.error('Error fetching ServiceNow incidents:', error);
            showServiceNowNotification('error', '❌ Error connecting to ServiceNow');
        })
        .finally(() => {
            showServiceNowLoading(false);
        });
}

function populateServiceNowIncidents(incidents, summary) {
    // Populate Open Incidents
    populateIncidentSection('open', incidents.open_incidents);
    
    // Populate Closed Incidents  
    populateIncidentSection('closed', incidents.closed_incidents);
    
    // Populate Priority Incidents
    populateIncidentSection('priority', incidents.priority_incidents);
    
    // Update summary display
    updateIncidentSummary(summary);
}

function populateIncidentSection(type, incidents) {
    const containerId = `${type}-incidents-container`;
    const container = document.getElementById(containerId);
    
    if (!container) {
        console.log('Container not found:', containerId);
        return;
    }
    
    console.log(`Populating ${type} incidents:`, incidents.length, 'incidents');
    
    // Clear existing entries except the first template
    const entries = container.querySelectorAll('.incident-entry');
    for (let i = 1; i < entries.length; i++) {
        entries[i].remove();
    }
    
    if (incidents.length === 0) {
        console.log('No incidents to populate');
        return;
    }
    
    // Populate with ServiceNow incidents
    incidents.forEach((incident, index) => {
        console.log(`Processing incident ${index + 1}:`, incident);
        if (index === 0) {
            // Use the first existing entry
            populateFirstIncidentEntry(container, incident, type);
        } else {
            // Add new entries with data
            addIncident(type, incident);
        }
    });
}

function populateFirstIncidentEntry(container, incident, type) {
    const firstEntry = container.querySelector('.incident-entry');
    if (!firstEntry) return;
    
    console.log('Populating incident:', incident, 'Type:', type); // Debug log
    
    // Populate based on incident type
    if (type === 'open') {
        const appInput = firstEntry.querySelector('input[name="open_incident_app[]"]');
        const idInput = firstEntry.querySelector('input[name="open_incident_id[]"]');
        const prioritySelect = firstEntry.querySelector('select[name="open_incident_priority[]"]');
        const descTextarea = firstEntry.querySelector('textarea[name="open_incident_description[]"]');
        
        if (appInput) {
            appInput.value = incident.assignment_group || 'ServiceNow';
            console.log('Set app:', appInput.value);
        }
        if (idInput) {
            idInput.value = incident.number || '';
            console.log('Set ID:', idInput.value);
        }
        if (prioritySelect) {
            prioritySelect.value = incident.priority || 'Medium';
            console.log('Set priority:', prioritySelect.value);
        }
        if (descTextarea) {
            descTextarea.value = incident.title || '';
            console.log('Set description:', descTextarea.value);
        }
        
    } else if (type === 'closed') {
        const appInput = firstEntry.querySelector('input[name="closed_incident_app[]"]');
        const idInput = firstEntry.querySelector('input[name="closed_incident_id[]"]');
        const resolutionTextarea = firstEntry.querySelector('textarea[name="closed_incident_resolution[]"]');
        
        if (appInput) appInput.value = incident.assignment_group || 'ServiceNow';
        if (idInput) idInput.value = incident.number || '';
        if (resolutionTextarea) {
            const resolvedText = incident.resolved_at || incident.closed_at || 'Recently resolved';
            resolutionTextarea.value = `${incident.title} - Resolved: ${resolvedText}`;
        }
        
    } else if (type === 'priority') {
        const appInput = firstEntry.querySelector('input[name="priority_incident_app[]"]');
        const idInput = firstEntry.querySelector('input[name="priority_incident_id[]"]');
        const levelSelect = firstEntry.querySelector('select[name="priority_incident_level[]"]');
        const descTextarea = firstEntry.querySelector('textarea[name="priority_incident_description[]"]');
        
        if (appInput) appInput.value = incident.assignment_group || 'ServiceNow';
        if (idInput) idInput.value = incident.number || '';
        if (levelSelect) levelSelect.value = incident.priority || 'High';
        if (descTextarea) descTextarea.value = incident.title || '';
    }
}

function showServiceNowLoading(show) {
    let loader = document.getElementById('servicenow-loader');
    if (show && !loader) {
        loader = document.createElement('div');
        loader.id = 'servicenow-loader';
        loader.className = 'alert alert-info';
        loader.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Fetching incidents from ServiceNow...';
        document.querySelector('.card-body').insertBefore(loader, document.querySelector('.card-body').firstChild);
    } else if (!show && loader) {
        loader.remove();
    }
}

function showServiceNowNotification(type, message) {
    let notification = document.getElementById('servicenow-notification');
    if (notification) {
        notification.remove();
    }
    
    const alertClass = type === 'success' ? 'alert-success' : type === 'warning' ? 'alert-warning' : 'alert-danger';
    
    notification = document.createElement('div');
    notification.id = 'servicenow-notification';
    notification.className = `alert ${alertClass} alert-dismissible fade show`;
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.querySelector('.card-body').insertBefore(notification, document.querySelector('.card-body').firstChild);
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        if (notification) {
            notification.remove();
        }
    }, 5000);
}

function updateIncidentSummary(summary) {
    // ServiceNow summary badge display removed for cleaner UI
    // The function is kept to avoid breaking any calls but no longer displays status
}

// Auto-fetch ServiceNow incidents when shift or date changes (removed for cleaner UI)
document.addEventListener('DOMContentLoaded', function() {
    const shiftSelect = document.getElementById('current_shift_type');
    const dateInput = document.getElementById('handover_date');
    
    if (shiftSelect && dateInput) {
        // Auto-fetch incidents silently in background when values change
        shiftSelect.addEventListener('change', fetchServiceNowIncidents);
        dateInput.addEventListener('change', fetchServiceNowIncidents);
        
        // Auto-fetch on page load if values are present
        if (shiftSelect.value && dateInput.value) {
            setTimeout(fetchServiceNowIncidents, 1000); // Delay to ensure page is fully loaded
        }
    }
});
</script>
{% endblock %}